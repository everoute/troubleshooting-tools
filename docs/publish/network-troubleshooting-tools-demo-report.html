
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>eBPF ç½‘ç»œæ•…éšœæ’æŸ¥å·¥å…·é›†ä»‹ç»</title>
        <style>
            @media print {
                @page {
                    size: A4;
                    margin: 2cm;
                }

                body {
                    font-size: 10pt;
                }

                h1 {
                    page-break-before: always;
                }

                h1:first-of-type {
                    page-break-before: avoid;
                }

                h1, h2, h3, h4 {
                    page-break-after: avoid;
                }

                pre, table, blockquote {
                    page-break-inside: avoid;
                }
            }

            body {
                font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei",
                             "WenQuanYi Micro Hei", Arial, sans-serif;
                font-size: 14px;
                line-height: 1.8;
                color: #333;
                max-width: 900px;
                margin: 0 auto;
                padding: 40px 20px;
                background-color: #fff;
            }

            h1 {
                color: #277884;
                font-size: 32px;
                font-weight: bold;
                margin-top: 40px;
                margin-bottom: 20px;
                border-bottom: 4px solid #277884;
                padding-bottom: 10px;
            }

            h1:first-of-type {
                margin-top: 0;
                border-bottom: none;
                text-align: center;
                font-size: 36px;
                color: #277884;
            }

            h2 {
                color: #277884;
                font-size: 24px;
                font-weight: bold;
                margin-top: 30px;
                margin-bottom: 15px;
                border-left: 5px solid #5EA8A7;
                padding-left: 15px;
            }

            h3 {
                color: #2C2C2C;
                font-size: 20px;
                font-weight: bold;
                margin-top: 25px;
                margin-bottom: 12px;
            }

            h4 {
                color: #2C2C2C;
                font-size: 16px;
                font-weight: bold;
                margin-top: 20px;
                margin-bottom: 10px;
            }

            p {
                margin: 10px 0;
                text-align: justify;
            }

            ul, ol {
                margin: 15px 0;
                padding-left: 40px;
            }

            li {
                margin: 8px 0;
            }

            code {
                background-color: #F5F5F5;
                padding: 3px 6px;
                border-radius: 3px;
                font-family: "Consolas", "Monaco", "Courier New", monospace;
                font-size: 13px;
                color: #E74C3C;
            }

            pre {
                background-color: #F5F5F5;
                border-left: 5px solid #5EA8A7;
                padding: 15px;
                margin: 20px 0;
                overflow-x: auto;
                border-radius: 4px;
            }

            pre code {
                background-color: transparent;
                padding: 0;
                color: #2C2C2C;
                font-size: 13px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
                font-size: 13px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            th {
                background-color: #277884;
                color: white;
                padding: 12px;
                text-align: left;
                font-weight: bold;
                border: 1px solid #CCCCCC;
            }

            td {
                padding: 10px 12px;
                border: 1px solid #CCCCCC;
            }

            tr:nth-child(even) {
                background-color: #F9F9F9;
            }

            tr:hover {
                background-color: #F0F0F0;
            }

            blockquote {
                border-left: 5px solid #FE4447;
                margin: 20px 0;
                padding: 10px 20px;
                background-color: #FFF3F3;
                font-style: italic;
            }

            hr {
                border: none;
                border-top: 2px solid #E0E0E0;
                margin: 30px 0;
            }

            strong {
                color: #277884;
                font-weight: bold;
            }

            em {
                color: #FE4447;
                font-style: italic;
            }

            a {
                color: #5EA8A7;
                text-decoration: none;
                border-bottom: 1px dotted #5EA8A7;
            }

            a:hover {
                color: #277884;
                border-bottom: 1px solid #277884;
            }

            /* Table of contents */
            #toc {
                background-color: #F8F9FA;
                border: 2px solid #277884;
                border-radius: 5px;
                padding: 20px;
                margin: 30px 0;
            }

            #toc ul {
                list-style-type: none;
                padding-left: 20px;
            }

            #toc li {
                margin: 5px 0;
            }

            #toc a {
                color: #277884;
                border-bottom: none;
            }

            /* Print-friendly */
            @media print {
                body {
                    max-width: 100%;
                    padding: 0;
                }

                a {
                    color: #277884;
                    text-decoration: none;
                    border-bottom: none;
                }
            }
        </style>
    </head>
    <body>
        <p>eBPF ç½‘ç»œæ•…éšœæ’æŸ¥å·¥å…·é›†ä»‹ç»</p>

<hr />

<h2 id="ç›®å½•">ç›®å½•</h2>

<ol>
<li><a href="#1-èƒŒæ™¯ä¸è®¾è®¡è€ƒé‡">èƒŒæ™¯ä¸è®¾è®¡è€ƒé‡</a></li>
<li><a href="#2-é¡¹ç›®-overview">é¡¹ç›® Overview</a></li>
<li><a href="#3-åˆ†ææ–¹æ³•è®º">åˆ†ææ–¹æ³•è®º</a></li>
<li><a href="#4-å®æˆ˜åº”ç”¨">å®æˆ˜åº”ç”¨</a></li>
<li><a href="#5-æ€§èƒ½æµ‹è¯•æ•°æ®">æ€§èƒ½æµ‹è¯•æ•°æ®</a></li>
<li><a href="#6-demo-æ¼”ç¤º">Demo æ¼”ç¤º</a></li>
<li><a href="#7-ç»“è®º">ç»“è®º</a></li>
</ol>

<hr />

<h2 id="1-èƒŒæ™¯ä¸è®¾è®¡è€ƒé‡">1. èƒŒæ™¯ä¸è®¾è®¡è€ƒé‡</h2>

<h3 id="11-é—®é¢˜èƒŒæ™¯">1.1 é—®é¢˜èƒŒæ™¯</h3>

<p>è™šæ‹ŸåŒ–ç¯å¢ƒçš„ç½‘ç»œæ¶æ„å¤æ‚åº¦ç»™æ•…éšœå®šä½å¸¦æ¥äº†å·¨å¤§æŒ‘æˆ˜ã€‚æ•°æ®åŒ…ä» VM åˆ°ç‰©ç†ç½‘å¡éœ€è¦ç»è¿‡å¤šä¸ªå±‚æ¬¡ï¼š</p>

<ul>
<li>VM åº”ç”¨å±‚ â†’ VM å†…æ ¸åè®®æ ˆ â†’ Virtio-net é©±åŠ¨</li>
<li>Vhost é˜Ÿåˆ— â†’ TUN/TAP è®¾å¤‡ â†’ OVS Bridge</li>
<li>ç‰©ç†ç½‘å¡é˜Ÿåˆ— â†’ ç‰©ç†ç½‘å¡ NIC Driver â†’ ç‰©ç†ç½‘ç»œ</li>
</ul>

<p><strong>æ ¸å¿ƒç—›ç‚¹</strong>:</p>

<ol>
<li><strong>ç»„ä»¶ä¼—å¤š</strong>: ä» VM åˆ°ç‰©ç†ç½‘å¡æ¶‰åŠ 10+ å±‚è½¯ä»¶ç»„ä»¶</li>
<li><strong>è·¯å¾„å¤æ‚</strong>: TX/RX åŒå‘è·¯å¾„ã€å¿«é€Ÿè·¯å¾„(fastpath)/æ…¢é€Ÿè·¯å¾„(slowpath)</li>
<li><strong>æ•…éšœå¤šæ ·</strong>: ä¸¢åŒ…ã€å»¶è¿Ÿã€æŠ–åŠ¨ã€ååé‡ä¸‹é™,åŸå› éš¾ä»¥å®šä½</li>
<li><strong>é‡åŒ–å›°éš¾</strong>: ä¼ ç»Ÿç›‘æ§å·¥å…·åªèƒ½çœ‹åˆ°å®è§‚æŒ‡æ ‡,æ— æ³•ç²¾ç¡®æµ‹é‡æ¯ä¸ªé˜¶æ®µçš„è€—æ—¶</li>
</ol>

<p><strong>å…¸å‹æ•…éšœåœºæ™¯å®ä¾‹</strong>:</p>

<ul>
<li><strong>åœºæ™¯ 1</strong>: VM ç½‘ç»œå¶å‘ä¸¢åŒ… (0.1%),æ˜¯ç½‘å¡ä¸¢åŒ…è¿˜æ˜¯ OVS ä¸¢åŒ…ï¼Ÿä¸¢åœ¨å“ªä¸ªé˜¶æ®µï¼Ÿ</li>
<li><strong>åœºæ™¯ 2</strong>: ICMP å»¶è¿Ÿçªå¢è‡³ 200ms+,ç›‘æ§ç³»ç»ŸæŠ¥å‘Š"ä¸¢åŒ…",ä½†çœŸçš„æ˜¯ä¸¢åŒ…å—ï¼Ÿ</li>
<li><strong>åœºæ™¯ 3</strong>: OVS CPU å¹³å‡åˆ©ç”¨ç‡ 15%,ä½†ä¸šåŠ¡æŠ¥å‘Šå‘¨æœŸæ€§ç½‘ç»œé‡ä¼ /é«˜å»¶è¿ŸæŠ–åŠ¨,ä¸ºä»€ä¹ˆï¼Ÿ</li>
</ul>

<h3 id="12-è®¾è®¡ç›®æ ‡ä¸åŸåˆ™">1.2 è®¾è®¡ç›®æ ‡ä¸åŸåˆ™</h3>

<p>é’ˆå¯¹ä¸Šè¿°ç—›ç‚¹,æœ¬å·¥å…·é›†çš„è®¾è®¡éµå¾ªä»¥ä¸‹æ ¸å¿ƒç›®æ ‡:</p>

<h4 id="ç›®æ ‡-1-ç®€å•æ˜“ç”¨">ç›®æ ‡ 1: ç®€å•æ˜“ç”¨</h4>

<ul>
<li><strong>å•å·¥å…·å•èŒè´£</strong>: æ¯ä¸ªå·¥å…·èšç„¦ç‰¹å®šé—®é¢˜åŸŸ(ä¸¢åŒ…/å»¶è¿Ÿ/OVS/è™šæ‹ŸåŒ–)</li>
<li><strong>å¼€ç®±å³ç”¨</strong>: å‚æ•°è®¾è®¡ç›´è§‚,æ”¯æŒ IP/ç«¯å£/åè®®è¿‡æ»¤</li>
<li><strong>è¾“å‡ºæ¸…æ™°</strong>: Histogram ç»Ÿè®¡ + è¯¦ç»†äº‹ä»¶,æ»¡è¶³ä¸åŒè¯Šæ–­é˜¶æ®µéœ€æ±‚</li>
</ul>

<p><strong>ç¤ºä¾‹å¯¹æ¯”</strong>:</p>

<pre><code># ä¼ ç»Ÿæ–¹å¼: éœ€è¦ç»„åˆå¤šä¸ªå·¥å…· + æ‰‹åŠ¨å…³è”
tcpdump -i vnet0 | tee log1.txt  # æŠ“åŒ…
perf record -e skb:kfree_skb     # ä¸¢åŒ…äº‹ä»¶
bpftrace -e 'kprobe:ovs_dp_process_packet {...}' # OVS è·Ÿè¸ª
# ç„¶åæ‰‹åŠ¨åˆ†ææ—¥å¿—,æ—¶é—´æˆ³å…³è”...

# æœ¬å·¥å…·é›†: ä¸€é”®è·å–ç»“æ„åŒ–æ•°æ®
sudo python3 kernel_drop_stack_stats_summary_all.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 --l4-protocol tcp --interval 60
</code></pre>

<h4 id="ç›®æ ‡-2-è½»é‡å¯æ§">ç›®æ ‡ 2: è½»é‡å¯æ§</h4>

<p>åŸºäº eBPF ç¨‹åºæ€§èƒ½å¼€é”€æ¨¡å‹,ä¸¥æ ¼æ§åˆ¶å·¥å…·çš„æ€§èƒ½å½±å“ã€‚eBPF ç¨‹åºå¼€é”€ä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆ:</p>

<p><strong>eBPF ç¨‹åºæ€§èƒ½å¼€é”€æ„æˆ</strong>:</p>

<ol>
<li><p><strong>è¿›å…¥ Probe å¼€é”€ (å›ºå®š)</strong>:</p>

<ul>
<li>tracepoint: 15-30 ns (æ¨è,é’ˆå¯¹ openEuler 4.19.90)</li>
<li>kprobe: 30-50 ns (é€šç”¨)</li>
<li>fentry/fexit: 5-15 ns (éœ€å†…æ ¸ 5.5+,ä¸é€‚ç”¨äº 4.19)</li>
</ul></li>
<li><p><strong>æ‰§è¡Œå¼€é”€ (å¯æ§)</strong>:</p>

<ul>
<li>åŸºæœ¬æŒ‡ä»¤: 1-3 ns/æŒ‡ä»¤ (JIT ç¼–è¯‘)</li>
<li>Map æŸ¥æ‰¾: 20-100 ns (ARRAY &lt; HASH)</li>
<li>æ—¶é—´æˆ³è·å–: 10-30 ns</li>
<li>æ ˆè·Ÿè¸ª: 500-2000 ns (é«˜å¼€é”€!)</li>
</ul></li>
<li><p><strong>äº‹ä»¶æäº¤å¼€é”€ (æœ€å¤§ç“¶é¢ˆ)</strong>:</p>

<ul>
<li>perf_buffer: 500-1000 ns/event</li>
<li>ringbuffer: 200-500 ns/event (å†…æ ¸ 5.8+,ä¸é€‚ç”¨äº 4.19)</li>
</ul></li>
</ol>

<p><strong>å…³é”®ç»“è®º</strong>:</p>

<ul>
<li>æ¯åŒ…æäº¤äº‹ä»¶ â†’ 1M PPS Ã— 500ns = 50% CPU (ä¸å¯æ¥å—!)</li>
<li>å†…æ ¸ä¾§èšåˆ â†’ ä»…æäº¤ç»Ÿè®¡ = &lt;1% CPU (Summary å·¥å…·ç­–ç•¥)</li>
<li>è¿‡æ»¤ + é‡‡æ · â†’ 100 PPS Ã— 500ns = 0.005% CPU (Details ç­–ç•¥)</li>
</ul>

<p><strong>å·¥å…·è®¾è®¡ç­–ç•¥</strong>:</p>

<table>
<thead>
<tr>
  <th>å·¥å…·ç±»å‹</th>
  <th>Probe ç‚¹æ•°é‡</th>
  <th>æ•°æ®é‡æ§åˆ¶</th>
  <th>æ€§èƒ½å¼€é”€ç‰¹å¾</th>
  <th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>Summary</strong></td>
  <td>3-8 ä¸ªå…³é”®ç‚¹</td>
  <td>Histogram èšåˆ</td>
  <td>æä½</td>
  <td>é•¿æœŸç›‘æ§ã€åŸºçº¿å»ºç«‹</td>
</tr>
<tr>
  <td><strong>Details</strong></td>
  <td>10-20 ä¸ªè¯¦ç»†ç‚¹</td>
  <td>è¿‡æ»¤å™¨æ§åˆ¶æäº¤é‡</td>
  <td>å¯è°ƒèŠ‚</td>
  <td>çŸ­æœŸæŠ“åŒ…ã€é—®é¢˜å¤ç°</td>
</tr>
<tr>
  <td><strong>ä¸“é¡¹å·¥å…·</strong></td>
  <td>é’ˆå¯¹æ€§ probe</td>
  <td>ç‰¹å®šåœºæ™¯åˆ†æ</td>
  <td>å¯è°ƒèŠ‚</td>
  <td>æ ¹å› å®šä½</td>
</tr>
</tbody>
</table>

<h4 id="ç›®æ ‡-3-å¯¹ä¸šåŠ¡æ€§èƒ½å½±å“å¯æ§">ç›®æ ‡ 3: å¯¹ä¸šåŠ¡æ€§èƒ½å½±å“å¯æ§</h4>

<p>é€šè¿‡ä¸‰å±‚é€’è¿›å¼è¯Šæ–­æ¨¡å‹å’Œçµæ´»çš„è¿‡æ»¤æœºåˆ¶,ç¡®ä¿åœ¨ä¸åŒé˜¶æ®µä½¿ç”¨åˆé€‚ç²’åº¦çš„å·¥å…·:</p>

<p><strong>Summary ç±»å·¥å…·</strong>:</p>

<ul>
<li>é¢„æœŸæ€§èƒ½å½±å“åŠèµ„æºå¼€é”€æå°</li>
<li>é€šè¿‡å†…æ ¸ä¾§èšåˆé¿å…é¢‘ç¹äº‹ä»¶æäº¤</li>
<li>é€‚åˆé•¿æœŸè¿è¡Œå’ŒæŒç»­ç›‘æ§</li>
</ul>

<p><strong>Details ç±»å·¥å…·</strong>:</p>

<ul>
<li>åœ¨æœ€åæƒ…å†µä¸‹(å¤§æµé‡ä¸”æ‰€æœ‰åŒ…éƒ½æ‰§è¡Œå®Œæ•´é€»è¾‘å¹¶æäº¤ç”¨æˆ·æ€)æ€§èƒ½å¼€é”€å·¨å¤§</li>
<li>é€šè¿‡å¤šçº§è¿‡æ»¤æœºåˆ¶ä½¿ç»å¤§å¤šæ•°æ•°æ®åŒ…åœ¨æµ‹é‡é€»è¾‘ä¸­æå‰è¿”å›</li>
<li>å‡å°‘ submit é¢‘ç‡,é™ä½ç”¨æˆ·æ€ç¨‹åºå¼€é”€</li>
<li>å…·ä½“èµ„æºå ç”¨å¯é€šè¿‡è¿‡æ»¤æ¡ä»¶çµæ´»è°ƒèŠ‚</li>
</ul>

<p><strong>è¿‡æ»¤æœºåˆ¶åŸç†</strong>:</p>

<p>Details å·¥å…·é€šè¿‡å†…æ ¸æ€å¤šçº§è¿‡æ»¤é¿å…æ— æ•ˆæ•°æ®ä¼ è¾“å’Œå¤„ç†:</p>

<pre><code>// 1. åè®®è¿‡æ»¤ (æœ€æ—©,å¼€é”€æœ€å°)
if (skb-&gt;protocol != ETH_P_IP) return 0;

// 2. IP è¿‡æ»¤
if (sip != SRC_IP_FILTER) return 0;

// 3. ç«¯å£è¿‡æ»¤
if (dport != DST_PORT_FILTER) return 0;

// 4. é˜ˆå€¼è¿‡æ»¤ (å»¶è¿Ÿå·¥å…·)
if (latency &lt; LATENCY_THRESHOLD_NS) return 0;

// åªæœ‰é€šè¿‡æ‰€æœ‰è¿‡æ»¤å™¨,æ‰æäº¤äº‹ä»¶
events.perf_submit(ctx, &amp;evt, sizeof(evt));
</code></pre>

<p><strong>ä¸“é¡¹å·¥å…·</strong>:</p>

<ul>
<li>èµ„æºå ç”¨è§†ä½¿ç”¨èŒƒå›´å’Œåœºæ™¯éå¸¸å…·ä½“</li>
<li>ä¾‹å¦‚å®šä½åˆ° OVS è¿›ç¨‹é—®é¢˜å,ä½¿ç”¨ä¸“é¡¹å·¥å…·æµ‹é‡ OVS çº¿ç¨‹è¡Œä¸º</li>
<li>æˆ–å®šä½åˆ° kernel tc é—®é¢˜å,ä½¿ç”¨ tc æ¨¡å—çš„ä¸“é¡¹æµ‹é‡å·¥å…·</li>
</ul>

<p><strong>å¤šé˜¶æ®µæ•´åˆæäº¤</strong>:</p>

<p>system_network_performance å’Œ vm_network_performance ç­‰å·¥å…·é‡‡ç”¨å¤šé˜¶æ®µæ•´åˆç­–ç•¥:</p>

<ul>
<li>ä¸€ä¸ªæ•°æ®åŒ…åœ¨å¤šä¸ª probe ç‚¹æ”¶é›†ä¿¡æ¯</li>
<li>é€šè¿‡ skb æŒ‡é’ˆå…³è”ä¸åŒé˜¶æ®µçš„æ—¶é—´æˆ³</li>
<li>æœ€ç»ˆä»…æäº¤ä¸€æ¬¡æ•´åˆåçš„äº‹ä»¶</li>
<li>é…åˆè¿‡æ»¤æ¡ä»¶/é˜ˆå€¼è¿›ä¸€æ­¥å‡å°‘æäº¤é¢‘ç‡</li>
</ul>

<h4 id="ç›®æ ‡-4-æ¨¡å—åŒ–ä¸å¯ç»„åˆæ€§">ç›®æ ‡ 4: æ¨¡å—åŒ–ä¸å¯ç»„åˆæ€§</h4>

<p><strong>åˆ†å±‚æ¸…æ™°çš„å·¥å…·åˆ†ç±»</strong>:</p>

<pre><code>ebpf-tools/
â”œâ”€â”€ performance/                    # æ€§èƒ½æµ‹é‡
â”‚   â”œâ”€â”€ system-network/             # ç³»ç»Ÿç½‘ç»œè·¯å¾„
â”‚   â”‚   â”œâ”€â”€ *_summary.py            # Summary ç‰ˆæœ¬
â”‚   â”‚   â””â”€â”€ *_details.py            # Details ç‰ˆæœ¬
â”‚   â””â”€â”€ vm-network/                 # VM ç½‘ç»œè·¯å¾„
â”‚       â”œâ”€â”€ *_summary.py
â”‚       â””â”€â”€ *_details.py
â”œâ”€â”€ linux-network-stack/            # Linux åè®®æ ˆ
â”‚   â””â”€â”€ packet-drop/                # ä¸¢åŒ…åˆ†æ
â”‚       â”œâ”€â”€ kernel_drop_stats_summary_all.py  # Summary
â”‚       â””â”€â”€ eth_drop.py             # Details
â”œâ”€â”€ ovs/                            # Open vSwitch
â”‚   â”œâ”€â”€ ovs_upcall_latency_summary.py
â”‚   â””â”€â”€ ovs_userspace_megaflow.py
â”œâ”€â”€ kvm-virt-network/               # KVM è™šæ‹ŸåŒ–
â”‚   â”œâ”€â”€ vhost-net/                  # vhost å†…æ ¸åŠ é€Ÿ
â”‚   â”œâ”€â”€ virtio-net/                 # virtio é©±åŠ¨
â”‚   â”œâ”€â”€ tun/                        # TUN/TAP è®¾å¤‡
â”‚   â””â”€â”€ kvm/                        # KVM ç›¸å…³é€»è¾‘
â””â”€â”€ cpu/                            # CPU åˆ†æ
    â”œâ”€â”€ offcputime-ts.py            # Off-CPU æ—¶é—´
    â””â”€â”€ pthread_rwlock_wrlock.bt    # é”åˆ†æ
</code></pre>

<hr />

<h2 id="2-é¡¹ç›®-overview">2. é¡¹ç›® Overview</h2>

<h3 id="21-å·¥å…·å…¨æ™¯å›¾">2.1 å·¥å…·å…¨æ™¯å›¾</h3>

<p>æœ¬é¡¹ç›®æä¾› <strong>30+ eBPF å·¥å…·</strong>,è¦†ç›–è™šæ‹ŸåŒ–ç½‘ç»œçš„ <strong>å…¨é“¾è·¯ç›‘æ§</strong>:</p>

<p><strong>å·¥å…·è¦†ç›–èŒƒå›´ (æŒ‰ç½‘ç»œå±‚æ¬¡)</strong>:</p>

<ul>
<li><strong>VM å±‚</strong>: virtio-net/ (4 å·¥å…·) - NAPI è½®è¯¢ã€RX è·¯å¾„è·Ÿè¸ª</li>
<li><strong>vhost å±‚</strong>: vhost-net/ (5 å·¥å…·) - äº‹ä»¶é€šçŸ¥ã€é˜Ÿåˆ—å…³è”ã€çº¿ç¨‹å”¤é†’</li>
<li><strong>TUN/TAP å±‚</strong>: tun/ (3 å·¥å…·) - ç¯å½¢ç¼“å†²åŒºç›‘æ§ã€GSO ç±»å‹æ£€æµ‹</li>
<li><strong>OVS å±‚</strong>: ovs/ (6 å·¥å…·) - Upcall å»¶è¿Ÿã€Megaflow è·Ÿè¸ªã€ä¸¢åŒ…åˆ†æ</li>
<li><strong>Linux ç½‘ç»œæ ˆ</strong>: linux-network-stack/ (8 å·¥å…·) - ä¸¢åŒ…æ ˆç»Ÿè®¡ã€é˜Ÿåˆ—è·Ÿè¸ª</li>
<li><strong>æ€§èƒ½æµ‹é‡</strong>:
<ul>
<li>system-network/ (4 å·¥å…·) - ç³»ç»Ÿç½‘ç»œå»¶è¿Ÿä¸æ€§èƒ½æŒ‡æ ‡</li>
<li>vm-network/ (4 å·¥å…·) - VM ç½‘ç»œå»¶è¿Ÿåˆ†æ</li>
</ul></li>
<li><strong>CPU/è°ƒåº¦åˆ†æ</strong>: cpu/ (5 å·¥å…·) - Off-CPU åˆ†æã€é”ç›‘æ§</li>
</ul>

<h3 id="22-æ ¸å¿ƒå·¥å…·çŸ©é˜µ">2.2 æ ¸å¿ƒå·¥å…·çŸ©é˜µ</h3>

<p>æŒ‰é—®é¢˜ç±»å‹åˆ†ç±»:</p>

<table>
<thead>
<tr>
  <th>é—®é¢˜ç±»å‹</th>
  <th>Summary å·¥å…·</th>
  <th>Details å·¥å…·</th>
  <th>è¦†ç›–é—®é¢˜</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>ä¸¢åŒ…</strong></td>
  <td>kernel_drop_stack_stats_summary_all.py</td>
  <td>eth_drop.py</td>
  <td>å†…æ ¸ä¸¢åŒ…ä½ç½®ã€ä¸¢åŒ…åŸå› åˆ†æã€äº”å…ƒç»„å…³è”</td>
</tr>
<tr>
  <td><strong>å»¶è¿Ÿ</strong></td>
  <td>system/vm_network_latency_summary.py</td>
  <td>system/vm_network_latency_details.py</td>
  <td>åˆ†æ®µå»¶è¿Ÿæµ‹é‡ã€é•¿å°¾å»¶è¿Ÿè¯†åˆ«ã€ç“¶é¢ˆå®šä½</td>
</tr>
<tr>
  <td><strong>OVS æ€§èƒ½</strong></td>
  <td>ovs_upcall_latency_summary.py</td>
  <td>ovs_userspace_megaflow.py</td>
  <td>Upcall å»¶è¿Ÿã€æµè¡¨æœªå‘½ä¸­ã€Megaflow ç”Ÿå‘½å‘¨æœŸ</td>
</tr>
<tr>
  <td><strong>è™šæ‹ŸåŒ–</strong></td>
  <td>vhost_eventfd_count.py</td>
  <td>vhost_queue_correlation_details.py</td>
  <td>vhost é˜Ÿåˆ—ã€virtio æ•ˆç‡ã€TUN/TAP ç¼“å†²åŒº</td>
</tr>
<tr>
  <td><strong>CPU/è°ƒåº¦</strong></td>
  <td>-</td>
  <td>offcputime-ts.py / pthread_rwlock_wrlock.bt</td>
  <td>Off-CPU æ—¶é—´ã€é”ç«äº‰ã€è°ƒåº¦å»¶è¿Ÿ</td>
</tr>
</tbody>
</table>

<hr />

<h2 id="3-åˆ†ææ–¹æ³•è®º">3. åˆ†ææ–¹æ³•è®º</h2>

<h3 id="31-ä¸‰å±‚è¯Šæ–­æ¨¡å‹">3.1 ä¸‰å±‚è¯Šæ–­æ¨¡å‹</h3>

<p><strong>ç¬¬ä¸€å±‚: é—®é¢˜å®šä½ (Summary å·¥å…·)</strong></p>

<p>ç›®æ ‡: å¿«é€Ÿè¯†åˆ«å¼‚å¸¸èŒƒå›´</p>

<ul>
<li>æ–¹æ³•: Histogram ç»Ÿè®¡ã€å®è§‚æŒ‡æ ‡</li>
<li>è¾“å‡º: å»¶è¿Ÿåˆ†å¸ƒ (P50/P95/P99/P999)ã€ä¸¢åŒ…ç»Ÿè®¡ã€æµè¡¨å‘½ä¸­ç‡</li>
<li>æ€§èƒ½: æä½å¼€é”€,å¯æŒç»­è¿è¡Œ</li>
<li>æ—¶é•¿: å°æ—¶ - å¤©</li>
</ul>

<p>ç¤ºä¾‹é—®é¢˜:</p>

<ul>
<li>"ç½‘ç»œå¶æœ‰å¡é¡¿" â†’ ä½¿ç”¨ latency_summary å‘ç° P99.9 = 150ms</li>
<li>"ä¸¢åŒ…ç‡ 0.1%" â†’ ä½¿ç”¨ drop_summary å‘ç°ä¸¢åœ¨ tun_get_user</li>
</ul>

<p><strong>ç¬¬äºŒå±‚: ç²¾ç¡®è¿½è¸ª (Details å·¥å…·)</strong></p>

<p>ç›®æ ‡: å®šä½å…·ä½“ç“¶é¢ˆã€æ•è·ä¸Šä¸‹æ–‡</p>

<ul>
<li>æ–¹æ³•: Per-packet è·Ÿè¸ª + è¿‡æ»¤å™¨</li>
<li>è¾“å‡º: å•åŒ…å®Œæ•´è·¯å¾„æ—¶é—´æˆ³ã€å„é˜¶æ®µå¤„ç†å»¶è¿Ÿã€äº”å…ƒç»„ä¿¡æ¯</li>
<li>æ€§èƒ½: å¼€é”€å¯è°ƒèŠ‚,å–å†³äºè¿‡æ»¤ç²’åº¦</li>
<li>æ—¶é•¿: åˆ†é’Ÿçº§ (é—®é¢˜å¤ç°æ—¶å¯åŠ¨)</li>
</ul>

<p>è¿‡æ»¤å™¨ç­–ç•¥:</p>

<ul>
<li>é’ˆå¯¹ç‰¹å®š IP/ç«¯å£ â†’ é™ä½äº‹ä»¶é‡ 90%+</li>
<li>å»¶è¿Ÿé˜ˆå€¼è¿‡æ»¤ (&gt;100ms) â†’ ä»…æ•è·å¼‚å¸¸äº‹ä»¶</li>
</ul>

<p>ç¤ºä¾‹é—®é¢˜:</p>

<ul>
<li>çŸ¥é“ P99.9 æ…¢,ä½†ä¸çŸ¥é“æ…¢åœ¨å“ªä¸ªé˜¶æ®µï¼Œæˆ–è€…æŸä¸ªé˜¶æ®µå†…éƒ¨çš„ä½•ç§å¤„ç†é€»è¾‘<br />
â†’ latency_details + é˜ˆå€¼è¿‡æ»¤ 100ms
â†’ æ•è· 3 ä¸ªäº‹ä»¶,å‘ç°éƒ½æ…¢åœ¨ OVS FLOW_EXTRACT é˜¶æ®µ</li>
</ul>

<p><strong>ç¬¬ä¸‰å±‚: æ ¹å› åˆ†æ (ä¸“é¡¹å·¥å…· + ç³»ç»Ÿå·¥å…·)</strong></p>

<p>ç›®æ ‡: æ·±æŒ–åº•å±‚åŸå›  (CPU/é”/é˜Ÿåˆ—/å†…å­˜)ï¼Œé’ˆå¯¹ç‰¹å®šè¿›ç¨‹/æ¨¡å—çš„ç‰¹å®šç±»å‹é—®é¢˜</p>

<ul>
<li>æ–¹æ³•: Off-CPU åˆ†æã€é”ç›‘æ§ã€è°ƒåº¦è·Ÿè¸ª</li>
<li>è¾“å‡º: Off-CPU ç«ç„°å›¾ã€é”ç«äº‰çƒ­ç‚¹ã€è°ƒåº¦å»¶è¿Ÿåˆ†å¸ƒ</li>
<li>æ€§èƒ½: å¼€é”€å–å†³äºå…·ä½“å·¥å…·å’Œä½¿ç”¨åœºæ™¯</li>
<li>æ—¶é•¿: ç§’ - åˆ†é’Ÿ (ç²¾ç¡®å®šä½é˜¶æ®µ)</li>
</ul>

<p>å·¥å…·ç»„åˆ:</p>

<ul>
<li>offcputime-ts.py â†’ å‘ç° handler çº¿ç¨‹ 187ms off-CPU</li>
<li>pthread_rwlock_wrlock.bt â†’ å®šä½åˆ° fat_rwlock é”ç­‰å¾…</li>
<li>futex.bt â†’ ç¡®è®¤è¿›å…¥ mutex æ…¢é€Ÿè·¯å¾„</li>
</ul>

<p>ç¤ºä¾‹é—®é¢˜:</p>

<ul>
<li>OVS é˜¶æ®µæ…¢ 221ms,ä½† CPU ä½¿ç”¨ç‡æ­£å¸¸<br />
â†’ offcputime å‘ç°å¤§é‡ off-CPU æ—¶é—´<br />
â†’ pthread_rwlock å‘ç° revalidator æŒæœ‰å†™é” 200ms<br />
â†’ æ ¹å› : æµè¡¨é”è®¾è®¡é—®é¢˜,éè®¡ç®—ç“¶é¢ˆ</li>
</ul>

<h3 id="32-è¯Šæ–­å†³ç­–æµç¨‹">3.2 è¯Šæ–­å†³ç­–æµç¨‹</h3>

<pre><code>                    [ç½‘ç»œé—®é¢˜ç—‡çŠ¶]
                          |
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          |               |               |
        ä¸¢åŒ…            å»¶è¿Ÿé«˜           ååé‡ä½
          |               |               |
          v               v               v
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Layer 1 â”‚     â”‚ Layer 1 â”‚     â”‚ Layer 1 â”‚
    â”‚ Summary â”‚     â”‚ Summary â”‚     â”‚ Summary â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         |               |               |
         v               v               v
    ä¸¢åœ¨å“ªé‡Œ?       æ…¢åœ¨å“ªä¸ªé˜¶æ®µ?      ç“¶é¢ˆåœ¨å“ªå±‚?
         |               |               |
         v               v               v
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Layer 2 â”‚     â”‚ Layer 2 â”‚     â”‚ Layer 2 â”‚
    â”‚ Details â”‚     â”‚ Details â”‚     â”‚ Details â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         |               |               |
         v               v               v
    å…·ä½“å“ªä¸ªåŒ…?     å…·ä½“å¤šæ…¢?        å…·ä½“å•¥é—®é¢˜?
         |               |               |
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         v
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Layer 3 â”‚
                    â”‚  ä¸“é¡¹   â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         v
                    CPU/é”/è°ƒåº¦
                    æ ¹å› ç¡®è®¤
</code></pre>

<hr />

<h2 id="4-å®æˆ˜åº”ç”¨">4. å®æˆ˜åº”ç”¨</h2>

<h3 id="41-å•å·¥å…·ä½¿ç”¨ç¤ºä¾‹">4.1 å•å·¥å…·ä½¿ç”¨ç¤ºä¾‹</h3>

<h4 id="ç¤ºä¾‹-1-kernel_drop_stack_stats_summary_allpy">ç¤ºä¾‹ 1: kernel_drop_stack_stats_summary_all.py</h4>

<p><strong>åœºæ™¯</strong>: ç³»ç»ŸæŠ¥å‘Š ICMP ä¸¢åŒ…,éœ€è¦ç¡®è®¤çœŸå®ä¸¢åŒ…é‡å’Œä¸¢åŒ…ä½ç½®</p>

<p><strong>å‘½ä»¤</strong>:</p>

<pre><code>sudo python3 ebpf-tools/linux-network-stack/packet-drop/kernel_drop_stack_stats_summary_all.py \
  --src-ip 10.132.114.11 \
  --dst-ip 10.132.114.12 \
  --l4-protocol icmp \
  --interval 60 \
  --duration 1800 \
  --top 10
</code></pre>

<p><strong>è¾“å‡ºè§£è¯»</strong>:</p>

<pre><code>[2025-10-20 10:45:00] === Drop Stack Statistics (Interval: 60.0s) ===

Found 2 unique stack+flow combinations:

#1 Count: 23 calls [device: br-int] [stack_id: 127]
   Flow: 10.132.114.11 -&gt; 10.132.114.12 (ICMP)
Stack trace:
  kfree_skb+0x1 [kernel]
  ip_rcv_core+0x1a2 [kernel]        â† ä¸¢åŒ…ä½ç½®: IP å±‚
  ip_rcv+0x2d [kernel]
  __netif_receive_skb_core+0x677

åˆ†æ: IP å±‚ä¸¢åŒ…,å¯èƒ½åŸå› æ˜¯ TTL è¶…æ—¶æˆ–è·¯ç”±å¤±è´¥

#2 Count: 8 calls [device: ens11] [stack_id: 234]
   Flow: 10.132.114.11 -&gt; 10.132.114.12 (ICMP)
Stack trace:
  kfree_skb+0x1 [kernel]
  __dev_queue_xmit+0x7a2 [kernel]   â† ä¸¢åŒ…ä½ç½®: TX é˜Ÿåˆ—
  dev_queue_xmit+0x10

åˆ†æ: TX é˜Ÿåˆ—æº¢å‡º,å¯èƒ½æ˜¯ qdisc æ»¡æˆ–ç½‘å¡å¿™

Total drops in 30 min: 31 packets (0.17% of 18,000 sent)
</code></pre>

<p><strong>å…³é”®å‘ç°</strong>: çœŸå®å†…æ ¸ä¸¢åŒ…ä»… 0.17%,è¿œä½äºç›‘æ§æŠ¥å‘Šçš„ 1.3%,å·®å¼‚æ˜¯é«˜å»¶è¿Ÿè¶…æ—¶è¯¯åˆ¤ã€‚</p>

<h4 id="ç¤ºä¾‹-2-system_network_latency_summarypy">ç¤ºä¾‹ 2: system_network_latency_summary.py</h4>

<p><strong>åœºæ™¯</strong>: éœ€è¦å»ºç«‹ç½‘ç»œå»¶è¿ŸåŸºçº¿,è¯†åˆ«é•¿å°¾å»¶è¿Ÿ</p>

<p><strong>å‘½ä»¤</strong>:</p>

<pre><code>sudo python3 ebpf-tools/performance/system-network/system_network_latency_summary.py \
  --phy-interface ens11 \
  --src-ip 10.132.114.11 \
  --dst-ip 10.132.114.12 \
  --direction rx \
  --protocol icmp \
  --interval 60
</code></pre>

<p><strong>è¾“å‡ºè§£è¯»</strong>:</p>

<pre><code>Stage: INTERNAL_RX â†’ FLOW_EXTRACT_END_RX (OVS å¤„ç†)
     latency (us)    : count    distribution
        0 -&gt; 1       :   156   |*******                    |
        2 -&gt; 3       :   345   |****************           |
        4 -&gt; 7       :   678   |********************************|
        8 -&gt; 15      :   891   |************************************| â† P50
       16 -&gt; 31      :   234   |***********                |
       32 -&gt; 63      :   123   |******                     |
       64 -&gt; 127     :   67    |***                        | â† P95
      128 -&gt; 255     :   34    |*                          |
   131072 -&gt; 262143  :   1     |                           | â† P999 é•¿å°¾!

åˆ†æ:
â€¢ P50: ~10us (æ­£å¸¸)
â€¢ P95: ~80us (æ­£å¸¸)
â€¢ P999: 200ms+ (å¼‚å¸¸! å­˜åœ¨æç«¯é•¿å°¾å»¶è¿Ÿ)
â€¢ å¼‚å¸¸äº‹ä»¶: 1/2567 = 0.04%

Total packets: 2,567
Packets with latency &gt; 200ms: 1 packet
</code></pre>

<p><strong>å…³é”®å‘ç°</strong>: ç»å¤§å¤šæ•°åŒ…å»¶è¿Ÿæ­£å¸¸,ä½†å­˜åœ¨ç½•è§çš„ 200ms+ é•¿å°¾,éœ€è¦ Details å·¥å…·ç²¾ç¡®æ•è·ã€‚</p>

<h4 id="ç¤ºä¾‹-3-ovs_userspace_megaflowpy">ç¤ºä¾‹ 3: ovs_userspace_megaflow.py</h4>

<p><strong>åœºæ™¯</strong>: OVS æ€§èƒ½ä¸‹é™,æ€€ç–‘æµè¡¨æœªå‘½ä¸­ç‡é«˜</p>

<p><strong>å‘½ä»¤</strong>:</p>

<pre><code>sudo python3 ebpf-tools/ovs/ovs_userspace_megaflow.py \
  --ip-src 10.132.114.11 \
  --ip-dst 10.132.114.12 \
  --ip-proto 1
</code></pre>

<p><strong>è¾“å‡ºè§£è¯»</strong>:</p>

<pre><code>=== UPCALL Event ===
Time: 2025-10-20 10:28:42.567891
PID: 2456 (handler23)
Flow: 10.132.114.11:0 -&gt; 10.132.114.12:0 (Proto: 1/ICMP)
Device: br-int
SKB Mark: 0x0

=== FLOW_CMD_NEW Event ===
Time: 2025-10-20 10:28:42.568123
PID: 2456 (handler23)
Flow Key:
  eth_type: 0x0800 (IPv4)
  ipv4_src: 10.132.114.11
  ipv4_dst: 10.132.114.12
  ip_proto: 1 (ICMP)
Actions:
  output: port 5 (ens11)

Installation Latency: 232 us

åˆ†æ:
â€¢ Upcall åˆ° Megaflow å®‰è£…è€—æ—¶ 232us (æ­£å¸¸èŒƒå›´ &lt;500us)
â€¢ è¯¥æµä¹‹å‰æœªåœ¨å†…æ ¸æµè¡¨ä¸­,è§¦å‘ upcall
â€¢ ovs-vswitchd æ­£ç¡®ä¸‹å‘äº† Megaflow
</code></pre>

<p><strong>å…³é”®å‘ç°</strong>: Upcall å»¶è¿Ÿæ­£å¸¸,ä½†å¦‚æœé¢‘ç¹å‡ºç°ç›¸åŒæµçš„ Upcall,è¯´æ˜ Megaflow æœªç”Ÿæ•ˆæˆ–è¢«è¿‡æ—©åˆ é™¤ã€‚</p>

<h3 id="42-å¤æ‚é—®é¢˜å®æˆ˜-æ¡ˆä¾‹ç ”ç©¶">4.2 å¤æ‚é—®é¢˜å®æˆ˜: æ¡ˆä¾‹ç ”ç©¶</h3>

<h4 id="æ¡ˆä¾‹-1-ç³»ç»Ÿç½‘ç»œ-icmp-ä¸¢åŒ…-æ ¹å› åˆ†æ-å»¶è¿Ÿè¯¯åˆ¤é—®é¢˜">æ¡ˆä¾‹ 1: ç³»ç»Ÿç½‘ç»œ ICMP "ä¸¢åŒ…" æ ¹å› åˆ†æ - å»¶è¿Ÿè¯¯åˆ¤é—®é¢˜</h4>

<p><strong>å®Œæ•´è¯Šæ–­æµç¨‹</strong> (è¯¦è§ troubleshooting-practice.md æ¡ˆä¾‹ 1):</p>

<p><strong>é—®é¢˜æè¿°</strong>:</p>

<ul>
<li>ç›‘æ§æŠ¥å‘Š: ICMP ä¸¢åŒ…ç‡ 1.3% (200ms è¶…æ—¶é˜ˆå€¼)</li>
<li>ä¸šåŠ¡å½±å“: å¶å‘ç½‘ç»œè¿æ¥è´¨é‡ä¸‹é™</li>
<li>ç¯å¢ƒ: OpenStack + KVM + OVS</li>
<li>æµé‡: 10.132.114.11 â†” 10.132.114.12, ICMP ping</li>
</ul>

<p><strong>Layer 1: çœŸå®ä¸¢åŒ… vs é«˜å»¶è¿ŸåŒºåˆ†</strong></p>

<p>å·¥å…·: kernel_drop_stack_stats_summary_all.py<br />
è¿è¡Œæ—¶é•¿: 30 åˆ†é’Ÿ<br />
ç»“æœ:</p>

<ul>
<li>çœŸå®å†…æ ¸ä¸¢åŒ…: 31 packets (0.17%)</li>
<li>ç›‘æ§"ä¸¢åŒ…": 234 packets (1.3%)</li>
<li>å·®å¼‚: 203 packets â†’ é«˜å»¶è¿Ÿè¶…æ—¶!<br />
ç»“è®º: é—®é¢˜ä¸æ˜¯ä¸¢åŒ…,æ˜¯å»¶è¿Ÿ</li>
</ul>

<p><strong>Layer 2: å»¶è¿Ÿæ¥æºå®šä½</strong></p>

<p>å·¥å…·: system_network_latency_summary.py<br />
ç»“æœ:</p>

<ul>
<li>P99: 89 us (æ­£å¸¸)</li>
<li>P99.9: 134 ms (å¼‚å¸¸!)</li>
<li>è¶…è¿‡ 200ms çš„åŒ…: 3 ä¸ª</li>
<li>å»¶è¿Ÿé›†ä¸­é˜¶æ®µ: INTERNAL_RX â†’ FLOW_EXTRACT_END_RX<br />
ç»“è®º: OVS å¤„ç†é˜¶æ®µå¶å‘æç«¯å»¶è¿Ÿ</li>
</ul>

<p><strong>Layer 2: OVS æ·±åº¦åˆ†æ</strong></p>

<p>å·¥å…·: ovs_upcall_latency_summary.py<br />
ç»“æœ:</p>

<ul>
<li>P50: 65 us (æ­£å¸¸)</li>
<li>P95: 289 us (å¯æ¥å—)</li>
<li>P99.9: 134,567 us = 134ms (å¼‚å¸¸!)</li>
<li>Max: 287,456 us = 287ms (è¶…è¿‡é˜ˆå€¼!)<br />
ç»“è®º: Upcall å¤„ç†æœ‰æç«¯é•¿å°¾å»¶è¿Ÿ</li>
</ul>

<p><strong>Layer 2: ç²¾ç¡®äº‹ä»¶æ•è·</strong></p>

<p>å·¥å…·: system_network_latency_details.py --threshold 100ms<br />
ç»“æœ: æ•è· 3 ä¸ªé«˜å»¶è¿Ÿäº‹ä»¶</p>

<ul>
<li>Event #1: 10:28:42.567 â†’ 10:28:42.789 (221ms)</li>
<li>Event #2: 10:29:15.234 â†’ 10:29:15.521 (287ms)</li>
<li>Event #3: 10:31:08.123 â†’ 10:31:08.412 (289ms)</li>
</ul>

<p>å…±åŒç‰¹å¾:</p>

<ul>
<li>éƒ½åœ¨ OVS FLOW_EXTRACT é˜¶æ®µ</li>
<li>å¤„ç†è¿›ç¨‹: handler23 (ovs-vswitchd)</li>
<li>CPU: å§‹ç»ˆåœ¨ CPU 12<br />
ç»“è®º: è·å¾—ç²¾ç¡®æ—¶é—´æˆ³,å¯å…³è”å…¶ä»–ç›‘æ§æ•°æ®</li>
</ul>

<p><strong>Layer 3: CPU/è°ƒåº¦åˆ†æ</strong></p>

<p>å·¥å…· 1: pidstat -p $(pgrep ovs-vswitchd) 1<br />
å‘ç°:</p>

<ul>
<li>æ­£å¸¸æ—¶æ®µ: CPU 35%</li>
<li>Burst æ—¶æ®µ: CPU 185-190% (å¤šæ ¸)</li>
<li>Burst æ—¶é—´: ä¸é«˜å»¶è¿Ÿäº‹ä»¶å®Œå…¨ä¸€è‡´!</li>
<li>é—®é¢˜: 15s ç›‘æ§ç²’åº¦é—æ¼äº† 2-4s çš„ burst</li>
</ul>

<p>å·¥å…· 2: offcputime-ts.py -p $(pgrep ovs-vswitchd)<br />
å‘ç°:</p>

<ul>
<li>handler23 çº¿ç¨‹ off-CPU: 187ms, 203ms</li>
<li>åŸå› : __mutex_lock_slowpath (mutex æ…¢é€Ÿè·¯å¾„)</li>
<li>ä½ç½®: ovs_flow_tbl_lookup (æµè¡¨æŸ¥æ‰¾)<br />
ç»“è®º: å¤§é‡æ—¶é—´åœ¨ç­‰é”,éè®¡ç®—å¯†é›†</li>
</ul>

<p>å·¥å…· 3: pthread_rwlock_wrlock.bt<br />
å‘ç°:</p>

<ul>
<li>é”: fat_rwlock (OVS æµè¡¨é”) at 0x7f8a2c001a40</li>
<li>ç«äº‰çº¿ç¨‹:
<ul>
<li>handler23 (æ•°æ®é¢) - ç­‰å¾…è¯»é” 187ms</li>
<li>revalidator12 (æ§åˆ¶é¢) - æŒæœ‰å†™é”æ¸…ç†æµè¡¨</li>
</ul></li>
<li>å†²çª: revalidator æ¸…ç†æ—¶é˜»å¡æ‰€æœ‰ handler<br />
ç»“è®º: æµè¡¨é”è®¾è®¡é—®é¢˜</li>
</ul>

<p><strong>æ ¹å› æ€»ç»“</strong>:</p>

<p>OVS revalidator å®šæœŸæ¸…ç†æµè¡¨ (150-200ms æŒé”)<br />
â†’ æ‰€æœ‰ handler çº¿ç¨‹ç­‰å¾… fat_rwlock è¯»é”<br />
â†’ è¿›å…¥ mutex æ…¢é€Ÿè·¯å¾„ + futex ç³»ç»Ÿè°ƒç”¨<br />
â†’ 187-203ms off-CPU æ—¶é—´<br />
â†’ Upcall å¤„ç†å»¶è¿Ÿ 200-280ms<br />
â†’ æ•°æ®åŒ… OVS å»¶è¿Ÿ &gt;200ms<br />
â†’ ç›‘æ§åˆ¤å®šä¸º"ä¸¢åŒ…"</p>

<p><strong>è§£å†³æ–¹æ¡ˆä¸éªŒè¯</strong>:</p>

<pre><code># æ–¹æ¡ˆ 1: å‡å°‘ revalidator çº¿ç¨‹
sudo ovs-vsctl set Open_vSwitch . other_config:n-revalidator-threads=1

# æ–¹æ¡ˆ 2: (é•¿æœŸ) å‡çº§ OVS åˆ° 2.15+ (æ”¯æŒ RCU flow table)

# éªŒè¯: å†æ¬¡è¿è¡Œç›‘æ§
ä¿®å¤å‰: ç›‘æ§"ä¸¢åŒ…" 1.3%, P99.9 å»¶è¿Ÿ 134ms
ä¿®å¤å: ç›‘æ§"ä¸¢åŒ…" 0.21%, P99.9 å»¶è¿Ÿ 2.3ms (æ”¹å–„ 98%!)
</code></pre>

<p><strong>å…³é”®ç»éªŒ</strong>:</p>

<ol>
<li>åŒºåˆ†çœŸå®ä¸¢åŒ… vs é«˜å»¶è¿Ÿè¶…æ—¶ (Summary å·¥å…·éªŒè¯)</li>
<li>Histogram é•¿å°¾è¯†åˆ« (P99.9 vs P50)</li>
<li>ç²¾ç¡®äº‹ä»¶æ•è· + æ—¶é—´æˆ³å…³è”</li>
<li>å¤šå±‚æ·±å…¥: ç½‘ç»œ â†’ CPU â†’ é”</li>
<li>Off-CPU åˆ†æ: CPU ä½¿ç”¨ç‡é«˜ â‰  è®¡ç®—å¯†é›†</li>
<li>ç›‘æ§ç›²åŒº: 15s ç²’åº¦é—æ¼ 2-4s burst</li>
</ol>

<hr />

<h4 id="æ¡ˆä¾‹-2-vm-ç½‘ç»œé—´æ­‡æ€§ä¸é€š-virtio-net-ä¸­æ–­é£æš´æ ¹å› åˆ†æ">æ¡ˆä¾‹ 2: VM ç½‘ç»œé—´æ­‡æ€§ä¸é€š - virtio-net ä¸­æ–­é£æš´æ ¹å› åˆ†æ</h4>

<p><strong>é—®é¢˜èƒŒæ™¯</strong>:</p>

<p>ç¯å¢ƒ:</p>

<ul>
<li>è™šæ‹ŸåŒ–å¹³å°: OpenStack + KVM/QEMU (ARM64)</li>
<li>ç½‘ç»œå±‚: OVS â†’ TAP/TUN â†’ vhost-net â†’ virtio-net</li>
<li>VM ç½‘å¡: eth0 (8 ä¸ª RX é˜Ÿåˆ—)</li>
</ul>

<p>ç—‡çŠ¶:</p>

<ul>
<li>VM å†…éƒ¨ç½‘ç»œé—´æ­‡æ€§ä¸é€š</li>
<li>SSH è¿æ¥éè¿ç»­æ€§æ–­è¿</li>
<li>æŒç»­æ•°åˆ†é’Ÿåè‡ªåŠ¨æ¢å¤</li>
<li>ä¸å®šæœŸéšæœºå‡ºç°</li>
</ul>

<p>åˆæ­¥çº¿ç´¢:</p>

<ul>
<li>å®¿ä¸»æœº vnet37 è®¾å¤‡å­˜åœ¨ä¸¢åŒ…</li>
<li>VM å†…æ ¸æ—¥å¿—å¶å°”å‡ºç°ä¸­æ–­ç›¸å…³å‘Šè­¦</li>
</ul>

<p><strong>è¯Šæ–­æµç¨‹</strong> (8 å±‚é€’è¿›å¼åˆ†æ):</p>

<p><strong>Layer 1: å®¿ä¸»æœºä¸¢åŒ…å®šä½</strong></p>

<ul>
<li>å·¥å…·: kernel_drop_stack_stats_summary.py</li>
<li>å‘ç°: 100% ä¸¢åŒ…é›†ä¸­åœ¨ tun_net_xmit è·¯å¾„,è°ƒç”¨æ ˆå®Œå…¨ä¸€è‡´</li>
<li>ç»“è®º: vhost-net å†™ tfile->tx_ring å¤±è´¥ â†’ ring full</li>
</ul>

<p><strong>Layer 2: TUN ring è¯¦ç»†ç›‘æ§</strong></p>

<ul>
<li>å·¥å…·: tun_ring_monitor.py</li>
<li>å‘ç°: Queue 2 çš„ tfile->tx_ring æŒç»­æ»¡è½½,å…¶ä»– 7 ä¸ªé˜Ÿåˆ—å®Œå…¨æ­£å¸¸</li>
<li>ç»“è®º: VM å†…éƒ¨ RX Queue 2 ä¸æ¶ˆè´¹æ•°æ®</li>
</ul>

<p><strong>Layer 3: vhost-net çº¿ç¨‹è¡Œä¸ºåˆ†æ</strong></p>

<ul>
<li>å·¥å…·: vhost_queue_correlation_details.py</li>
<li>å‘ç°: vhost æ­£å¸¸å†™å…¥ vring,ä½† Guest è®¾ç½® avail_flags = NO_INTERRUPT</li>
<li>ç»“è®º: "æ­»é”"çŠ¶æ€ - ringæ»¡ â†’ æ— ä¸­æ–­ â†’ Guestä¸æ¶ˆè´¹</li>
</ul>

<p><strong>Layer 4: VM NAPI poll ç›‘æ§</strong></p>

<ul>
<li>å·¥å…·: virtnet_poll_monitor.py (VM å†…éƒ¨)</li>
<li>å‘ç°: Queue 2 å®Œå…¨æ—  NAPI å¤„ç†,å…¶ä»–é˜Ÿåˆ—æ­£å¸¸</li>
<li>ç»“è®º: Queue 2 ä¸­æ–­å¤„ç†è¢«ç¦ç”¨æˆ–ä¸­æ–­æœªåˆ°è¾¾</li>
</ul>

<p><strong>Layer 5: VM å†…æ ¸æ—¥å¿—åˆ†æ</strong> â† å…³é”®å‘ç°!</p>

<ul>
<li>æ“ä½œ: dmesg | grep -i "irq"</li>
<li>å‘ç°: å†…æ ¸ä¿æŠ¤æœºåˆ¶è§¦å‘<br />
<pre><code>[kernel] irq 69: nobody cared
[kernel] handlers: vring_interrupt [virtio_ring]
[kernel] Disabling IRQ #69 â† IRQ è¢«ç¦ç”¨!
[kernel] virtio_net: IRQ 69 disabled for input.2-rx<br />
</code></pre></li>
<li>/proc/interrupts ç¡®è®¤: 69: 987654 ... 0 GIC-0 input.2-rx (DISABLED)</li>
<li>ç»“è®º: Linux IRQ storm ä¿æŠ¤æœºåˆ¶è§¦å‘,vring_interrupt è¿”å› IRQ_NONE è¿‡å¤š â†’ ç¦ç”¨ IRQ</li>
</ul>

<p><strong>Layer 6: äº¤å‰éªŒè¯ - æ’é™¤å®¿ä¸»æœºä¾§"ç©ºä¸­æ–­"</strong></p>

<ul>
<li>å¤–éƒ¨æ•°æ®: Kylin å·¥å…·æŠ¥å‘Š vring_interrupt æ¬¡æ•° &gt; idxå¢é‡</li>
<li>éªŒè¯ 1 (vhost_queue_correlation_details.py): vhost_signal 8,234 æ¬¡ = vring idx æ›´æ–° 8,234 æ¬¡,å®Œå…¨ 1:1 å¯¹åº”</li>
<li>éªŒè¯ 2 (kvm_irqfd_stats_summary_arm.py): irqfd_wakeup 8,234 = vgic_v3_populate_lr 8,234,KVM æ— é‡å¤æ³¨å…¥</li>
<li>è‡ªç ”å·¥å…·éªŒè¯: å®é™…ä¸­æ–­ 8,567 vs Kylin æŠ¥å‘Š 10,123 (åå·® 18%),IRQ_NONE æ¯”ä¾‹ 10.3%</li>
<li>ç»“è®º: å®¿ä¸»æœºä¾§æ— é—®é¢˜</li>
</ul>

<p><strong>Layer 7: IRQ_NONE è¯¦ç»†åˆ†æ</strong></p>

<ul>
<li>å·¥å…·: trace_int_final.bt &amp;&amp; virtionet-rx-path-summary.bt (VM å†…éƒ¨)</li>
<li>å‘ç°: IRQ_NONE æŒç»­å­˜åœ¨,å¹³æ—¶ 5-8% (æ­£å¸¸),é—®é¢˜æœŸ 10-20% (è¶…é˜ˆå€¼)</li>
<li>åŸå› : used_idx == last_used_idx (vring æ— æ–°æ•°æ®)</li>
<li>ç´¯ç§¯: çŸ­æ—¶é—´è¾¾åˆ° 99,900/100,000 é˜ˆå€¼è§¦å‘ä¿æŠ¤</li>
<li>IRQ_NONE äº§ç”ŸåŸå› : Host æ›´æ–° idx â†’ å‘é€ä¸­æ–­ â†’ ä½† Guest å·²æå‰è¯»å– idx ï¼ˆæå‰ pollingï¼‰â†’ ä¸­æ–­åˆ°è¾¾æ—¶å‘ç°å·²å¤„ç† â†’ è¿”å› IRQ_NONE</li>
<li>ç»“è®º: Kylin å·¥å…·æœ‰åå·®, æµ‹é‡æ•°æ®å¤±çœŸå¯¼è‡´è¯¯åˆ¤ä¸º host å¤šå‘æ— æ•ˆä¸­æ–­ï¼›å¹¶ä¸”å­˜åœ¨éä¸­æ–­å‡ºå‘ virtnet_poll, éœ€è¦æ‰¾å‡ºè°åœ¨"æŠ¢å…ˆæ¶ˆè´¹"æ•°æ®,</li>
</ul>

<p><strong>Layer 8: è°ƒç”¨æ ˆåˆ†æ - å®šä½æ ¹å› !</strong></p>

<ul>
<li>å·¥å…·: virtnet_poll_stack_stats.bt (VM å†…éƒ¨)</li>
<li>å‘ç°: 84% virtnet_poll æ¥è‡ª napi_busy_loop!</li>
<li>è°ƒç”¨æ ˆç»Ÿè®¡ (45,678 æ¬¡ virtnet_poll):
<ul>
<li>æ­£å¸¸ä¸­æ–­è·¯å¾„ (net_rx_action): 7,234 (15.8%)</li>
<li>napi_busy_loop è·¯å¾„: 38,444 (84.2%)</li>
</ul></li>
<li>busy_loop è°ƒç”¨é“¾: ç”¨æˆ·æ€ â†’ tcp_recvmsg â†’ sk_busy_loop â†’ napi_busy_loop â†’ virtnet_poll (ç»•è¿‡ä¸­æ–­!)</li>
<li>æ—¶åºå†²çª: busy_loop ä¸»åŠ¨è°ƒç”¨ virtnet_poll å¤„ç†åŒ…å,ä¸­æ–­åˆ°è¾¾æ—¶å‘ç°æ•°æ®å·²å¤„ç†,è¿”å› IRQ_NONE</li>
<li>å‚æ•°éªŒè¯: sysctl net.core.busy_poll = 50 â† å¯ç”¨äº† busy poll!</li>
<li>æ ¹å› ç¡®è®¤: SO_BUSY_POLL + ä¸­æ–­ç«äº‰ â†’ IRQ storm</li>
</ul>

<p><strong>å®Œæ•´å› æœé“¾</strong>:</p>

<pre><code>VM åº”ç”¨å¯ç”¨ SO_BUSY_POLL (net.core.busy_poll=50)
â†’ ç”¨æˆ·æ€é¢‘ç¹ä¸»åŠ¨è°ƒç”¨ napi_busy_loop (84% çš„ poll è°ƒç”¨)
â†’ busy_loop æŠ¢å…ˆå¤„ç† vring æ•°æ® (æ¯”ä¸­æ–­æ›´å¿«)
â†’ ä¸­æ–­åˆ°è¾¾æ—¶å‘ç°æ•°æ®å·²å¤„ç† (used_idx == last_used_idx)
â†’ vring_interrupt è¿”å› IRQ_NONE
â†’ spurious interrupt æ¯”ä¾‹è¾¾åˆ° 10-20%
â†’ çŸ­æ—¶é—´å†…ç´¯ç§¯åˆ° 99,900/100,000 é˜ˆå€¼
â†’ å†…æ ¸è§¦å‘ä¿æŠ¤: "irq 69: nobody cared"
â†’ å†…æ ¸ç¦ç”¨è¯¥ IRQ
â†’ Queue 2 å½»åº•å¤±æ•ˆ,æ— æ³•æ¥æ”¶æ•°æ®
â†’ tfile-&gt;tx_ring æŒç»­ full (å®¿ä¸»æœºä¾§)
â†’ å®¿ä¸»æœºä¸¢åŒ…,VM ç½‘ç»œä¸é€š
</code></pre>

<p><strong>è§£å†³æ–¹æ¡ˆä¸éªŒè¯</strong>:</p>

<pre><code># ä¿®å¤æ–¹æ¡ˆ 1: ç¦ç”¨ busy_poll (æ¨è)
sysctl -w net.core.busy_poll=0
sysctl -w net.core.busy_read=0

# ä¿®å¤æ–¹æ¡ˆ 2: å¢å¤§ busy_poll å»¶è¿Ÿ (å‡å°‘è½®è¯¢é¢‘ç‡)
sysctl -w net.core.busy_poll=500  # 50us â†’ 500us

# æŒä¹…åŒ–é…ç½®
cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF
net.core.busy_poll = 0
net.core.busy_read = 0
EOF

# éªŒè¯ä¿®å¤æ•ˆæœ
# Before fix (busy_poll=50):
#   IRQ_NONE rate: 10.2% (878/8567)
#   ä¸­æ–­ç¦ç”¨: æ¯ 2-5 åˆ†é’Ÿè§¦å‘
#   TUN ä¸¢åŒ…: 1,247 drops/30s
#   ç½‘ç»œçŠ¶æ€: é—´æ­‡æ€§ä¸é€š
#
# After fix (busy_poll=0):
#   IRQ_NONE rate: 0.49% (42/8567) â† ä¸‹é™ 95%!
#   ä¸­æ–­ç¦ç”¨: 7 å¤©æ— å‘ç”Ÿ
#   TUN ä¸¢åŒ…: 0 drops
#   ç½‘ç»œçŠ¶æ€: å®Œå…¨ç¨³å®š
</code></pre>

<p><strong>å…³é”®ç»éªŒ</strong>:</p>

<ol>
<li>è°ƒç”¨æ ˆ 100% ä¸€è‡´æ€§: ç«‹å³æ’é™¤éšæœºå› ç´ ,èšç„¦ç³»ç»Ÿæ€§åŸå› </li>
<li>é˜Ÿåˆ—çº§åˆ«éš”ç¦»: å•é˜Ÿåˆ—é—®é¢˜å¿«é€Ÿç¼©å°æ’æŸ¥èŒƒå›´</li>
<li>å†…æ ¸æ—¥å¿—ä¼˜å…ˆçº§: dmesg çš„ "nobody cared" æ˜¯å…³é”®çº¿ç´¢</li>
<li>äº¤å‰éªŒè¯å¤–éƒ¨æ•°æ®: å‘ç°ç¬¬ä¸‰æ–¹å·¥å…·åå·®,é¿å…è¯¯åˆ¤</li>
<li>ç†è§£å†…æ ¸ä¿æŠ¤æœºåˆ¶: IRQ storm protection çš„é˜ˆå€¼å’Œè§¦å‘æ¡ä»¶</li>
<li>æ—¶åºåˆ†æ: busy_poll ä¸ä¸­æ–­çš„ç«äº‰å…³ç³»</li>
<li>ç”¨æˆ·æ€å‚æ•°å½±å“: sysctl å‚æ•°ä¼šæ˜¾è‘—å½±å“å†…æ ¸è¡Œä¸º</li>
<li>å·¥å…·ç»„åˆæ¨¡å¼: Summary â†’ Details â†’ ç³»ç»Ÿæ—¥å¿— â†’ å‚æ•°éªŒè¯</li>
<li>åŒå‘äº¤å‰éªŒè¯: å®¿ä¸»æœºæµ‹é‡ â†” VM å†…éƒ¨æµ‹é‡</li>
<li>å·¥å…·äº’è¡¥: BCC Python (çµæ´»è¿‡æ»¤) + bpftrace (å¿«é€ŸåŸå‹)</li>
</ol>

<p><strong>æ¡ˆä¾‹å¯¹æ¯”æ€»ç»“</strong>:</p>

<table>
<thead>
<tr>
  <th>ç»´åº¦</th>
  <th>æ¡ˆä¾‹ 1 (OVS é”ç«äº‰)</th>
  <th>æ¡ˆä¾‹ 2 (virtio-net ä¸­æ–­é£æš´)</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>é—®é¢˜åŸŸ</strong></td>
  <td>ç³»ç»Ÿç½‘ç»œå±‚ (OVS)</td>
  <td>è™šæ‹ŸåŒ–ç½‘ç»œå±‚ (virtio/vhost)</td>
</tr>
<tr>
  <td><strong>è¡¨è±¡</strong></td>
  <td>ç›‘æ§æŠ¥å‘Š"ä¸¢åŒ…"</td>
  <td>å®é™…é—´æ­‡æ€§ä¸é€š</td>
</tr>
<tr>
  <td><strong>çœŸå®é—®é¢˜</strong></td>
  <td>é«˜å»¶è¿Ÿè¶…æ—¶è¯¯åˆ¤</td>
  <td>ä¸­æ–­è¢«å†…æ ¸ç¦ç”¨</td>
</tr>
<tr>
  <td><strong>æ ¹å› </strong></td>
  <td>OVS æµè¡¨é”ç«äº‰</td>
  <td>napi_busy_poll ç«äº‰ä¸­æ–­</td>
</tr>
<tr>
  <td><strong>å…³é”®å·¥å…·</strong></td>
  <td>offcputime + pthread_rwlock</td>
  <td>virtnet_poll_stack_stats.bt</td>
</tr>
<tr>
  <td><strong>è¯Šæ–­å±‚æ•°</strong></td>
  <td>6 å±‚</td>
  <td>8 å±‚</td>
</tr>
<tr>
  <td><strong>ä¿®å¤éš¾åº¦</strong></td>
  <td>ä¸­ç­‰ (éœ€å‡çº§ OVS)</td>
  <td>ç®€å• (å‚æ•°è°ƒæ•´)</td>
</tr>
<tr>
  <td><strong>ä¿®å¤æ•ˆæœ</strong></td>
  <td>P99.9 å»¶è¿Ÿæ”¹å–„ 98%</td>
  <td>IRQ_NONE ä¸‹é™ 95%</td>
</tr>
<tr>
  <td><strong>æ ¸å¿ƒæ´å¯Ÿ</strong></td>
  <td>CPU é«˜ â‰  è®¡ç®—å¯†é›†</td>
  <td>ç”¨æˆ·æ€é…ç½® â†’ å†…æ ¸è¡Œä¸º</td>
</tr>
</tbody>
</table>

<hr />

<h2 id="5-æ€§èƒ½æµ‹è¯•æ•°æ®">5. æ€§èƒ½æµ‹è¯•æ•°æ®</h2>

<h3 id="51-å…³é”®æ€§èƒ½æ•°æ®ç‚¹">5.1 å…³é”®æ€§èƒ½æ•°æ®ç‚¹</h3>

<p>æœ¬èŠ‚å±•ç¤ºæ ‡å¿—æ€§çš„æ€§èƒ½æµ‹è¯•æ•°æ®,è¯´æ˜ä¸åŒç±»å‹å·¥å…·çš„æ€§èƒ½ç‰¹å¾:</p>

<h4 id="1-summary-å·¥å…·-æ€§èƒ½å¼€é”€æå°å¯¹-workload-å½±å“æå°">1. Summary å·¥å…·: æ€§èƒ½å¼€é”€æå°,å¯¹ workload å½±å“æå°</h4>

<p><strong>å·¥å…·</strong>: system_network_perfomance_metrics.py</p>

<p>æµ‹è¯•æ¡ä»¶:</p>

<ul>
<li>æµé‡ç±»å‹: TCP RX</li>
<li>æ•°æ®åŒ…é€Ÿç‡: ~120 ä¸‡ PPS</li>
<li>æµ‹è¯•æ—¶é•¿: 30 åˆ†é’Ÿ</li>
</ul>

<p>æµ‹è¯•ç»“æœ:</p>

<table>
<thead>
<tr>
  <th>æŒ‡æ ‡</th>
  <th>æ— å·¥å…·åŸºçº¿</th>
  <th>è¿è¡Œå·¥å…·</th>
  <th>å˜åŒ–</th>
  <th>åˆ†æ</th>
</tr>
</thead>
<tbody>
<tr>
  <td>CPU ä½¿ç”¨ç‡ (avg)</td>
  <td>-</td>
  <td>0.59%</td>
  <td>+0.59%</td>
  <td>æä½å¼€é”€</td>
</tr>
<tr>
  <td>CPU ä½¿ç”¨ç‡ (å³°å€¼)</td>
  <td>-</td>
  <td>4.0%</td>
  <td>+4.0%</td>
  <td>å³°å€¼ä»ç„¶å¾ˆä½</td>
</tr>
<tr>
  <td>å»¶è¿Ÿå½±å“</td>
  <td>åŸºçº¿</td>
  <td>-6.9%</td>
  <td>æå‡ 6.9%</td>
  <td>æ€§èƒ½è½»å¾®æå‡(è¯¯å·®èŒƒå›´)</td>
</tr>
<tr>
  <td>ååé‡å½±å“</td>
  <td>åŸºçº¿</td>
  <td>-0.33%</td>
  <td>-0.33%</td>
  <td>å‡ ä¹æ— å½±å“</td>
</tr>
</tbody>
</table>

<p><strong>ç»“è®º</strong>: Summary å·¥å…·é‡‡ç”¨å†…æ ¸ä¾§èšåˆç­–ç•¥,ä»…å®šæœŸæäº¤ç»Ÿè®¡æ•°æ®è€Œéæ¯åŒ…æäº¤,å› æ­¤æ€§èƒ½å¼€é”€æå°,å¯æŒç»­è¿è¡Œã€‚</p>

<h4 id="2-details-å·¥å…·æœ€åæƒ…å†µ-å¤§æµé‡ä¸”æ‰€æœ‰åŒ…èµ°å®Œæ•´è·¯å¾„å¹¶æäº¤ç”¨æˆ·æ€">2. Details å·¥å…·æœ€åæƒ…å†µ: å¤§æµé‡ä¸”æ‰€æœ‰åŒ…èµ°å®Œæ•´è·¯å¾„å¹¶æäº¤ç”¨æˆ·æ€</h4>

<p><strong>å·¥å…·</strong>: trace_conntrack.py (æ— è¿‡æ»¤å™¨)</p>

<p>æµ‹è¯•æ¡ä»¶:</p>

<ul>
<li>æµé‡ç±»å‹: TCP RX</li>
<li>æ‰€æœ‰åŒ…éƒ½æ‰§è¡Œå®Œæ•´ eBPF æµ‹é‡é€»è¾‘</li>
<li>æ‰€æœ‰åŒ…éƒ½æäº¤åˆ°ç”¨æˆ·æ€</li>
</ul>

<p>æµ‹è¯•ç»“æœ:</p>

<table>
<thead>
<tr>
  <th>æŒ‡æ ‡</th>
  <th>æ— å·¥å…·åŸºçº¿</th>
  <th>è¿è¡Œå·¥å…·</th>
  <th>å˜åŒ–</th>
  <th>åˆ†æ</th>
</tr>
</thead>
<tbody>
<tr>
  <td>å»¶è¿Ÿå½±å“</td>
  <td>82.31 us</td>
  <td>139.46 us</td>
  <td>+69.46%</td>
  <td>æ˜¾è‘—å»¶è¿Ÿå¢åŠ </td>
</tr>
<tr>
  <td>ååé‡å½±å“</td>
  <td>åŸºçº¿</td>
  <td>åŸºçº¿</td>
  <td>-35.19%</td>
  <td>ååé‡å¤§å¹…ä¸‹é™</td>
</tr>
</tbody>
</table>

<p><strong>ç»“è®º</strong>: åœ¨æœ€åæƒ…å†µä¸‹(æ‰€æœ‰åŒ…éƒ½èµ°å®Œæ•´é€»è¾‘å¹¶æäº¤ç”¨æˆ·æ€),Details å·¥å…·å¯¹ workload çš„æ€§èƒ½å½±å“æœ€å¤§ã€‚è¿™ç§åœºæ™¯åº”é¿å…åœ¨ç”Ÿäº§ç¯å¢ƒé•¿æœŸè¿è¡Œã€‚</p>

<h4 id="3-è¿‡æ»¤å™¨çµæ´»æ§åˆ¶-ebpf-ç¨‹åºå¼€é”€åŠå¯¹-workload-çš„å½±å“">3. è¿‡æ»¤å™¨çµæ´»æ§åˆ¶ eBPF ç¨‹åºå¼€é”€åŠå¯¹ workload çš„å½±å“</h4>

<p><strong>å·¥å…·</strong>: eth_drop.py / system_network_latency_details.py (å¸¦è¿‡æ»¤å™¨)</p>

<p><strong>è¿‡æ»¤ç­–ç•¥å¯¹æ¯”</strong>:</p>

<table>
<thead>
<tr>
  <th>è¿‡æ»¤æ¡ä»¶</th>
  <th>äº‹ä»¶æäº¤ç‡</th>
  <th>CPU å¼€é”€ä¼°ç®—</th>
  <th>å¯¹ä¸šåŠ¡å½±å“</th>
  <th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
  <td>æ— è¿‡æ»¤ (1M PPS)</td>
  <td>1M evt/s</td>
  <td>~50% CPU</td>
  <td>é«˜ (30%+)</td>
  <td>ç¦æ­¢ä½¿ç”¨</td>
</tr>
<tr>
  <td>IP è¿‡æ»¤ (ç‰¹å®šæº/ç›®æ ‡)</td>
  <td>~10K evt/s</td>
  <td>~5% CPU</td>
  <td>ä¸­ (5-10%)</td>
  <td>çŸ­æœŸè¯Šæ–­</td>
</tr>
<tr>
  <td>äº”å…ƒç»„è¿‡æ»¤</td>
  <td>~1K evt/s</td>
  <td>~0.5% CPU</td>
  <td>ä½ (&lt;2%)</td>
  <td>é’ˆå¯¹æ€§è¿½è¸ª</td>
</tr>
<tr>
  <td>äº”å…ƒç»„ + å»¶è¿Ÿé˜ˆå€¼ (&gt;100ms)</td>
  <td>~100 evt/s</td>
  <td>&lt;0.1% CPU</td>
  <td>æä½</td>
  <td>å¼‚å¸¸äº‹ä»¶æ•è·</td>
</tr>
</tbody>
</table>

<p><strong>ç¤ºä¾‹</strong>: system_network_latency_details.py --threshold 100000 (100ms)</p>

<pre><code># åªæ•è·å»¶è¿Ÿè¶…è¿‡ 100ms çš„å¼‚å¸¸äº‹ä»¶
sudo python3 system_network_latency_details.py \
  --phy-interface ens11 \
  --src-ip 10.132.114.11 \
  --dst-ip 10.132.114.12 \
  --direction rx \
  --protocol icmp \
  --latency-threshold 100000  # 100ms in microseconds
</code></pre>

<p><strong>è¿‡æ»¤æœºåˆ¶åŸç†</strong>:</p>

<ul>
<li>åœ¨å†…æ ¸æ€å°½æ—©è¿‡æ»¤,é¿å…æ— æ•ˆæ•°æ®æäº¤</li>
<li>åè®®è¿‡æ»¤ â†’ IP è¿‡æ»¤ â†’ ç«¯å£è¿‡æ»¤ â†’ é˜ˆå€¼è¿‡æ»¤</li>
<li>åªæœ‰é€šè¿‡æ‰€æœ‰è¿‡æ»¤å™¨çš„åŒ…æ‰ä¼šæäº¤åˆ°ç”¨æˆ·æ€</li>
<li>ç»å¤§å¤šæ•°åŒ…åœ¨æµ‹é‡é€»è¾‘ä¸­æå‰è¿”å›</li>
</ul>

<p><strong>ç»“è®º</strong>: é€šè¿‡åˆç†é…ç½®è¿‡æ»¤æ¡ä»¶,Details å·¥å…·çš„èµ„æºå ç”¨å’Œå¯¹ä¸šåŠ¡çš„å½±å“å¯çµæ´»è°ƒèŠ‚,ä»è€Œåœ¨ç²¾åº¦å’Œå¼€é”€ä¹‹é—´å–å¾—å¹³è¡¡ã€‚</p>

<h4 id="4-å¤šé˜¶æ®µæ•´åˆæäº¤é…åˆè¿‡æ»¤æ¡ä»¶é˜ˆå€¼è¿›ä¸€æ­¥è°ƒèŠ‚å¼€é”€">4. å¤šé˜¶æ®µæ•´åˆæäº¤é…åˆè¿‡æ»¤æ¡ä»¶/é˜ˆå€¼,è¿›ä¸€æ­¥è°ƒèŠ‚å¼€é”€</h4>

<p><strong>å·¥å…·</strong>: system_network_performance_metrics.py / vm_network_performance_metrics.py</p>

<p><strong>å¤šé˜¶æ®µæ•´åˆç­–ç•¥</strong>:</p>

<ol>
<li>åœ¨å¤šä¸ª probe ç‚¹æ”¶é›†æ•°æ® (6-8 ä¸ªå…³é”®ç‚¹)</li>
<li>é€šè¿‡ skb æŒ‡é’ˆå…³è”ä¸åŒé˜¶æ®µ</li>
<li>åœ¨æœ€åé˜¶æ®µæ•´åˆæ‰€æœ‰ä¿¡æ¯</li>
<li>ä»…æäº¤ä¸€æ¬¡å®Œæ•´äº‹ä»¶ (è€Œéæ¯ä¸ªé˜¶æ®µéƒ½æäº¤)</li>
</ol>

<p><strong>æ•ˆæœå¯¹æ¯”</strong>:</p>

<table>
<thead>
<tr>
  <th>ç­–ç•¥</th>
  <th>Probe ç‚¹æ•°</th>
  <th>æäº¤æ¬¡æ•°/åŒ…</th>
  <th>CPU å¼€é”€</th>
  <th>æ•°æ®å®Œæ•´æ€§</th>
</tr>
</thead>
<tbody>
<tr>
  <td>æ¯ä¸ª probe éƒ½æäº¤</td>
  <td>6</td>
  <td>6 æ¬¡</td>
  <td>é«˜ (20%+)</td>
  <td>å®Œæ•´</td>
</tr>
<tr>
  <td>å¤šé˜¶æ®µæ•´åˆæäº¤</td>
  <td>6</td>
  <td>1 æ¬¡</td>
  <td>ä½ (&lt;5%)</td>
  <td>å®Œæ•´</td>
</tr>
</tbody>
</table>

<p><strong>é…åˆé˜ˆå€¼è¿‡æ»¤çš„å¢å¼ºæ•ˆæœ</strong>:</p>

<pre><code>// ä»…åœ¨æœ€åé˜¶æ®µæ£€æŸ¥é˜ˆå€¼
if (total_latency &lt; THRESHOLD) {
    // æ¸…ç†ä¸­é—´çŠ¶æ€
    delete_intermediate_data();
    return 0;  // ä¸æäº¤
}

// è¶…è¿‡é˜ˆå€¼æ‰æäº¤å®Œæ•´è·¯å¾„ä¿¡æ¯
submit_complete_event();
</code></pre>

<p><strong>å®é™…æ•ˆæœ</strong>:</p>

<ul>
<li>æ­£å¸¸å»¶è¿Ÿçš„åŒ… (99%+): å®Œå…¨ä¸æäº¤,ä»…æ¸…ç†çŠ¶æ€</li>
<li>å¼‚å¸¸å»¶è¿Ÿçš„åŒ… (&lt;1%): æäº¤å®Œæ•´è·¯å¾„ä¿¡æ¯</li>
<li>CPU å¼€é”€é™ä½ 99%,åŒæ—¶ä¿ç•™å®Œæ•´è¯Šæ–­èƒ½åŠ›</li>
</ul>

<p><strong>ç»“è®º</strong>: å¤šé˜¶æ®µæ•´åˆæäº¤æ˜¯ Details å·¥å…·åœ¨ä¿æŒç²¾ç¡®æµ‹é‡èƒ½åŠ›çš„åŒæ—¶æ§åˆ¶æ€§èƒ½å¼€é”€çš„å…³é”®æŠ€æœ¯ã€‚é…åˆè¿‡æ»¤æ¡ä»¶å’Œé˜ˆå€¼,å¯ä»¥å°†å·¥å…·å¼€é”€é™è‡³æä½æ°´å¹³ã€‚</p>

<hr />

<h2 id="6-demo-æ¼”ç¤º">6. Demo æ¼”ç¤º</h2>

<h3 id="61-demo-æ¦‚è¿°">6.1 Demo æ¦‚è¿°</h3>

<p>æœ¬èŠ‚æ¼”ç¤ºä¸‰ä¸ªå•å·¥å…·çš„å…¸å‹ä½¿ç”¨åœºæ™¯,æ¯ä¸ªå·¥å…·çº¦ 3-5 åˆ†é’Ÿ:</p>

<ol>
<li>kernel_drop_stack_stats_summary_all.py - ä¸¢åŒ…åˆ†æ</li>
<li>system_network_latency_summary.py - å»¶è¿Ÿåˆ†æ</li>
<li>ovs_userspace_megaflow.py - OVS Megaflow è¿½è¸ª</li>
</ol>

<h3 id="62-æ¼”ç¤ºè„šæœ¬">6.2 æ¼”ç¤ºè„šæœ¬</h3>

<h4 id="demo-1-ä¸¢åŒ…å®šä½-3-åˆ†é’Ÿ">Demo 1: ä¸¢åŒ…å®šä½ (3 åˆ†é’Ÿ)</h4>

<p><strong>åœºæ™¯</strong>: å¿«é€Ÿå®šä½å†…æ ¸ä¸¢åŒ…ä½ç½®</p>

<pre><code># 1. å¯åŠ¨ä¸¢åŒ…ç›‘æ§ (Summary æ¨¡å¼)
sudo python3 ebpf-tools/linux-network-stack/packet-drop/\
kernel_drop_stack_stats_summary_all.py \
  --src-ip 10.0.0.1 \
  --dst-ip 10.0.0.2 \
  --l4-protocol icmp \
  --interval 30 \
  --top 5

# 2. ç”Ÿæˆæµé‡
ping -c 100 10.0.0.2

# é¢„æœŸè¾“å‡º:
# === Drop Stack Statistics ===
# Found X unique stack combinations:
#
# #1 Count: 15 [device: br-int]
#    Flow: 10.0.0.1 -&gt; 10.0.0.2 (ICMP)
#    Stack:
#      kfree_skb
#      ip_rcv_core  â† ä¸¢åŒ…ä½ç½®
#      __netif_receive_skb_core
#
# åˆ†æ: IP å±‚ä¸¢åŒ…,å¯èƒ½æ˜¯ TTL æˆ–è·¯ç”±é—®é¢˜

# 3. æ¼”è®²è¦ç‚¹:
# â€¢ è‡ªåŠ¨èšåˆç›¸åŒæ ˆçš„ä¸¢åŒ…
# â€¢ ç²¾ç¡®å®šä½åˆ°å†…æ ¸å‡½æ•°
# â€¢ å…³è”ç½‘ç»œæµä¿¡æ¯
# â€¢ ä½å¼€é”€,å¯æŒç»­è¿è¡Œ
</code></pre>

<p><strong>æ¼”ç¤ºè¦ç‚¹</strong>:</p>

<ul>
<li>è‡ªåŠ¨æ ˆèšåˆ,æŒ‰è°ƒç”¨æ ˆåˆ†ç±»</li>
<li>ç²¾ç¡®åˆ°å†…æ ¸å‡½æ•°çº§åˆ«</li>
<li>æµä¿¡æ¯å…³è” (äº”å…ƒç»„)</li>
<li>æä½æ€§èƒ½å¼€é”€</li>
</ul>

<h4 id="demo-2-ç½‘ç»œå»¶è¿Ÿåˆ†æ-3-åˆ†é’Ÿ">Demo 2: ç½‘ç»œå»¶è¿Ÿåˆ†æ (3 åˆ†é’Ÿ)</h4>

<p><strong>åœºæ™¯</strong>: è¯†åˆ«ç½‘ç»œå»¶è¿Ÿåˆ†å¸ƒå’Œé•¿å°¾</p>

<pre><code># 1. å¯åŠ¨å»¶è¿Ÿç›‘æ§ (Summary)
sudo python3 ebpf-tools/performance/system-network/\
system_network_latency_summary.py \
  --phy-interface ens11 \
  --direction rx \
  --protocol icmp \
  --interval 30

# 2. ç”Ÿæˆæ­£å¸¸æµé‡
ping -i 0.1 10.0.0.2  # 10 PPS

# é¢„æœŸè¾“å‡º (æ­£å¸¸æƒ…å†µ):
# Stage: INTERNAL_RX â†’ FLOW_EXTRACT_END_RX
#      latency (us)    : count    distribution
#         0 -&gt; 1       :   12    |****                |
#         2 -&gt; 3       :   45    |***************     |
#         4 -&gt; 7       :   78    |****************************|
#         8 -&gt; 15      :   65    |**********************  |  â† P50
#        16 -&gt; 31      :   23    |********            |
#        32 -&gt; 63      :   5     |*                   |
#
# Total packets: 228
# P50: ~10us, P95: ~40us, P99: ~60us

# 3. æ¨¡æ‹Ÿå¼‚å¸¸ (å¯é€‰,å¦‚æœç¯å¢ƒå…è®¸)
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯åˆ¶é€  OVS CPU å‹åŠ›:
stress-ng --cpu 4 --timeout 10s

# é¢„æœŸè¾“å‡º (å¼‚å¸¸æƒ…å†µ):
# (histogram ä¸­å‡ºç°é•¿å°¾)
#     1024 -&gt; 2047    :   2     |                   |
#     2048 -&gt; 4095    :   1     |                   |  â† å¼‚å¸¸å»¶è¿Ÿ!
#
# Packets with latency &gt; 1ms: 3 packets

# 4. æ¼”è®²è¦ç‚¹:
# â€¢ Histogram ç›´è§‚å±•ç¤ºå»¶è¿Ÿåˆ†å¸ƒ
# â€¢ å¯æ¸…æ™°è¯†åˆ« P50/P95/P99
# â€¢ é•¿å°¾å»¶è¿Ÿä¸€ç›®äº†ç„¶
# â€¢ åˆ†é˜¶æ®µæµ‹é‡,å®šä½ç“¶é¢ˆåœ¨ OVS å±‚
</code></pre>

<p><strong>æ¼”ç¤ºè¦ç‚¹</strong>:</p>

<ul>
<li>Histogram å¯è§†åŒ–,ç›´è§‚æ˜“æ‡‚</li>
<li>è‡ªåŠ¨è®¡ç®— P50/P95/P99</li>
<li>é•¿å°¾å»¶è¿Ÿè¯†åˆ«</li>
<li>åˆ†é˜¶æ®µæµ‹é‡,ç²¾ç¡®å®šä½ç“¶é¢ˆ</li>
</ul>

<h4 id="demo-3-ovs-megaflow-è¿½è¸ª-3-åˆ†é’Ÿ">Demo 3: OVS Megaflow è¿½è¸ª (3 åˆ†é’Ÿ)</h4>

<p><strong>åœºæ™¯</strong>: å±•ç¤º OVS å†…éƒ¨å·¥ä½œåŸç†çš„å¯è§‚æµ‹æ€§</p>

<pre><code># 1. æ¸…ç©º OVS æµè¡¨ (åˆ¶é€  upcall)
sudo ovs-appctl dpctl/del-flows

# 2. å¯åŠ¨ Megaflow è¿½è¸ª
sudo python3 ebpf-tools/ovs/ovs_userspace_megaflow.py \
  --ip-src 10.0.0.1 \
  --ip-dst 10.0.0.2 \
  --ip-proto 1

# 3. è§¦å‘æµé‡
ping -c 3 10.0.0.2

# é¢„æœŸè¾“å‡º:
# === UPCALL Event ===
# Time: [æ—¶é—´]
# Flow: 10.0.0.1 -&gt; 10.0.0.2 (ICMP)
#
# === FLOW_CMD_NEW Event ===
# Time: [æ—¶é—´ + æ•°ç™¾å¾®ç§’]
# Flow Key:
#   ipv4_src: 10.0.0.1
#   ipv4_dst: 10.0.0.2
#   ip_proto: 1
# Actions:
#   output: port 5
#
# Installation Latency: 234 us

# 4. æ¼”è®²è¦ç‚¹:
# â€¢ å®Œæ•´è¿½è¸ª Megaflow ç”Ÿå‘½å‘¨æœŸ
# â€¢ Upcall â†’ Userspace å†³ç­– â†’ å†…æ ¸å®‰è£…
# â€¢ æµ‹é‡ Installation Latency
# â€¢ å¯ç”¨äºè¯Šæ–­ OVS æ€§èƒ½é—®é¢˜
</code></pre>

<p><strong>æ¼”ç¤ºè¦ç‚¹</strong>:</p>

<ul>
<li>é»‘ç›’ç³»ç»Ÿ (OVS) çš„å†…éƒ¨å¯è§‚æµ‹æ€§</li>
<li>Netlink æ¶ˆæ¯å®Œæ•´è§£æ</li>
<li>å»¶è¿Ÿç²¾ç¡®æµ‹é‡ (å¾®ç§’çº§)</li>
<li>å¯ç”¨äºæµè¡¨ç­–ç•¥åˆ†æ</li>
</ul>

<h3 id="63-demo-æ€»ç»“è¦ç‚¹">6.3 Demo æ€»ç»“è¦ç‚¹</h3>

<p><strong>å‘å†³ç­–è€…å¼ºè°ƒ</strong>:</p>

<ol>
<li><p><strong>å¿«é€Ÿå®šä½</strong> â±ï¸</p>

<ul>
<li>ä¼ ç»Ÿæ–¹æ³•: æ•°å°æ—¶ - æ•°å¤© (ç»„åˆå¤šå·¥å…· + æ‰‹åŠ¨åˆ†æ)</li>
<li>æœ¬å·¥å…·é›†: åˆ†é’Ÿ - å°æ—¶ (ç»“æ„åŒ–è¾“å‡º + è‡ªåŠ¨å…³è”)</li>
<li><strong>æ•ˆç‡æå‡ 10-100 å€</strong></li>
</ul></li>
<li><p><strong>ç²¾ç¡®æµ‹é‡</strong> ğŸ“Š</p>

<ul>
<li>ä¼ ç»Ÿç›‘æ§: é»‘ç›’,åªèƒ½çœ‹åˆ°å®è§‚æŒ‡æ ‡</li>
<li>æœ¬å·¥å…·é›†: ç™½ç›’,ç²¾ç¡®æµ‹é‡æ¯ä¸ªé˜¶æ®µè€—æ—¶ (çº³ç§’çº§)</li>
<li><strong>ä»"çŒœæµ‹"åˆ°"é‡åŒ–"</strong></li>
</ul></li>
<li><p><strong>å®‰å…¨å¯æ§</strong> ğŸ›¡ï¸</p>

<ul>
<li>eBPF æ²™ç®±æœºåˆ¶,ä¸ä¼šå´©æºƒå†…æ ¸</li>
<li>Summary å·¥å…·æ€§èƒ½å½±å“æå°,å¯æŒç»­è¿è¡Œ</li>
<li>Details å·¥å…·é€šè¿‡è¿‡æ»¤å™¨çµæ´»æ§åˆ¶å½±å“</li>
<li><strong>ç”Ÿäº§ç¯å¢ƒå¯ç”¨</strong></li>
</ul></li>
<li><p><strong>è¦†ç›–å…¨é¢</strong> ğŸŒ</p>

<ul>
<li>30+ å·¥å…·è¦†ç›–è™šæ‹ŸåŒ–ç½‘ç»œå…¨é“¾è·¯</li>
<li>ä¸¢åŒ…/å»¶è¿Ÿ/OVS/è™šæ‹ŸåŒ–/CPU å…¨æ–¹ä½</li>
<li>Summary + Details åŒç‰ˆæœ¬ç­–ç•¥</li>
<li><strong>ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆ</strong></li>
</ul></li>
<li><p><strong>æ˜“äºä½¿ç”¨</strong> ğŸš€</p>

<ul>
<li>å‚æ•°ç®€å•ç›´è§‚ (IP/ç«¯å£/åè®®è¿‡æ»¤)</li>
<li>è¾“å‡ºæ¸…æ™° (Histogram + è¯¦ç»†äº‹ä»¶)</li>
<li>å¼€ç®±å³ç”¨,æ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç </li>
<li><strong>é™ä½è¿ç»´é—¨æ§›</strong></li>
</ul></li>
</ol>

<hr />

<h2 id="7-ç»“è®º">7. ç»“è®º</h2>

<h3 id="71-æ ¸å¿ƒæˆæœ">7.1 æ ¸å¿ƒæˆæœ</h3>

<p>æœ¬é¡¹ç›®æˆåŠŸæ„å»ºäº†ä¸€å¥— <strong>è½»é‡ã€ç²¾ç¡®ã€æ˜“ç”¨</strong> çš„ eBPF ç½‘ç»œæ•…éšœæ’æŸ¥å·¥å…·é›†:</p>

<p><strong>æ ¸å¿ƒåˆ›æ–°ç‚¹</strong>:</p>

<ol>
<li><p><strong>ä¸‰å±‚è¯Šæ–­æ¨¡å‹</strong></p>

<ul>
<li>Summary (é•¿æœŸç›‘æ§) + Details (ç²¾ç¡®è¿½è¸ª) + ä¸“é¡¹å·¥å…· (æ ¹å› åˆ†æ)</li>
<li>å¹³è¡¡æ€§èƒ½å¼€é”€ä¸ç›‘æ§ç²¾åº¦</li>
</ul></li>
<li><p><strong>æ€§èƒ½å¼€é”€å¯æ§</strong></p>

<ul>
<li>åŸºäº eBPF æ€§èƒ½æ¨¡å‹çš„å·¥ç¨‹åŒ–å®è·µ</li>
<li>Summary: æä½å¼€é”€,å¯¹ä¸šåŠ¡æ€§èƒ½å½±å“æå°</li>
<li>Details: é€šè¿‡å¤šçº§è¿‡æ»¤å’Œå¤šé˜¶æ®µæ•´åˆ,èµ„æºå ç”¨çµæ´»å¯è°ƒ</li>
<li>è¿‡æ»¤å™¨ä½¿ç»å¤§å¤šæ•°åŒ…åœ¨æµ‹é‡é€»è¾‘ä¸­æå‰è¿”å›</li>
</ul></li>
<li><p><strong>å…¨é“¾è·¯è¦†ç›–</strong></p>

<ul>
<li>VM â†’ vhost â†’ TUN/TAP â†’ OVS â†’ Linux æ ˆ â†’ ç‰©ç†ç½‘å¡</li>
<li>30+ å·¥å…·,æŒ‰å±‚æ¬¡ã€æŒ‰é—®é¢˜åˆ†ç±»</li>
</ul></li>
<li><p><strong>ç²¾ç¡®æµ‹é‡</strong></p>

<ul>
<li>åˆ†é˜¶æ®µå»¶è¿Ÿæµ‹é‡ (çº³ç§’çº§)</li>
<li>skb æŒ‡é’ˆå…³è”,è·¨å±‚è¿½è¸ª</li>
<li>æ—¶é—´æˆ³ + è°ƒç”¨æ ˆ,å®Œæ•´ä¸Šä¸‹æ–‡</li>
</ul></li>
<li><p><strong>å®æˆ˜éªŒè¯</strong></p>

<ul>
<li>æ¡ˆä¾‹ 1: ICMP "ä¸¢åŒ…"æ ¹å›  (å»¶è¿Ÿè¯¯åˆ¤ â†’ OVS é”ç«äº‰)</li>
<li>æ€§èƒ½æµ‹è¯•: Summary å·¥å…·å¯æŒç»­è¿è¡Œ,Details å·¥å…·å¼€é”€å¯è°ƒèŠ‚</li>
</ul></li>
</ol>

<p><strong>åº”ç”¨ä»·å€¼</strong>:</p>

<ul>
<li><strong>é™ä½ MTTR</strong>: ä»æ•°å°æ—¶é™è‡³åˆ†é’Ÿçº§</li>
<li><strong>é‡åŒ–ç½‘ç»œæ€§èƒ½</strong>: å»ºç«‹å„å±‚æ¬¡æ€§èƒ½åŸºçº¿,ç²¾ç¡®å®šä½ç“¶é¢ˆ</li>
<li><strong>é™ä½è¿ç»´æˆæœ¬</strong>: è‡ªåŠ¨åŒ–æ•…éšœå®šä½,å‡å°‘å¯¹ä¸“å®¶ä¾èµ–</li>
<li><strong>èµ‹èƒ½æŠ€æœ¯å›¢é˜Ÿ</strong>: æ·±å…¥ç†è§£è™šæ‹ŸåŒ–ç½‘ç»œ,æå‡æŠ€æœ¯èƒ½åŠ›</li>
</ul>

<p><strong>ä»"æ— æ³•è§‚æµ‹"åˆ°"ç²¾ç¡®æµ‹é‡"</strong><br />
<strong>ä»"ç»éªŒçŒœæµ‹"åˆ°"æ•°æ®é©±åŠ¨"</strong><br />
<strong>ä»"äº‹åæ•‘ç«"åˆ°"ä¸»åŠ¨ç›‘æ§"</strong></p>

<p><strong>eBPF: è®©ç½‘ç»œæ•…éšœæ’æŸ¥è¿›å…¥"å¯è§‚æµ‹æ—¶ä»£"</strong> ğŸš€</p>

<hr />

<h2 id="é™„å½•">é™„å½•</h2>

<h3 id="a-å‚è€ƒèµ„æ–™">A. å‚è€ƒèµ„æ–™</h3>

<ol>
<li><p><strong>é¡¹ç›®æ–‡æ¡£</strong>:</p>

<ul>
<li><code>troubleshooting-practice.md</code> - å®æˆ˜æ¡ˆä¾‹è¯¦è§£</li>
<li><code>docs/BCC_eBPF_Performance_Analysis.md</code> - æ€§èƒ½å¼€é”€æ¨¡å‹</li>
<li><code>test/automate-performance-test/analysis/</code> - æ€§èƒ½æµ‹è¯•æ•°æ®ä¸åˆ†æ</li>
</ul></li>
<li><p><strong>eBPF å­¦ä¹ èµ„æº</strong>:</p>

<ul>
<li>Brendan Gregg, "BPF Performance Tools" (2019)</li>
<li>Linux å†…æ ¸æ–‡æ¡£: https://www.kernel.org/doc/html/latest/bpf/</li>
<li>BCC GitHub: https://github.com/iovisor/bcc</li>
</ul></li>
<li><p><strong>è™šæ‹ŸåŒ–ç½‘ç»œ</strong>:</p>

<ul>
<li>OVS æ–‡æ¡£: https://www.openvswitch.org/</li>
<li>KVM/QEMU è™šæ‹ŸåŒ–: https://www.linux-kvm.org/</li>
</ul></li>
</ol>

<h3 id="b-å¿«é€Ÿå‚è€ƒå¡ç‰‡">B. å¿«é€Ÿå‚è€ƒå¡ç‰‡</h3>

<p><strong>ä¸¢åŒ…é—®é¢˜æ’æŸ¥</strong>:</p>

<pre><code># 1. å®šä½ä¸¢åŒ…ä½ç½® (Summary)
sudo python3 kernel_drop_stack_stats_summary_all.py \
  --src-ip &lt;IP&gt; --dst-ip &lt;IP&gt; --interval 60

# 2. æŸ¥çœ‹å…·ä½“ä¸¢åŒ…åŒ… (Details)
sudo python3 eth_drop.py \
  --src-ip &lt;IP&gt; --dst-ip &lt;IP&gt; --verbose
</code></pre>

<p><strong>å»¶è¿Ÿé—®é¢˜æ’æŸ¥</strong>:</p>

<pre><code># 1. å»¶è¿Ÿåˆ†å¸ƒ (Summary)
sudo python3 system_network_latency_summary.py \
  --phy-interface &lt;IF&gt; --direction rx --interval 60

# 2. é«˜å»¶è¿Ÿäº‹ä»¶ (Details + é˜ˆå€¼)
sudo python3 system_network_latency_details.py \
  --phy-interface &lt;IF&gt; --direction rx \
  --latency-threshold 100000  # 100ms
</code></pre>

<p><strong>OVS é—®é¢˜æ’æŸ¥</strong>:</p>

<pre><code># 1. Upcall å»¶è¿Ÿ (Summary)
sudo python3 ovs_upcall_latency_summary.py --interval 60

# 2. Megaflow ç”Ÿå‘½å‘¨æœŸ (Details)
sudo python3 ovs_userspace_megaflow.py \
  --ip-src &lt;IP&gt; --ip-dst &lt;IP&gt;
</code></pre>

<hr />

<p><strong>æŠ¥å‘Šç»“æŸ</strong></p>

    </body>
    </html>
    