# eBPF ç½‘ç»œæ•…éšœæ’æŸ¥å·¥å…· - å®æˆ˜ä½¿ç”¨æŒ‡å—

## æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£æ˜¯åŸºäº eBPF çš„ç½‘ç»œæ•…éšœæ’æŸ¥å·¥å…·é›†çš„å®æˆ˜ä½¿ç”¨æŒ‡å—,åŒ…å«:

1. **åˆ†ææ–¹æ³•è®º**: ä¸‰å±‚è¯Šæ–­æ¨¡å‹çš„ç†è®ºåŸºç¡€å’Œæ€§èƒ½è€ƒé‡
2. **å•å·¥å…·ä½¿ç”¨æŒ‡å—**: å¸¸ç”¨å·¥å…·çš„åŠŸèƒ½è¯´æ˜ã€ä½¿ç”¨åœºæ™¯å’Œè¾“å‡ºè§£è¯»
3. **å¤æ‚é—®é¢˜å®æˆ˜æ¡ˆä¾‹**: å¤šå·¥å…·ç»„åˆã€åˆ†å±‚è¯Šæ–­çš„å®Œæ•´æµç¨‹

é€‚ç”¨äºè™šæ‹ŸåŒ–ç¯å¢ƒ(KVM/QEMU + Open vSwitch)çš„ç½‘ç»œæ€§èƒ½åˆ†æå’Œæ•…éšœå®šä½ã€‚

---

## ç¬¬ä¸€éƒ¨åˆ†: åˆ†ææ–¹æ³•

### ä¸‰å±‚è¯Šæ–­æ¨¡å‹

eBPF ç½‘ç»œæ•…éšœæ’æŸ¥éµå¾ª**ä»ç²—åˆ°ç»†ã€é€å±‚æ·±å…¥**çš„è¯Šæ–­åŸåˆ™:

```
  ç¬¬ä¸€å±‚: é—®é¢˜å®šä½ (Summary å·¥å…·)                         
  â”œâ”€ ä½¿ç”¨ Histogram ç»Ÿè®¡å¿«é€Ÿè¯†åˆ«å¼‚å¸¸èŒƒå›´                  
  â”œâ”€ ä½æ€§èƒ½å¼€é”€,å¯é•¿æœŸè¿è¡Œ                                
  â””â”€ è¾“å‡º: å»¶è¿Ÿåˆ†å¸ƒ/ä¸¢åŒ…ç»Ÿè®¡/æµè¡¨å‘½ä¸­ç‡ç­‰å®è§‚æŒ‡æ ‡          
                        â†“                                 
  ç¬¬äºŒå±‚: ç²¾ç¡®è¿½è¸ª (Details å·¥å…·)                         
  â”œâ”€ Per-packet è·Ÿè¸ªå®šä½å…·ä½“ç“¶é¢ˆ                          
  â”œâ”€ ä¸­ç­‰å¼€é”€,éœ€é…åˆè¿‡æ»¤å™¨ä½¿ç”¨                            
  â””â”€ è¾“å‡º: å•åŒ…å®Œæ•´è·¯å¾„ã€æ—¶é—´æˆ³ã€å¤„ç†å»¶è¿Ÿ                  
                        â†“                                 
  ç¬¬ä¸‰å±‚: æ ¹å› åˆ†æ (ä¸“é¡¹å·¥å…· + ç³»ç»Ÿå·¥å…·)                   
  â”œâ”€ é’ˆå¯¹æ€§æ·±åº¦åˆ†æ (CPU/é”/é˜Ÿåˆ—/å†…å­˜)                    
  â”œâ”€ è¾ƒé«˜å¼€é”€,çŸ­æœŸä½¿ç”¨                                    
  â””â”€ è¾“å‡º: Off-CPU æ—¶é—´/é”ç«äº‰/è°ƒåº¦å¼€é”€ç­‰åº•å±‚æŒ‡æ ‡         
```

### ä¸ºä»€ä¹ˆé‡‡ç”¨ä¸‰å±‚æ¨¡å‹?

**æ ¸å¿ƒåŸå› : eBPF æ€§èƒ½å¼€é”€ä¸ç›‘æ§ç²’åº¦çš„æƒè¡¡**

#### 1. eBPF ç¨‹åºçš„æ€§èƒ½å¼€é”€å› ç´ 

eBPF ç¨‹åºçš„æ€§èƒ½å¼€é”€ä¸»è¦æ¥è‡ªä»¥ä¸‹å‡ ä¸ªæ–¹é¢:

| å¼€é”€æ¥æº | å½±å“ç¨‹åº¦ | è¯´æ˜ |
|---------|---------|------|
| **Probe ç±»å‹** | é«˜ | kprobe > tracepoint > raw_tracepoint |
| **æ•°æ®é‡‡é›†é‡** | é«˜ | æ¯åŒ…è¯¦ç»†ä¿¡æ¯ > èšåˆç»Ÿè®¡ |
| **å†…å­˜æ“ä½œ** | ä¸­ | Hash æŸ¥è¯¢/æ›´æ–°ã€æ ˆè·Ÿè¸ª |
| **è¿‡æ»¤é€»è¾‘** | ä¸­ | å¤æ‚è¿‡æ»¤æ¡ä»¶å¢åŠ  CPU æ¶ˆè€— |
| **ä¸Šä¸‹æ–‡åˆ‡æ¢** | ä½ | perf_output åˆ°ç”¨æˆ·æ€ |

**å…¸å‹å¼€é”€å¯¹æ¯”** (ä»¥ 10Gbps ç½‘ç»œæµé‡ä¸ºåŸºå‡†):

- **Summary å·¥å…·** (Histogram èšåˆ):
  - æ•°æ®ç»“æ„: BPF_HISTOGRAM (å†…æ ¸èšåˆ,æ—  perf_output)
  - CPU å¼€é”€: < 5% å•æ ¸
  - å†…å­˜: æ•° KB (å›ºå®šå¤§å° histogram)
  - é€‚ç”¨åœºæ™¯: é•¿æœŸç›‘æ§ã€åŸºçº¿å»ºç«‹

- **Details å·¥å…·** (Per-packet è·Ÿè¸ª):
  - æ•°æ®ç»“æ„: BPF_PERF_OUTPUT (æ¯åŒ…è¾“å‡ºåˆ°ç”¨æˆ·æ€)
  - CPU å¼€é”€: 10-30% å•æ ¸ (å–å†³äºè¿‡æ»¤ç²’åº¦)
  - å†…å­˜: æ•°å MB (ç¯å½¢ç¼“å†²åŒº)
  - é€‚ç”¨åœºæ™¯: é—®é¢˜å¤ç°æ—¶çŸ­æœŸæŠ“å–

- **ä¸“é¡¹å·¥å…·** (æ ˆè·Ÿè¸ª/é”åˆ†æ):
  - æ•°æ®ç»“æ„: BPF_STACK_TRACE + å¤šè¡¨å…³è”
  - CPU å¼€é”€: 15-40% å•æ ¸
  - å†…å­˜: æ•° MB (æ ˆè¡¨ + å“ˆå¸Œè¡¨)
  - é€‚ç”¨åœºæ™¯: æ ¹å› å®šä½é˜¶æ®µ

#### 2. Probe ç‚¹ç±»å‹çš„æ€§èƒ½å·®å¼‚

eBPF æ”¯æŒå¤šç§ probe ç±»å‹,æ€§èƒ½å¼€é”€å·®å¼‚æ˜¾è‘—:

```
æ€§èƒ½å¼€é”€æ’åº (ä»ä½åˆ°é«˜):
raw_tracepoint < tracepoint < kprobe < kretprobe

åŸå› :
- raw_tracepoint: å†…æ ¸é™æ€æ’æ¡©,æœ€å°å¼€é”€,ä½†å¯ç”¨ç‚¹å°‘
- tracepoint: ç¨³å®š ABI,å¼€é”€ä½,ä½†å‚æ•°æœ‰é™
- kprobe: åŠ¨æ€æ’æ¡©,å¼€é”€ä¸­ç­‰,ä½†å¯èƒ½ä¸ç¨³å®š (å†…æ ¸ç‰ˆæœ¬ä¾èµ–)
- kretprobe: éœ€è¦ä¿å­˜è¿”å›åœ°å€,å¼€é”€æœ€é«˜
```

**æœ¬å·¥å…·é›†çš„ Probe é€‰æ‹©ç­–ç•¥:**
- Summary å·¥å…·ä¼˜å…ˆä½¿ç”¨ tracepoint (å¦‚ `net:netif_receive_skb`)
- Details å·¥å…·æ··åˆä½¿ç”¨ kprobe + tracepoint ä»¥å¹³è¡¡çµæ´»æ€§å’Œæ€§èƒ½
- ä¸“é¡¹å·¥å…·ä½¿ç”¨ kprobe/kretprobe å®ç°ç²¾ç¡®æ§åˆ¶

#### 3. è¿‡æ»¤å™¨é™ä½å¼€é”€çš„åŸç†

Details å·¥å…·é€šè¿‡å¤šçº§è¿‡æ»¤å™¨æ§åˆ¶æ€§èƒ½å¼€é”€:

```c
// å†…æ ¸æ€è¿‡æ»¤ (æœ€é«˜æ•ˆ,é¿å…æ•°æ®ä¼ è¾“)
if (SRC_IP_FILTER != 0 && packet.sip != SRC_IP_FILTER) return 0;
if (DST_IP_FILTER != 0 && packet.dip != DST_IP_FILTER) return 0;

// ç”¨æˆ·æ€è¿‡æ»¤ (æ¬¡ä¹‹,å·²äº§ç”Ÿä¼ è¾“å¼€é”€)
// ä»…ç”¨äºå¤æ‚é€»è¾‘ (æ­£åˆ™ã€å­—ç¬¦ä¸²åŒ¹é…ç­‰)
```

**è¿‡æ»¤å™¨æ•ˆæœ**:
- æ— è¿‡æ»¤: 1M pps æµé‡ â†’ 30% CPU å¼€é”€
- IP è¿‡æ»¤: è¿‡æ»¤åˆ° 10K pps â†’ 5% CPU å¼€é”€
- äº”å…ƒç»„è¿‡æ»¤: è¿‡æ»¤åˆ° 100 pps â†’ < 1% CPU å¼€é”€

#### 4. ä¸‰å±‚æ¨¡å‹çš„å®è·µæ„ä¹‰

åŸºäºä¸Šè¿°æ€§èƒ½è€ƒé‡,ä¸‰å±‚è¯Šæ–­æ¨¡å‹çš„å®è·µä»·å€¼:

1. **ç¬¬ä¸€å±‚ (Summary)**:
   - ä½å¼€é”€,å¯åœ¨ç”Ÿäº§ç¯å¢ƒ**æŒç»­è¿è¡Œ**
   - å»ºç«‹æ€§èƒ½åŸºçº¿,å‘ç°å¼‚å¸¸æ¨¡å¼
   - ç¤ºä¾‹: `system_network_latency_summary.py --interval 60` å…¨å¤©ç›‘æ§

2. **ç¬¬äºŒå±‚ (Details)**:
   - ä¸­ç­‰å¼€é”€,**é—®é¢˜å¤ç°æ—¶å¯åŠ¨**
   - é…åˆè¿‡æ»¤å™¨,ç²¾ç¡®å®šä½åˆ° IP/ç«¯å£/åè®®
   - ç¤ºä¾‹: `vm_network_latency_details.py --src-ip 10.0.0.1 --dst-ip 10.0.0.2`

3. **ç¬¬ä¸‰å±‚ (ä¸“é¡¹)**:
   - è¾ƒé«˜å¼€é”€,**å·²çŸ¥ç“¶é¢ˆåçŸ­æœŸä½¿ç”¨**
   - æ·±æŒ–æ ¹å›  (CPU è°ƒåº¦ã€é”ç«äº‰ã€é˜Ÿåˆ—æº¢å‡º)
   - ç¤ºä¾‹: `offcputime-ts.py -p <ovs-pid> --duration 60`

### å·¥å…·åˆ†ç±»ä¸é€‰æ‹©å†³ç­–

#### æŒ‰åŠŸèƒ½åˆ†ç±»

| ç±»åˆ« | Summary å·¥å…· | Details å·¥å…· | é€‚ç”¨é—®é¢˜ç±»å‹ |
|------|-------------|-------------|-------------|
| **ä¸¢åŒ…åˆ†æ** | kernel_drop_stack_stats_summary_all.py | eth_drop.py | ä¸¢åŒ…ä½ç½®å®šä½ |
| **å»¶è¿Ÿåˆ†æ** | system/vm_network_latency_summary.py | system/vm_network_latency_details.py | å»¶è¿Ÿç“¶é¢ˆå®šä½ |
| **OVS åˆ†æ** | ovs_upcall_latency_summary.py | ovs_userspace_megaflow.py | OVS æ€§èƒ½é—®é¢˜ |
| **è™šæ‹ŸåŒ–** | vhost_eventfd_count.py | vhost_queue_correlation_details.py | VM ç½‘ç»œæ…¢/ä¸¢åŒ… |

#### å†³ç­–æ ‘

```
é—®é¢˜ç—‡çŠ¶æ˜¯ä»€ä¹ˆ?
â”œâ”€ ä¸¢åŒ…
â”‚  â”œâ”€ ä¸çŸ¥é“ä¸¢åœ¨å“ª â†’ kernel_drop_stack_stats_summary_all.py (Summary)
â”‚  â””â”€ çŸ¥é“å¤§æ¦‚ä½ç½® â†’ eth_drop.py + è¿‡æ»¤å™¨ (Details)
â”‚
â”œâ”€ å»¶è¿Ÿé«˜
â”‚  â”œâ”€ ä¸çŸ¥é“æ…¢åœ¨å“ªä¸ªé˜¶æ®µ â†’ system/vm_network_latency_summary.py (Summary)
â”‚  â””â”€ çŸ¥é“æ…¢åœ¨æŸé˜¶æ®µ â†’ system/vm_network_latency_details.py + é˜ˆå€¼è¿‡æ»¤ (Details)
â”‚
â”œâ”€ OVS ç›¸å…³
â”‚  â”œâ”€ æµè¡¨æœªå‘½ä¸­å¤š â†’ ovs_userspace_megaflow.py (Details)
â”‚  â””â”€ Upcall æ…¢ â†’ ovs_upcall_latency_summary.py (Summary)
â”‚
â””â”€ VM ç½‘ç»œé—®é¢˜
   â”œâ”€ ä¸çŸ¥é“ç“¶é¢ˆ â†’ vm_network_latency_summary.py (Summary)
   â””â”€ å·²çŸ¥ vhost/virtio æ…¢ â†’ vhost_queue_correlation_details.py (Details)
```

---

## ç¬¬äºŒéƒ¨åˆ†: å•å·¥å…·ä½¿ç”¨æŒ‡å—

æœ¬éƒ¨åˆ†é’ˆå¯¹ä¸‰ç±»æ ¸å¿ƒå·¥å…·,ç»“åˆå®é™…ä½¿ç”¨åœºæ™¯,è¯´æ˜å·¥å…·åŠŸèƒ½ã€å‘½ä»¤å‚æ•°ã€è¾“å‡ºè§£è¯»å’Œå…¸å‹åº”ç”¨ã€‚

### 2.1 ä¸¢åŒ…åˆ†æå·¥å…·

#### å·¥å…· 1: kernel_drop_stack_stats_summary_all.py (Summary ç‰ˆæœ¬)

**åŠŸèƒ½è¯´æ˜:**
- **å®šä½å†…æ ¸ä¸¢åŒ…ä½ç½®**: é€šè¿‡è¿½è¸ª `kfree_skb` è°ƒç”¨,ç»Ÿè®¡ä¸¢åŒ…å‘ç”Ÿçš„å†…æ ¸æ ˆä½ç½®
- **äº”å…ƒç»„èšåˆ**: æŒ‰åè®®ã€IPã€ç«¯å£åˆ†ç»„ç»Ÿè®¡,è¯†åˆ«ç‰¹å®šæµçš„ä¸¢åŒ…
- **Histogram è¾“å‡º**: ä½¿ç”¨ BPF_HISTOGRAM åœ¨å†…æ ¸ä¾§èšåˆ,ä½å¼€é”€

**å·¥ä½œåŸç†:**
```
kfree_skb() è¢«è°ƒç”¨ â†’ eBPF æ•è·è°ƒç”¨æ ˆ â†’ æå–äº”å…ƒç»„ â†’ æ›´æ–° Histogram
                                         â†“
                           æŒ‰ (stack_id + äº”å…ƒç»„) èšåˆè®¡æ•°
                                         â†“
                           å®šæœŸè¾“å‡º Top N ä¸¢åŒ…æ ˆç»Ÿè®¡
```

**ä½¿ç”¨åœºæ™¯:**
1. **å…¨å±€ä¸¢åŒ…æ’æŸ¥**: ä¸çŸ¥é“ä¸¢åŒ…å‘ç”Ÿåœ¨å“ªé‡Œæ—¶,å¿«é€Ÿæ‰«æ
2. **ç‰¹å®šæµä¸¢åŒ…**: ç›‘æ§ç‰¹å®š IP/ç«¯å£çš„ä¸¢åŒ…æ ˆåˆ†å¸ƒ
3. **é•¿æœŸç›‘æ§**: ä½å¼€é”€,å¯æŒç»­è¿è¡Œå»ºç«‹ä¸¢åŒ…åŸºçº¿

**å‘½ä»¤å‚æ•°:**
```bash
sudo python3 kernel_drop_stack_stats_summary_all.py \
  --src-ip <æºIP> \           # å¯é€‰: æº IP è¿‡æ»¤
  --dst-ip <ç›®çš„IP> \         # å¯é€‰: ç›®çš„ IP è¿‡æ»¤
  --src-port <æºç«¯å£> \       # å¯é€‰: æºç«¯å£è¿‡æ»¤ (TCP/UDP)
  --dst-port <ç›®çš„ç«¯å£> \     # å¯é€‰: ç›®çš„ç«¯å£è¿‡æ»¤ (TCP/UDP)
  --l4-protocol <åè®®> \      # å¯é€‰: tcp/udp/icmp/all (é»˜è®¤ all)
  -n <ç½‘å¡å> \               # å¯é€‰: æŒ‰ç½‘å¡è¿‡æ»¤ (å¦‚ eth0, br-int)
  -i <é—´éš”ç§’æ•°> \             # æŠ¥å‘Šé—´éš” (é»˜è®¤ 10 ç§’)
  -d <æŒç»­æ—¶é—´> \             # æ€»è¿è¡Œæ—¶é•¿ (é»˜è®¤æ— é™)
  -t <Topæ•°é‡> \              # æ˜¾ç¤ºå‰ N ä¸ªä¸¢åŒ…æ ˆ (é»˜è®¤ 5)
  --group-by <æ¨¡å¼>           # èšåˆæ¨¡å¼: stack/fivetuple/all (é»˜è®¤ all)
```

**è¾“å‡ºç¤ºä¾‹ä¸è§£è¯»:**
```bash
# ç¤ºä¾‹: ç›‘æ§ ICMP æµé‡ä¸¢åŒ…
sudo python3 kernel_drop_stack_stats_summary_all.py \
  --src-ip 10.132.114.11 \
  --dst-ip 10.132.114.12 \
  --l4-protocol icmp \
  -i 60 -t 3
```

è¾“å‡º:
```
[2025-10-20 10:45:00] === Drop Stack Statistics (Interval: 60.0s) ===

Found 3 unique stack+flow combinations, showing top 3:

#1 Count: 2,456 calls [device: vnet3] [stack_id: 127]
   Flow: 10.132.114.11 -> 10.132.114.12 (ICMP)
Stack trace:
  Stack depth: 8 frames
  kfree_skb+0x1 [kernel]
  tun_get_user+0x4d2 [kernel]        â† ä¸¢åŒ…ä½ç½®: TUN è®¾å¤‡æ¥æ”¶
  tun_chr_write_iter+0x52
  __vfs_write+0x1b4
  vfs_write+0xb8
  ksys_write+0x5f
  do_syscall_64+0x5b

#2 Count: 234 calls [device: br-int] [stack_id: 234]
   Flow: 10.132.114.11 -> 10.132.114.12 (ICMP)
Stack trace:
  kfree_skb+0x1 [kernel]
  __dev_queue_xmit+0x7a2 [kernel]    â† ä¸¢åŒ…ä½ç½®: TX é˜Ÿåˆ—
  dev_queue_xmit+0x10
  ...

Total drops in 60s: 2,690 packets
```

**è¾“å‡ºè§£è¯»:**
- **Count**: ä¸¢åŒ…æ¬¡æ•° (ç›¸åŒæ ˆ+æµçš„èšåˆ)
- **device**: ä¸¢åŒ…æ—¶ skb->dev çš„ç½‘å¡å
- **stack_id**: å†…æ ¸æ ˆçš„å”¯ä¸€ ID
- **Flow**: äº”å…ƒç»„ä¿¡æ¯ (IP + ç«¯å£ + åè®®)
- **Stack trace**: è°ƒç”¨æ ˆ (ä»å†…åˆ°å¤–,kfree_skb åœ¨æœ€é¡¶å±‚)

**å…³é”®æ ˆä½ç½®è¯†åˆ«:**
```
å¸¸è§ä¸¢åŒ…æ ˆåŠåŸå› :
â”œâ”€ tun_get_user â†’ TUN è®¾å¤‡ç¯å½¢ç¼“å†²åŒºæ»¡
â”œâ”€ __dev_queue_xmit â†’ TX é˜Ÿåˆ—æ»¡ (qdisc æº¢å‡º)
â”œâ”€ tcp_v4_rcv â†’ TCP å±‚ä¸¢åŒ… (æ ¡éªŒå’Œé”™è¯¯/è¿æ¥ä¸å­˜åœ¨)
â”œâ”€ ip_rcv_core â†’ IP å±‚ä¸¢åŒ… (TTL è¶…æ—¶/è·¯ç”±å¤±è´¥)
â””â”€ nf_hook_slow â†’ Netfilter ä¸¢åŒ… (é˜²ç«å¢™è§„åˆ™/conntrack è¡¨æ»¡)
```

#### å·¥å…· 2: eth_drop.py (Details ç‰ˆæœ¬)

**åŠŸèƒ½è¯´æ˜:**
- **Per-packet ä¸¢åŒ…è¯¦æƒ…**: æ¯ä¸ªä¸¢åŒ…äº‹ä»¶å®æ—¶è¾“å‡ºå®Œæ•´ä¿¡æ¯
- **åè®®è§£æ**: æ”¯æŒ Ethernet/VLAN/IPv4/TCP/UDP/ICMP å­—æ®µæå–
- **æ ˆè·Ÿè¸ª**: è¾“å‡ºå®Œæ•´å†…æ ¸è°ƒç”¨æ ˆ
- **Normal pattern è¿‡æ»¤**: å¯è¿‡æ»¤æ‰æ­£å¸¸çš„ kfree_skb (å¦‚ TCP è¯»å–åé‡Šæ”¾)

**å·¥ä½œåŸç†:**
```
kfree_skb() â†’ eBPF è§£æä»¥å¤ªç½‘å¸§ â†’ è¿‡æ»¤å™¨åŒ¹é… â†’ perf_output åˆ°ç”¨æˆ·æ€
                                                          â†“
                                           æ‰“å°åŒ…å¤´ä¿¡æ¯ + è°ƒç”¨æ ˆ
```

**ä½¿ç”¨åœºæ™¯:**
1. **å®šä½å…·ä½“ä¸¢åŒ…åŒ…**: éœ€è¦çŸ¥é“ä¸¢çš„æ˜¯å“ªä¸ªåŒ… (åºåˆ—å·/ID)
2. **åè®®å±‚åˆ†æ**: éœ€è¦ VLAN/MAC/ç«¯å£ç­‰è¯¦ç»†å­—æ®µ
3. **çŸ­æœŸæŠ“å–**: é—®é¢˜å¤ç°æ—¶,ç²¾ç¡®æ•è·ä¸¢åŒ…ç¬é—´

**å‘½ä»¤å‚æ•°:**
```bash
sudo python3 eth_drop.py \
  --type <åè®®ç±»å‹> \         # arp/rarp/ipv4/ipv6/lldp/all (é»˜è®¤ all)
  --l4-protocol <L4åè®®> \    # all/icmp/tcp/udp (é»˜è®¤ all)
  --src-ip <æºIP> \
  --dst-ip <ç›®çš„IP> \
  --src-port <æºç«¯å£> \
  --dst-port <ç›®çš„ç«¯å£> \
  --vlan-id <VLAN ID> \
  --interface <ç½‘å¡å> \
  --verbose \                  # è¯¦ç»†è¾“å‡ºæ¨¡å¼
  --no-stack-trace \           # ç¦ç”¨æ ˆè·Ÿè¸ª (é™ä½å¼€é”€)
  --disable-normal-filter      # ç¦ç”¨ normal pattern è¿‡æ»¤
```

**è¾“å‡ºç¤ºä¾‹ä¸è§£è¯»:**
```bash
# ç¤ºä¾‹: è¿½è¸ª TCP 80 ç«¯å£çš„ä¸¢åŒ…
sudo python3 eth_drop.py \
  --l4-protocol tcp \
  --dst-port 80 \
  --interface vnet3
```

è¾“å‡º:
```
[15:35:10.123456] PID: 12567 TGID: 12567 COMM: vhost-12534 CPU: 5
Ethernet Header:
  Source MAC: 52:54:00:12:34:56
  Dest MAC:   52:54:00:ab:cd:ef
  EtherType:  0x0800 (IPv4)
TCP PACKET
  Source IP:      10.132.114.11
  Dest IP:        10.132.114.12
  Source Port:    45678
  Dest Port:      80
  TCP Sequence:   1234567890
  TCP Flags:      [SYN]
  Data Length:    0 bytes
Interface: vnet3
Stack trace:
  kfree_skb+0x1 [kernel]
  tun_get_user+0x4d2 [kernel]        â† ä¸¢åŒ…ä½ç½®
  tun_chr_write_iter+0x52
  __vfs_write+0x1b4
  vfs_write+0xb8
  ksys_write+0x5f
  do_syscall_64+0x5b
```

**è¾“å‡ºè§£è¯»:**
- **æ—¶é—´æˆ³**: ç²¾ç¡®åˆ°å¾®ç§’çš„ä¸¢åŒ…æ—¶åˆ»
- **PID/COMM**: è§¦å‘ä¸¢åŒ…çš„è¿›ç¨‹ (å¦‚ vhost-12534)
- **CPU**: ä¸¢åŒ…å‘ç”Ÿçš„ CPU æ ¸
- **Ethernet/IP/TCP å­—æ®µ**: å®Œæ•´åè®®å¤´ä¿¡æ¯
- **Stack trace**: ä¸ Summary ç‰ˆæœ¬ç›¸åŒ

**Normal pattern è¿‡æ»¤è¯´æ˜:**
```python
# é»˜è®¤è¿‡æ»¤çš„"æ­£å¸¸" kfree_skb æ ˆ
normal_patterns = {
    'skb_release_data': ['skb_release_data', '__kfree_skb', 'tcp_recvmsg'],  # TCP è¯»å–åé‡Šæ”¾
    'sk_stream_kill_queues': ['sk_stream_kill_queues'],                       # è¿æ¥å…³é—­æ—¶é‡Šæ”¾
    'icmp_rcv': ['icmp_rcv'],                                                  # ICMP æ¥æ”¶å¤„ç†
}

# ç¦ç”¨è¿‡æ»¤: --disable-normal-filter
# é€‚ç”¨äºæ€€ç–‘"æ­£å¸¸"è·¯å¾„ä¹Ÿæœ‰é—®é¢˜çš„åœºæ™¯
```

**æ€§èƒ½ä¼˜åŒ–å»ºè®®:**
1. **ç²¾ç¡®è¿‡æ»¤**: ä½¿ç”¨ `--src-ip` + `--dst-ip` + `--dst-port` ç»„åˆ
2. **ç¦ç”¨æ ˆè·Ÿè¸ª**: å¦‚æœåªå…³å¿ƒåŒ…å†…å®¹,ä½¿ç”¨ `--no-stack-trace` é™ä½ 30% å¼€é”€
3. **çŸ­æœŸè¿è¡Œ**: ä»…åœ¨é—®é¢˜å¤ç°æ—¶å¯åŠ¨,é¿å…é•¿æœŸè¿è¡Œ

#### ä¸¢åŒ…åˆ†æå·¥å…·å¯¹æ¯”

| ç»´åº¦ | kernel_drop_stack_stats_summary_all.py | eth_drop.py |
|------|--------------------------------------|-------------|
| **è¾“å‡ºç²’åº¦** | èšåˆç»Ÿè®¡ (æŒ‰æ ˆ+æµ) | æ¯åŒ…è¯¦æƒ… |
| **æ€§èƒ½å¼€é”€** | æä½ (< 3% CPU) | ä¸­ç­‰ (10-20% CPU) |
| **é€‚ç”¨åœºæ™¯** | é•¿æœŸç›‘æ§ã€ä¸¢åŒ…ä½ç½®å®šä½ | çŸ­æœŸæŠ“åŒ…ã€åè®®å±‚åˆ†æ |
| **è¾“å‡ºé‡** | æ¯é—´éš” 1 æ¬¡æŠ¥å‘Š | æ¯ä¸ªä¸¢åŒ… 1 æ¡è®°å½• |
| **è¿‡æ»¤èƒ½åŠ›** | äº”å…ƒç»„ + ç½‘å¡ | äº”å…ƒç»„ + ç½‘å¡ + VLAN |
| **å»ºè®®ä½¿ç”¨æ—¶é•¿** | æŒç»­è¿è¡Œ (å°æ—¶-å¤©) | çŸ­æœŸè¿è¡Œ (åˆ†é’Ÿçº§) |

**å®æˆ˜ç»„åˆç­–ç•¥:**
```
æ­¥éª¤ 1: ä½¿ç”¨ summary_all.py å®šä½ä¸¢åŒ…æ ˆä½ç½®å’Œæµ
         â†“
æ­¥éª¤ 2: æ ¹æ® summary ç»“æœ,ç”¨ eth_drop.py + è¿‡æ»¤å™¨æŠ“å–å…·ä½“åŒ…
         â†“
æ­¥éª¤ 3: åˆ†æåŒ…å¤´å­—æ®µå’Œæ ˆè·Ÿè¸ª,ç¡®è®¤æ ¹å› 
```

---

### 2.2 ç½‘ç»œå»¶è¿Ÿåˆ†æå·¥å…·

#### å·¥å…· 3: system_network_latency_summary.py (Summary ç‰ˆæœ¬)

**åŠŸèƒ½è¯´æ˜:**
- **åˆ†é˜¶æ®µå»¶è¿Ÿç»Ÿè®¡**: æµ‹é‡ç³»ç»Ÿç½‘ç»œæ ˆå„é˜¶æ®µé—´çš„å»¶è¿Ÿåˆ†å¸ƒ
- **Histogram å±•ç¤º**: å¯¹æ•°åˆ»åº¦ histogram,æ¸…æ™°å±•ç¤ºé•¿å°¾å»¶è¿Ÿ
- **åŒå‘æ”¯æŒ**: æ”¯æŒ TX (ç³»ç»Ÿâ†’ç‰©ç†) å’Œ RX (ç‰©ç†â†’ç³»ç»Ÿ) æ–¹å‘

**ç½‘ç»œæ ˆé˜¶æ®µå®šä¹‰:**
```
TX æ–¹å‘ (ç³»ç»Ÿ â†’ ç‰©ç†ç½‘å¡):
  0. ip_queue_xmit/ip_send_skb    â† åº”ç”¨å±‚å‘é€
     â†“
  1. internal_dev_xmit             â† è¿›å…¥ OVS è™šæ‹Ÿç½‘å¡
     â†“
  2. ovs_dp_process_packet         â† OVS æ•°æ®é¢å¤„ç†
     â†“
  3. ovs_dp_upcall                 â† Upcall (æµè¡¨æœªå‘½ä¸­æ—¶)
     â†“
  4. ovs_flow_key_extract          â† æµè¡¨ key æå–
     â†“
  5. ovs_vport_send                â† OVS ç«¯å£å‘é€
     â†“
  6. dev_queue_xmit                â† ç‰©ç†ç½‘å¡å‘é€é˜Ÿåˆ—

RX æ–¹å‘ (ç‰©ç†ç½‘å¡ â†’ ç³»ç»Ÿ):
  0. __netif_receive_skb           â† ç‰©ç†ç½‘å¡æ¥æ”¶
     â†“
  1. netdev_frame_hook             â† OVS æ•è·
     â†“
  2-5. (åŒ TX çš„ OVS å¤„ç†é˜¶æ®µ)
     â†“
  6. tcp_v4_rcv/udp_rcv            â† åè®®æ ˆæ¥æ”¶
```

**ä½¿ç”¨åœºæ™¯:**
1. **å®šä½æ…¢åœ¨å“ªä¸ªé˜¶æ®µ**: ä¸çŸ¥é“ç“¶é¢ˆåœ¨ OVS/é˜Ÿåˆ—/åè®®æ ˆå“ªé‡Œ
2. **é•¿å°¾å»¶è¿Ÿåˆ†æ**: å‘ç° P99/P999 å»¶è¿Ÿå¼‚å¸¸
3. **å¯¹æ¯”åŸºçº¿**: å»ºç«‹æ­£å¸¸å»¶è¿ŸåŸºçº¿,å‘ç°å¼‚å¸¸æ—¶æ®µ

**å‘½ä»¤å‚æ•°:**
```bash
sudo python3 system_network_latency_summary.py \
  --phy-interface <ç‰©ç†ç½‘å¡> \     # å¿…éœ€: å¦‚ eth0, enp94s0f0np0
  --src-ip <æºIP> \                # å¯é€‰: IP è¿‡æ»¤
  --dst-ip <ç›®çš„IP> \
  --protocol <åè®®> \              # tcp/udp/icmp (é»˜è®¤ all)
  --direction <æ–¹å‘> \             # tx/rx (å¿…éœ€)
  --interval <é—´éš”ç§’æ•°>            # æŠ¥å‘Šé—´éš” (é»˜è®¤ 5 ç§’)
```

**è¾“å‡ºç¤ºä¾‹ä¸è§£è¯»:**
```bash
# ç¤ºä¾‹: ç›‘æ§ç³»ç»Ÿç½‘ç»œ ICMP RX å»¶è¿Ÿ
sudo python3 system_network_latency_summary.py \
  --phy-interface ens11 \
  --src-ip 10.132.114.11 \
  --dst-ip 10.132.114.12 \
  --direction rx \
  --protocol icmp \
  --interval 60
```

è¾“å‡º:
```
[2025-10-20 10:28:00] === Latency Report (Interval: 60.0s) ===

Stage: INTERNAL_RX â†’ FLOW_EXTRACT_END_RX (OVS å¤„ç†é˜¶æ®µ)
     latency (us)    : count    distribution
        0 -> 1       :   156   |*******                            |
        2 -> 3       :   345   |****************                   |
        4 -> 7       :   678   |********************************   |
        8 -> 15      :   891   |************************************|  â† P50
       16 -> 31      :   234   |***********                        |
       32 -> 63      :   123   |******                             |
       64 -> 127     :   67    |***                                |  â† P95
      128 -> 255     :   34    |*                                  |
      256 -> 511     :   12    |                                   |
      512 -> 1023    :   8     |                                   |
     1024 -> 2047    :   5     |                                   |
   131072 -> 262143  :   1     |                                   |  â† P999 é•¿å°¾!

Total packets: 2,567
Packets with latency > 100ms: 7 packets
```

**è¾“å‡ºè§£è¯»:**
- **Stage**: å“ªä¸¤ä¸ªé˜¶æ®µä¹‹é—´çš„å»¶è¿Ÿ
- **latency bucket**: å¯¹æ•°åˆ»åº¦å»¶è¿ŸåŒºé—´ (å¾®ç§’)
- **count**: è½åœ¨è¯¥åŒºé—´çš„åŒ…æ•°é‡
- **distribution**: ASCII ç›´æ–¹å›¾
- **å…³é”®æŒ‡æ ‡**:
  - ä¸»å³°ä½ç½® â†’ P50 å»¶è¿Ÿ
  - 95% åˆ†ä½ â†’ ä»å·¦å¾€å³ç´¯ç§¯åˆ° 95%
  - é•¿å°¾ â†’ è¶…è¿‡æ­£å¸¸èŒƒå›´çš„å¼‚å¸¸å»¶è¿Ÿ

**å¦‚ä½•è¯†åˆ«å¼‚å¸¸:**
```
æ­£å¸¸åˆ†å¸ƒ:
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (é›†ä¸­åœ¨æŸä¸ªåŒºé—´,å¦‚ 8-15us)
        â–ˆâ–ˆ
          â–ˆ

å¼‚å¸¸é•¿å°¾:
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
        â–ˆâ–ˆ
          â–ˆ
           â–ˆ  â† P99
            â–ˆ â† P999  â† å‡ºç°é•¿å°¾,è¯´æ˜æœ‰å¶å‘æç«¯å»¶è¿Ÿ
```

#### å·¥å…· 4: vm_network_latency_summary.py (VM ç½‘ç»œç‰ˆæœ¬)

**åŠŸèƒ½è¯´æ˜:**
- ä¸ `system_network_latency_summary.py` ç±»ä¼¼,ä½†ä¸“æ³¨äº **VM ç½‘ç»œè·¯å¾„**
- æµ‹é‡è™šæ‹Ÿæœºç½‘ç»œæ ˆå„é˜¶æ®µå»¶è¿Ÿ (vnet â†’ OVS â†’ ç‰©ç†ç½‘å¡,æˆ–åå‘)

**VM ç½‘ç»œæ ˆé˜¶æ®µå®šä¹‰:**
```
VNET RX (VM å‘é€ â†’ ç‰©ç†ç½‘å¡):
  1. vnet RX (TUN è®¾å¤‡æ¥æ”¶)
     â†“
  2. OVS RX
     â†“
  3-7. OVS å¤„ç† (flow extract, upcall, conntrack)
     â†“
  8-9. Qdisc (å…¥é˜Ÿ/å‡ºé˜Ÿ)
     â†“
  10-11. TX é˜Ÿåˆ— â†’ ç‰©ç†ç½‘å¡å‘é€

VNET TX (ç‰©ç†ç½‘å¡ â†’ VM æ¥æ”¶):
  12. ç‰©ç†ç½‘å¡ RX
     â†“
  13-18. OVS å¤„ç† + Conntrack
     â†“
  19-20. VNET Qdisc
     â†“
  21. VNET TX (TUN è®¾å¤‡å‘é€åˆ° VM)
```

**å‘½ä»¤å‚æ•°:**
```bash
sudo python3 vm_network_latency_summary.py \
  --vm-interface <VMç½‘å¡> \        # å¿…éœ€: å¦‚ vnet0, vnet37
  --phy-interface <ç‰©ç†ç½‘å¡> \     # å¿…éœ€
  --src-ip <æºIP> \
  --dst-ip <ç›®çš„IP> \
  --protocol <åè®®> \              # tcp/udp/icmp
  --direction <æ–¹å‘> \             # rx (VM å‘é€) / tx (VM æ¥æ”¶)
  --interval <é—´éš”ç§’æ•°>
```

**ä½¿ç”¨åœºæ™¯:**
1. **VM ç½‘ç»œæ…¢**: å®šä½æ˜¯ vhost/OVS/ç‰©ç†ç½‘å¡å“ªä¸ªé˜¶æ®µæ…¢
2. **è™šæ‹ŸåŒ–å¼€é”€åˆ†æ**: å¯¹æ¯” VM è·¯å¾„ vs ç‰©ç†è·¯å¾„å»¶è¿Ÿå·®å¼‚
3. **OVS conntrack å»¶è¿Ÿ**: å‘ç° conntrack æˆä¸ºç“¶é¢ˆ

**è¾“å‡ºä¸ system ç‰ˆæœ¬ç›¸åŒ,é˜¶æ®µåç§°ä¸åŒã€‚**

---

### 2.3 OVS Megaflow ç”Ÿå‘½å‘¨æœŸåˆ†æå·¥å…·

#### å·¥å…· 5: ovs_userspace_megaflow.py

**åŠŸèƒ½è¯´æ˜:**
- **è¿½è¸ª OVS Megaflow å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**: ä» Upcall åˆ›å»º â†’ å†…æ ¸å®‰è£… â†’ å‘½ä¸­ä½¿ç”¨ â†’ è¿‡æœŸåˆ é™¤
- **Netlink æ¶ˆæ¯è§£æ**: å®Œæ•´è§£æ OVS ç”¨æˆ·æ€-å†…æ ¸æ€é€šä¿¡
- **äº”å…ƒç»„å…³è”**: å°† Upcall å’Œ Flow å®‰è£…æŒ‰æµå…³è”

**Megaflow ç”Ÿå‘½å‘¨æœŸ:**
```
1. æ•°æ®åŒ…åˆ°è¾¾ OVS,æµè¡¨æœªå‘½ä¸­
         â†“
2. è§¦å‘ Upcall (å†…æ ¸ â†’ ç”¨æˆ·æ€ ovs-vswitchd)
         â†“ ã€æœ¬å·¥å…·æ•è·: upcall_eventsã€‘
3. ovs-vswitchd å†³ç­– action (æŸ¥è¯¢ OpenFlow è¡¨)
         â†“
4. ä¸‹å‘ Megaflow åˆ°å†…æ ¸ (FLOW_CMD_NEW)
         â†“ ã€æœ¬å·¥å…·æ•è·: flow_cmd_new_eventsã€‘
5. åç»­åŒæµåŒ…å‘½ä¸­å†…æ ¸ Megaflow (å¿«é€Ÿè½¬å‘)
         â†“
6. è¿‡æœŸååˆ é™¤ (FLOW_CMD_DEL)
```

**ä½¿ç”¨åœºæ™¯:**
1. **æµè¡¨æœªå‘½ä¸­ç‡é«˜**: åˆ†æå“ªäº›æµé¢‘ç¹è§¦å‘ Upcall
2. **Megaflow å®‰è£…å»¶è¿Ÿ**: æµ‹é‡ä» Upcall åˆ° Flow å®‰è£…çš„è€—æ—¶
3. **æµè¡¨ç­–ç•¥åˆ†æ**: æŸ¥çœ‹ OVS ä¸ºå“ªäº›æµå®‰è£…äº† Megaflow

**å‘½ä»¤å‚æ•°:**
```bash
sudo python3 ovs_userspace_megaflow.py \
  --eth-src <MACåœ°å€> \
  --eth-dst <MACåœ°å€> \
  --ip-src <æºIP> \
  --ip-dst <ç›®çš„IP> \
  --ip-proto <åè®®å·> \           # 6=TCP, 17=UDP, 1=ICMP
  --l4-src-port <æºç«¯å£> \
  --l4-dst-port <ç›®çš„ç«¯å£>
```

**è¾“å‡ºç¤ºä¾‹ä¸è§£è¯»:**
```bash
# ç¤ºä¾‹: è¿½è¸ªç‰¹å®šæµçš„ Megaflow ç”Ÿå‘½å‘¨æœŸ
sudo python3 ovs_userspace_megaflow.py \
  --ip-src 10.132.114.11 \
  --ip-dst 10.132.114.12 \
  --ip-proto 1
```

è¾“å‡º:
```
=== UPCALL Event ===
Time: 2025-10-20 10:28:42.567891
PID: 2456 (handler23)
Flow: 10.132.114.11:0 -> 10.132.114.12:0 (Proto: 1/ICMP)
Device: br-int
SKB Mark: 0x0

=== FLOW_CMD_NEW Event ===
Time: 2025-10-20 10:28:42.568123
PID: 2456 (handler23)
Netlink PortID: 0x12345678
Flow Key:
  eth_type: 0x0800 (IPv4)
  ipv4_src: 10.132.114.11
  ipv4_dst: 10.132.114.12
  ip_proto: 1 (ICMP)
Actions:
  output: port 5 (ens11)

Installation Latency: 232 us  â† Upcall åˆ° Flow å®‰è£…çš„å»¶è¿Ÿ
```

**è¾“å‡ºè§£è¯»:**
- **UPCALL Event**: æµè¡¨æœªå‘½ä¸­äº‹ä»¶
  - Time: Upcall å‘ç”Ÿæ—¶åˆ»
  - PID/Comm: å¤„ç†çš„ handler çº¿ç¨‹
  - Flow: äº”å…ƒç»„ä¿¡æ¯
  - Device: è¿›å…¥ OVS çš„è®¾å¤‡

- **FLOW_CMD_NEW Event**: Megaflow å®‰è£…äº‹ä»¶
  - Flow Key: å†…æ ¸ Megaflow åŒ¹é…å­—æ®µ (å¯èƒ½æ¯”äº”å…ƒç»„æ›´é€šé…)
  - Actions: æ•°æ®åŒ…è½¬å‘åŠ¨ä½œ
  - Installation Latency: Upcall å¤„ç†è€—æ—¶

**æ€§èƒ½åˆ†æè¦ç‚¹:**
```
æ­£å¸¸ Installation Latency: < 500us
å¼‚å¸¸æƒ…å†µ:
  - 1-10ms: OpenFlow è¡¨å¤æ‚,è§„åˆ™åŒ¹é…æ…¢
  - 10-100ms: ovs-vswitchd CPU é«˜,å¤„ç†æ…¢
  - > 100ms: é”ç«äº‰/è°ƒåº¦é—®é¢˜ (å‚è€ƒæ¡ˆä¾‹ 1)
```

**å…¸å‹é—®é¢˜è¯†åˆ«:**
1. **Upcall é£æš´**: çŸ­æ—¶é—´å¤§é‡ Upcall â†’ æµè¡¨ç²’åº¦å¤ªç»†/è€åŒ–å¤ªå¿«
2. **é‡å¤ Upcall**: ç›¸åŒæµåå¤ Upcall â†’ Megaflow æœªå®‰è£…/è¢«åˆ é™¤
3. **å®‰è£…å»¶è¿Ÿé«˜**: Installation Latency > 10ms â†’ ovs-vswitchd ç“¶é¢ˆ

---

## ç¬¬ä¸‰éƒ¨åˆ†: å¤æ‚é—®é¢˜å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: ç³»ç»Ÿç½‘ç»œ ICMP "ä¸¢åŒ…"æ ¹å› åˆ†æ - å»¶è¿Ÿè¯¯åˆ¤é—®é¢˜

### 1.1 é—®é¢˜èƒŒæ™¯

**ç¯å¢ƒä¿¡æ¯:**
- è™šæ‹ŸåŒ–å¹³å°: OpenStack + KVM/QEMU + Open vSwitch
- ç›‘æ§å‘Šè­¦: ç³»ç»Ÿç½‘ç»œ ICMP ç›‘æ§æ˜¾ç¤ºé•¿æœŸå­˜åœ¨å°‘é‡ä¸¢åŒ… (~ 1/10000)
- ä¸šåŠ¡å½±å“: å¶å‘æ€§ç½‘ç»œè¿æ¥è´¨é‡ä¸‹é™,éƒ¨åˆ† ping è¯·æ±‚è¶…æ—¶
- å‘ç”Ÿç‰¹ç‚¹: æ—¶é—´åˆ†å¸ƒä¸å‡åŒ€,æ— æ˜æ˜¾è§„å¾‹

**ç›‘æ§æ•°æ® (15s ç²’åº¦):**
- ICMP ä¸¢åŒ…ç‡: < 0.01% (200ms è¶…æ—¶é˜ˆå€¼)
- OVS CPU åˆ©ç”¨ç‡: æ­£å¸¸ (å¹³å‡ 10 %, å³°å€¼ 60%)
- ç½‘ç»œæµé‡: icmp ç¨³å®šå‘é€, æ— çªå‘æµé‡
- ç³»ç»Ÿ CPU: æ­£å¸¸ (å¹³å‡ 45%)

**å·²çŸ¥ä¿¡æ¯:**
- ç‰©ç†æ¥å£: ens11, ens12 (bonding)
- OVS Bridge: ovsbr-xxx
- ç›‘æ§åè®®: ICMP (ping)
- è¶…æ—¶é˜ˆå€¼: 200ms
- ç›‘æ§æº: 10.132.114.11
- ç›‘æ§ç›®æ ‡: 10.132.114.12

### 1.2 é—®é¢˜åˆ†ææ€è·¯

**åˆæ­¥å‡è®¾:**
ç›‘æ§æ˜¾ç¤º"ä¸¢åŒ…",ä½†å¯èƒ½åŸå› æœ‰ä¸‰:
1. çœŸå®ä¸¢åŒ… (å†…æ ¸/é©±åŠ¨/OVS å±‚ä¸¢å¼ƒæ•°æ®åŒ…)
2. é«˜å»¶è¿Ÿè¯¯åˆ¤ (å»¶è¿Ÿ >200ms è¢«è®¡å…¥ä¸¢åŒ…)
3. ç›‘æ§ç³»ç»Ÿé—®é¢˜

**åˆ†æç­–ç•¥:**
```
ç¬¬ä¸€å±‚: éªŒè¯çœŸå®ä¸¢åŒ… vs é«˜å»¶è¿Ÿ
  â”œâ”€ ä¸¢åŒ…ç»Ÿè®¡å·¥å…· (ç¡®è®¤å†…æ ¸çœŸå®ä¸¢åŒ…é‡)
  â””â”€ å¯¹æ¯”ç›‘æ§æ•°æ® (åŒºåˆ†ä¸¢åŒ… vs è¶…æ—¶)
       â†“
ç¬¬äºŒå±‚: å®šä½å»¶è¿Ÿæ¥æº (å¦‚æœæ˜¯é«˜å»¶è¿Ÿ)
  â”œâ”€ ç³»ç»Ÿç½‘ç»œå»¶è¿Ÿåˆ†æ®µç»Ÿè®¡ (è¯†åˆ«ç“¶é¢ˆé˜¶æ®µ)
  â””â”€ OVS upcall å»¶è¿Ÿåˆ†æ (èšç„¦ OVS å±‚)
       â†“
ç¬¬ä¸‰å±‚: ç²¾ç¡®è¿½è¸ªé«˜å»¶è¿Ÿäº‹ä»¶
  â”œâ”€ Details å·¥å…· + é«˜å»¶è¿Ÿé˜ˆå€¼è¿‡æ»¤
  â””â”€ æ—¶é—´æˆ³å…³è”éªŒè¯
       â†“
ç¬¬å››å±‚: æ ¹å› å®šä½ - CPU/è°ƒåº¦/é”åˆ†æ
  â”œâ”€ OVS è¿›ç¨‹ CPU ç›‘æ§ (burst æ—¶æ®µåˆ†æ)
  â”œâ”€ Off-CPU åˆ†æ (è°ƒåº¦å¼€é”€)
  â””â”€ é”ç«äº‰åˆ†æ (è‡ªæ—‹é”/æ…¢é€Ÿè·¯å¾„)
       â†“
      ä¿®å¤éªŒè¯
```

---

### 1.3 ç¬¬ä¸€å±‚è¯Šæ–­: ä¸¢åŒ… vs é«˜å»¶è¿ŸåŒºåˆ†

#### æ­¥éª¤ 1.3.1: çœŸå®ä¸¢åŒ…é‡ç»Ÿè®¡

**åˆ†æç›®æ ‡:**
éªŒè¯å†…æ ¸æ˜¯å¦çœŸçš„ä¸¢å¼ƒ ICMP æ•°æ®åŒ…,è¿˜æ˜¯ä»…ä»…æ˜¯å»¶è¿Ÿè¿‡é«˜å¯¼è‡´ç›‘æ§è¶…æ—¶ã€‚

**éƒ¨ç½²å·¥å…·: å†…æ ¸ä¸¢åŒ…æ ˆç»Ÿè®¡ (Summary ç‰ˆæœ¬)**
```bash
# ç›‘æ§ç³»ç»Ÿç½‘ç»œ ICMP æµé‡çš„çœŸå®ä¸¢åŒ…
sudo python3 ebpf-tools/linux-network-stack/packet-drop/kernel_drop_stack_stats_summary_all.py \
  --src-ip 10.132.114.11 \
  --dst-ip 10.132.114.12 \
  --l4-protocol icmp \
  --interval 60 \
  --duration 1800 \
  --top 10
```

**è¾“å‡ºåˆ†æ (30 åˆ†é’Ÿç»Ÿè®¡):**
```
[2025-10-20 10:45:00] === Drop Stack Statistics (Interval: 60.0s) ===

ç›‘æ§å‘¨æœŸ: 10:15:00 - 10:45:00 (30 åˆ†é’Ÿ)

Found 2 unique stack+flow combinations:

#1 Count: 23 calls [device: br-int] [stack_id: 127]
   Flow: 10.132.114.11 -> 10.132.114.12 (ICMP)
Stack trace:
  kfree_skb+0x1 [kernel]
  ip_rcv_core+0x1a2 [kernel]
  ip_rcv+0x2d [kernel]
  __netif_receive_skb_core+0x677 [kernel]
  ...

#2 Count: 8 calls [device: ens11] [stack_id: 234]
   Flow: 10.132.114.11 -> 10.132.114.12 (ICMP)
Stack trace:
  kfree_skb+0x1 [kernel]
  __dev_queue_xmit+0x7a2 [kernel]
  ...

Total drops in 30 min: 31 packets
```

**å¯¹æ¯”ç›‘æ§æ•°æ®:**
```
ç›‘æ§ç³»ç»ŸæŠ¥å‘Š (åŒæ—¶æ®µ):
- ICMP å‘é€: 18,000 packets
- ICMP è¶…æ—¶: 234 packets (1.3% "ä¸¢åŒ…ç‡")
- è¶…æ—¶é˜ˆå€¼: 200ms

eBPF çœŸå®ä¸¢åŒ…ç»Ÿè®¡:
- çœŸå®ä¸¢åŒ…: 31 packets (0.17%)
```

**å…³é”®å‘ç°:**
ğŸ” **é‡å¤§å·®å¼‚**:
- ç›‘æ§æ˜¾ç¤º 234 ä¸ª"ä¸¢åŒ…" (1.3%)
- å†…æ ¸çœŸå®ä¸¢åŒ…ä»… 31 ä¸ª (0.17%)
- **å·®å¼‚: 203 ä¸ªåŒ…** (234 - 31 = 203)

**åˆæ­¥ç»“è®º:**
âœ… **é—®é¢˜ä¸æ˜¯çœŸå®ä¸¢åŒ…,è€Œæ˜¯é«˜å»¶è¿Ÿ!**
- 203 ä¸ªåŒ…å»¶è¿Ÿè¶…è¿‡ 200ms,è¢«ç›‘æ§è¯¯åˆ¤ä¸ºä¸¢åŒ…
- çœŸå®ä¸¢åŒ…ä»… 31 ä¸ª,å±äºæ­£å¸¸èŒƒå›´
- **é—®é¢˜èšç„¦**: ä¸ºä»€ä¹ˆä¼šå‡ºç° 200ms+ çš„å»¶è¿Ÿ?

---

### 1.4 ç¬¬äºŒå±‚è¯Šæ–­: ç³»ç»Ÿç½‘ç»œå»¶è¿Ÿåˆ†æ®µç»Ÿè®¡

#### æ­¥éª¤ 1.4.1: è¯†åˆ«å»¶è¿Ÿæ¥æº

**åˆ†æç›®æ ‡:**
ç¡®å®š 200ms+ å»¶è¿Ÿä¸»è¦å‘ç”Ÿåœ¨ç½‘ç»œæ ˆçš„å“ªä¸ªé˜¶æ®µã€‚

**éƒ¨ç½²å·¥å…·: ç³»ç»Ÿç½‘ç»œå»¶è¿Ÿåˆ†æ®µ Histogram**
```bash
# ç›‘æ§ç³»ç»Ÿç½‘ç»œå„é˜¶æ®µå»¶è¿Ÿåˆ†å¸ƒ
sudo python3 ebpf-tools/performance/system-network/system_network_latency_summary.py \
  --phy-interface ens11 \
  --src-ip 10.132.114.11 \
  --dst-ip 10.132.114.12 \
  --direction rx \
  --protocol icmp \
  --interval 60
```

**è¾“å‡ºåˆ†æ (æ•è·é«˜å»¶è¿Ÿæ—¶æ®µ):**
```
[2025-10-20 10:28:00] === Latency Report (Interval: 60.0s) ===

Stage: INTERNAL_RX â†’ FLOW_EXTRACT_END_RX (OVS å¤„ç†é˜¶æ®µ)
     latency (us)    : count    distribution
        0 -> 1       :   156   |*******                            |
        2 -> 3       :   345   |****************                   |
        4 -> 7       :   678   |********************************   |
        8 -> 15      :   891   |************************************|  â† æ­£å¸¸èŒƒå›´
       16 -> 31      :   234   |***********                        |
       32 -> 63      :   123   |******                             |
       64 -> 127     :   67    |***                                |
      128 -> 255     :   34    |*                                  |
      256 -> 511     :   12    |                                   |
      512 -> 1023    :   8     |                                   |
     1024 -> 2047    :   5     |                                   |
     2048 -> 4095    :   4     |                                   |
     4096 -> 8191    :   3     |                                   |
     8192 -> 16383   :   2     |                                   |
    16384 -> 32767   :   2     |                                   |
    32768 -> 65535   :   1     |                                   |
    65536 -> 131071  :   1     |                                   |
   131072 -> 262143  :   1     |                                   |  â† é«˜å»¶è¿Ÿé•¿å°¾!

Total packets: 2,567
Packets with latency > 200ms (200,000us): 3 packets  â† å¯¹åº”ç›‘æ§"ä¸¢åŒ…"æ—¶é—´ç‚¹!
```

**åˆ†é˜¶æ®µå»¶è¿Ÿå æ¯”:**
```
Stage: INTERNAL_RX â†’ FLOW_EXTRACT_END_RX
  - å¹³å‡å»¶è¿Ÿ: 8.7 us (æ­£å¸¸)
  - P99 å»¶è¿Ÿ: 89 us (æ­£å¸¸)
  - è¶…è¿‡ 100ms çš„åŒ…: 7 ä¸ª
  - è¶…è¿‡ 200ms çš„åŒ…: 3 ä¸ª    â† OVS å¤„ç†é˜¶æ®µæç«¯å»¶è¿Ÿ!

Stage: FLOW_EXTRACT_END_RX â†’ QDISC_ENQ
  - å¹³å‡å»¶è¿Ÿ: 1.2 us (æ­£å¸¸)
  - P99 å»¶è¿Ÿ: 5 us (æ­£å¸¸)

Stage: QDISC_ENQ â†’ TX_XMIT
  - å¹³å‡å»¶è¿Ÿ: 0.8 us (æ­£å¸¸)
  - P99 å»¶è¿Ÿ: 3 us (æ­£å¸¸)
```

**å…³é”®å‘ç°:**
ğŸ” **OVS å¤„ç†é˜¶æ®µå¶å‘æç«¯å»¶è¿Ÿ**:
- ç»å¤§å¤šæ•°åŒ…å»¶è¿Ÿæ­£å¸¸ (< 15us)
- ä½†å­˜åœ¨é•¿å°¾å»¶è¿Ÿ: 7 ä¸ªåŒ… > 100ms, 3 ä¸ªåŒ… > 200ms
- **å»¶è¿Ÿé›†ä¸­åœ¨ OVS é˜¶æ®µ** (INTERNAL_RX â†’ FLOW_EXTRACT_END_RX)
- æ—¶é—´çª—å£ä¸ç›‘æ§"ä¸¢åŒ…"æ—¶é—´æ®µ**å®Œå…¨å»åˆ**!

#### æ­¥éª¤ 1.4.2: OVS Upcall å»¶è¿Ÿæ·±åº¦åˆ†æ

**åˆ†æç›®æ ‡:**
OVS å»¶è¿Ÿé«˜,éœ€è¦ç¡®è®¤æ˜¯å¦ä¸ upcall å¤„ç†æœ‰å…³ã€‚

**éƒ¨ç½²å·¥å…·: OVS Upcall å»¶è¿Ÿ Histogram**
```bash
# æŒç»­ç›‘æ§ OVS upcall å»¶è¿Ÿåˆ†å¸ƒ
sudo python3 ebpf-tools/ovs/ovs_upcall_latency_summary.py \
  --src-ip 10.132.114.11 \
  --dst-ip 10.132.114.12 \
  --proto icmp \
  --interval 60
```

**è¾“å‡ºåˆ†æ (æ•è·å¼‚å¸¸æ—¶æ®µ):**
```
[2025-10-20 10:28:30] === Upcall Latency Report (Interval: 60.0s) ===

Upcall Latency Distribution:
     latency (us)    : count    distribution
        0 -> 1       :   2     |                                   |
        2 -> 3       :   8     |*                                  |
        4 -> 7       :   23    |****                               |
        8 -> 15      :   45    |*********                          |
       16 -> 31      :   78    |****************                   |
       32 -> 63      :   123   |*************************          |
       64 -> 127     :   234   |************************************|  â† æ­£å¸¸ä¸»å³°
      128 -> 255     :   89    |******************                 |
      256 -> 511     :   34    |*******                            |
      512 -> 1023    :   12    |**                                 |
     1024 -> 2047    :   8     |*                                  |
     2048 -> 4095    :   5     |*                                  |
     4096 -> 8191    :   4     |                                   |
     8192 -> 16383   :   3     |                                   |
    16384 -> 32767   :   2     |                                   |
    32768 -> 65535   :   2     |                                   |
    65536 -> 131071  :   2     |                                   |  â† æç«¯é•¿å°¾!
   131072 -> 262143  :   1     |                                   |
   262144 -> 524287  :   1     |                                   |  â† è¶…è¿‡ 200ms!

Total upcalls: 676
Average latency: 87.3 us (æ­£å¸¸)
P50 latency: 65 us (æ­£å¸¸)
P95 latency: 289 us (å¯æ¥å—)
P99 latency: 2,345 us (å¼€å§‹å¼‚å¸¸)
P99.9 latency: 134,567 us (134ms!)  â† æç«¯å¼‚å¸¸!
Max latency: 287,456 us (287ms!)    â† è¶…è¿‡ç›‘æ§é˜ˆå€¼!
```

**å…³é”®å‘ç°:**
ğŸ” **OVS Upcall æç«¯é•¿å°¾å»¶è¿Ÿ**:
- P99 ä»¥ä¸‹å»¶è¿Ÿæ­£å¸¸ (< 300us)
- ä½† P99.9 å»¶è¿Ÿè¾¾åˆ° 134ms!
- **æç«¯æƒ…å†µ**: æœ€å¤§å»¶è¿Ÿ 287ms (è¶…è¿‡ 200ms ç›‘æ§é˜ˆå€¼)
- **é«˜å»¶è¿Ÿ upcall æ•°é‡**: çº¦ 7-10 ä¸ª/å°æ—¶
- **æ—¶é—´åˆ†å¸ƒ**: ä¸å‡åŒ€,çªå‘æ€§å‡ºç°

**ç»“è®º:**
âœ… **ç¡®è®¤å»¶è¿Ÿæºå¤´**: OVS upcall å¤„ç†å¶å‘æ€§æç«¯å»¶è¿Ÿ (100-300ms)
- å¹³å‡æ€§èƒ½æ­£å¸¸,ä½†å­˜åœ¨é•¿å°¾
- é•¿å°¾å»¶è¿Ÿä¸ç›‘æ§"ä¸¢åŒ…"æ—¶é—´ç‚¹å®Œå…¨ä¸€è‡´

---

### 1.5 ç¬¬ä¸‰å±‚è¯Šæ–­: ç²¾ç¡®è¿½è¸ªé«˜å»¶è¿Ÿäº‹ä»¶

#### æ­¥éª¤ 1.5.1: ä½¿ç”¨ Details å·¥å…· + é«˜å»¶è¿Ÿé˜ˆå€¼è¿‡æ»¤

**åˆ†æç›®æ ‡:**
ç²¾ç¡®æ•è·å»¶è¿Ÿ >200ms çš„å…·ä½“äº‹ä»¶,è®°å½•æ—¶é—´æˆ³,ç”¨äºåç»­å…³è”åˆ†æã€‚

**éƒ¨ç½²å·¥å…·: ç³»ç»Ÿç½‘ç»œå»¶è¿Ÿ Details (å¸¦é˜ˆå€¼è¿‡æ»¤)**
```bash
# æ³¨æ„: éœ€è¦ä¿®æ”¹å·¥å…·æºç æ·»åŠ å»¶è¿Ÿé˜ˆå€¼è¿‡æ»¤,æˆ–è€…ä½¿ç”¨æ—¥å¿—åå¤„ç†
# è¿™é‡Œå±•ç¤ºç†æƒ³çš„ä½¿ç”¨æ–¹å¼
sudo python3 ebpf-tools/performance/system-network/system_network_latency_details.py \
  --phy-interface ens11 \
  --src-ip 10.132.114.11 \
  --dst-ip 10.132.114.12 \
  --direction rx \
  --protocol icmp \
  --latency-threshold 100000  # ä»…è®°å½•å»¶è¿Ÿ > 100ms çš„åŒ…
```

**è¾“å‡ºåˆ†æ (æ•è·åˆ°çš„é«˜å»¶è¿Ÿäº‹ä»¶):**
```
[2025-10-20 10:28:42.567] === FLOW COMPLETE: 4 stages captured ===
FLOW: 10.132.114.11 -> 10.132.114.12 (ICMP Echo Request seq=15234)
5-TUPLE: 10.132.114.11 -> 10.132.114.12 ICMP (seq=15234) DIR=RX

  Stage INTERNAL_RX: KTIME=1729420122567891234ns
    TIMESTAMP: 2025-10-20 10:28:42.567891234
    SKB: ptr=0xffff888123456789 len=84
    DEV: br-int (ifindex=5) CPU=12

  Stage FLOW_EXTRACT_END_RX: KTIME=1729420122789234567ns (+221.343ms!)  â† æç«¯å»¶è¿Ÿ!
    TIMESTAMP: 2025-10-20 10:28:42.789234567
    SKB: ptr=0xffff888123456789 len=84
    DEV: br-int (ifindex=5) CPU=12

  Stage QDISC_ENQ: KTIME=1729420122791456789ns (+2.222ms)
  Stage TX_XMIT: KTIME=1729420122793678901ns (+2.222ms)

  TOTAL DURATION: 225.788ms  â† è¿œè¶… 200ms é˜ˆå€¼!
  PROCESS: pid=2456 comm=handler23 first_dev=br-int

=== å…³é”®æ—¶é—´æˆ³ ===
- è¿›å…¥ OVS: 10:28:42.567891234
- ç¦»å¼€ OVS: 10:28:42.789234567
- OVS å¤„ç†è€—æ—¶: 221.343ms  â† é—®é¢˜æ‰€åœ¨!
```

**æ—¶é—´æˆ³è®°å½•:**
```
é«˜å»¶è¿Ÿäº‹ä»¶è®°å½•:
Event #1: 10:28:42.567 - 10:28:42.789 (221ms, ICMP seq=15234)
Event #2: 10:29:15.234 - 10:29:15.521 (287ms, ICMP seq=15289)
Event #3: 10:31:08.123 - 10:31:08.412 (289ms, ICMP seq=15456)
```

**å…³é”®å‘ç°:**
âœ… **ç²¾ç¡®å®šä½é«˜å»¶è¿Ÿæ—¶åˆ»**:
- å»¶è¿Ÿå…¨éƒ¨å‘ç”Ÿåœ¨ `INTERNAL_RX â†’ FLOW_EXTRACT_END_RX` é˜¶æ®µ
- æ—¶é—´æˆ³ä¸ç›‘æ§"ä¸¢åŒ…"æ—¶é—´ç‚¹**ç²¾ç¡®åŒ¹é…** (ç§’çº§å¯¹åº”)
- å¤„ç†è¿›ç¨‹: ovs-vswitchd çš„ handler çº¿ç¨‹ (handler23)
- CPU: å§‹ç»ˆåœ¨ CPU 12 ä¸Šå¤„ç†

---

### 1.6 ç¬¬å››å±‚è¯Šæ–­: OVS è¿›ç¨‹ CPU/è°ƒåº¦/é”æ·±åº¦åˆ†æ

#### æ­¥éª¤ 1.6.1: OVS è¿›ç¨‹ CPU Burst åˆ†æ

**åˆ†æç›®æ ‡:**
ç›‘æ§æ•°æ®æ˜¾ç¤º OVS CPU å¹³å‡åˆ©ç”¨ç‡æ­£å¸¸(35%),ä½†å¯èƒ½å­˜åœ¨çŸ­æš‚çš„ CPU burstã€‚
éœ€è¦æ•è·ä¸é«˜å»¶è¿Ÿäº‹ä»¶å¯¹åº”çš„ç¬æ—¶ CPU ä½¿ç”¨ç‡ã€‚

**éƒ¨ç½²å·¥å…·: CPU ç›‘æ§ (ç»†ç²’åº¦)**
```bash
# ä½¿ç”¨ top/pidstat æ•è· ovs-vswitchd ç¬æ—¶ CPU
# 1ç§’ç²’åº¦,æŒç»­ç›‘æ§
pidstat -p $(pgrep ovs-vswitchd) 1 > ovs_cpu.log &

# æˆ–ä½¿ç”¨ eBPF CPU monitor
sudo ./ebpf-tools/cpu/cpu_monitor.sh --pid $(pgrep ovs-vswitchd) --interval 1
```

**è¾“å‡ºåˆ†æ (ä¸é«˜å»¶è¿Ÿäº‹ä»¶æ—¶é—´å…³è”):**
```
æ—¶é—´æˆ³          PID    %usr  %system  %CPU   Command
10:28:42       2456   15.2    21.3    36.5   ovs-vswitchd  â† æ­£å¸¸
10:28:43       2456   89.7    98.1   187.8   ovs-vswitchd  â† CPU burst!
10:28:44       2456   92.3    96.7   189.0   ovs-vswitchd  â† æŒç»­é«˜è´Ÿè½½
10:28:45       2456   88.5    95.2   183.7   ovs-vswitchd
10:28:46       2456   14.8    19.7    34.5   ovs-vswitchd  â† æ¢å¤æ­£å¸¸

æ—¶é—´æˆ³          PID    %usr  %system  %CPU   Command
10:29:15       2456   91.2    97.3   188.5   ovs-vswitchd  â† å†æ¬¡ burst!
10:29:16       2456   89.8    96.1   185.9   ovs-vswitchd
10:29:17       2456   16.2    21.5    37.7   ovs-vswitchd  â† æ¢å¤
```

**å…³é”®å‘ç°:**
ğŸ” **å‘ç° CPU Burst æ¨¡å¼**:
- æ­£å¸¸æ—¶æ®µ: CPU 35% å·¦å³
- Burst æ—¶æ®µ: CPU ç¬é—´é£™å‡åˆ° 185-190% (å¤šæ ¸,è¶…è¿‡å•æ ¸ 100%)
- **Burst æ—¶é—´ç‚¹**: ä¸é«˜å»¶è¿Ÿäº‹ä»¶æ—¶é—´æˆ³**å®Œå…¨ä¸€è‡´**!
  - Event #1 (10:28:42): CPU burst å¼€å§‹äº 10:28:43
  - Event #2 (10:29:15): CPU burst å¼€å§‹äº 10:29:15
- Burst æŒç»­æ—¶é—´: 2-4 ç§’
- é—®é¢˜: **15s ç²’åº¦çš„ç›‘æ§é—æ¼äº†è¿™äº›çŸ­æš‚çš„ burst**!

#### æ­¥éª¤ 1.6.2: Off-CPU æ—¶é—´åˆ†æ (è°ƒåº¦å¼€é”€)

**åˆ†æç›®æ ‡:**
CPU ä½¿ç”¨ç‡é«˜å¯èƒ½ä¸æ˜¯è®¡ç®—å¯†é›†,è€Œæ˜¯è°ƒåº¦/ç­‰é”ç­‰ off-CPU å¼€é”€ã€‚

**éƒ¨ç½²å·¥å…·: Off-CPU Time åˆ†æ**
```bash
# åˆ†æ ovs-vswitchd è¿›ç¨‹çš„ off-CPU æ—¶é—´
sudo python3 ebpf-tools/cpu/offcputime-ts.py -p $(pgrep ovs-vswitchd) --duration 300
```

**è¾“å‡ºåˆ†æ (èšç„¦ handler çº¿ç¨‹):**
```
Tracing off-CPU time for PID 2456 (ovs-vswitchd)... Hit Ctrl-C to end.

[10:28:43.234] Thread: handler23 (TID 2478)
Off-CPU Event: 187.3ms
Stack trace:
  __schedule+0x2e5
  schedule+0x32
  schedule_preempt_disabled+0xe
  __mutex_lock.isra.0+0x1a9
  __mutex_lock_slowpath+0x13      â† äº’æ–¥é”æ…¢é€Ÿè·¯å¾„!
  mutex_lock+0x1f
  ovs_flow_tbl_lookup+0x45        â† OVS æµè¡¨æŸ¥æ‰¾
  ovs_dp_process_packet+0x3a
  ...

[10:28:43.421] Thread: handler23 (TID 2478)
Off-CPU Event: 34.2ms
Stack trace:
  __schedule+0x2e5
  schedule+0x32
  schedule_timeout+0x1a9
  wait_for_common+0xab
  ovs_upcall_handler+0x234        â† upcall ç­‰å¾…
  ...

[10:29:15.287] Thread: handler23 (TID 2478)
Off-CPU Event: 203.5ms
Stack trace:
  __schedule+0x2e5
  schedule+0x32
  schedule_preempt_disabled+0xe
  __mutex_lock.isra.0+0x1a9
  __mutex_lock_slowpath+0x13      â† å†æ¬¡å‘½ä¸­é”æ…¢é€Ÿè·¯å¾„!
  mutex_lock+0x1f
  ovs_flow_tbl_lookup+0x45
  ...
```

**å…³é”®å‘ç°:**
ğŸ” **å‘ç°è°ƒåº¦å’Œé”ç«äº‰é—®é¢˜**:
- handler23 çº¿ç¨‹åœ¨é«˜å»¶è¿Ÿæ—¶æ®µå¤§é‡ off-CPU (187ms, 203ms)
- ä¸»è¦åŸå› : **mutex_lock æ…¢é€Ÿè·¯å¾„** (`__mutex_lock_slowpath`)
- é”ä½ç½®: `ovs_flow_tbl_lookup` (OVS æµè¡¨æŸ¥æ‰¾)
- **é—®é¢˜**: æµè¡¨æŸ¥æ‰¾æ—¶é”ç«äº‰ä¸¥é‡,å¯¼è‡´çº¿ç¨‹é•¿æ—¶é—´ç­‰å¾…

#### æ­¥éª¤ 1.6.3: é”ç«äº‰æ·±åº¦åˆ†æ

**åˆ†æç›®æ ‡:**
ç¡®è®¤æ˜¯å“ªä¸ªé”å¯¼è‡´ç«äº‰,ä»¥åŠç«äº‰çš„çº¿ç¨‹æ˜¯è°ã€‚

**éƒ¨ç½²å·¥å…·: pthread_rwlock ç›‘æ§**
```bash
# ç›‘æ§ ovs-vswitchd çš„è¯»å†™é”
sudo bpftrace ebpf-tools/cpu/pthread_rwlock_wrlock.bt $(pgrep ovs-vswitchd)
```

**è¾“å‡ºåˆ†æ:**
```
Tracing pthread_rwlock for PID 2456...

[10:28:43.234] Thread handler23 (TID 2478) trying to acquire wrlock
  Lock address: 0x7f8a2c001a40
  Wait started: 10:28:43.234567890

[10:28:43.421] Thread handler23 (TID 2478) acquired wrlock
  Lock address: 0x7f8a2c001a40
  Wait duration: 187ms  â† ç­‰é”æ—¶é—´!
  Current holder was: revalidator12 (TID 2489)

Stack trace (handler23 waiting):
  pthread_rwlock_wrlock+0x0
  fat_rwlock_wrlock+0x12
  ovs_flow_tbl_lookup+0x45        â† æµè¡¨æŸ¥æ‰¾éœ€è¦è¯»å†™é”
  ovs_dp_process_packet+0x3a

Stack trace (revalidator12 holding):
  fat_rwlock_wrlock+0x23
  flow_table_revalidate+0x67      â† revalidator åœ¨æ¸…ç†è¿‡æœŸæµè¡¨
  revalidator_sweep+0x234
```

**å…³é”®å‘ç°:**
ğŸ” **å®šä½é”ç«äº‰æ ¹å› **:
- **ç«äº‰çš„é”**: fat_rwlock (OVS æµè¡¨é”) at 0x7f8a2c001a40
- **ç«äº‰çº¿ç¨‹**:
  - handler23 (æ•°æ®é¢å¤„ç†çº¿ç¨‹) - éœ€è¦è¯»é”æŸ¥è¯¢æµè¡¨
  - revalidator12 (æµè¡¨æ¸…ç†çº¿ç¨‹) - æŒæœ‰å†™é”æ¸…ç†è¿‡æœŸæµè¡¨
- **å†²çªåœºæ™¯**:
  - revalidator å®šæœŸæ¸…ç†è¿‡æœŸæµè¡¨(éœ€è¦å†™é”)
  - æ¸…ç†è¿‡ç¨‹ä¸­,æ‰€æœ‰ handler çº¿ç¨‹è¢«é˜»å¡(ç­‰å¾…è¯»é”)
  - æ¸…ç†æ—¶é—´: 150-200ms
  - æ¸…ç†é¢‘ç‡: ä¸å®šæœŸ,å–å†³äºæµè¡¨æ•°é‡

#### æ­¥éª¤ 1.6.4: è‡ªæ—‹é”å¿«é€Ÿè·¯å¾„å¼€é”€åˆ†æ

**éƒ¨ç½²å·¥å…·: Futex ç›‘æ§**
```bash
# ç›‘æ§ futex ç³»ç»Ÿè°ƒç”¨(ç”¨äº mutex å®ç°)
sudo bpftrace ebpf-tools/cpu/futex.bt $(pgrep ovs-vswitchd)
```

**è¾“å‡ºåˆ†æ (Burst æ—¶æ®µ):**
```
[10:28:43.234] Futex Operations Summary (1 second):

Thread: handler23 (TID 2478)
  FUTEX_WAIT: 234 calls, avg 0.8ms, total 187.2ms  â† å¤§é‡ç­‰å¾…!
  FUTEX_WAKE: 12 calls

Thread: handler24 (TID 2479)
  FUTEX_WAIT: 189 calls, avg 0.9ms, total 170.1ms

Thread: handler25 (TID 2480)
  FUTEX_WAIT: 201 calls, avg 0.85ms, total 170.85ms

Thread: revalidator12 (TID 2489)
  FUTEX_WAKE: 624 calls  â† é¢‘ç¹å”¤é†’å…¶ä»–çº¿ç¨‹

Total futex overhead: ~528ms across all handler threads
```

**å…³é”®å‘ç°:**
ğŸ” **é”ç«äº‰å¯¼è‡´çš„çº§è”æ•ˆåº”**:
- revalidator æŒæœ‰å†™é”æœŸé—´
- å¤šä¸ª handler çº¿ç¨‹åŒæ—¶è¢«é˜»å¡ (handler23/24/25)
- æ¯ä¸ªçº¿ç¨‹ç­‰å¾…æ—¶é—´: 170-187ms
- **è‡ªæ—‹é”å¿«é€Ÿè·¯å¾„å¤±æ•ˆ**: ç›´æ¥è¿›å…¥ futex æ…¢é€Ÿè·¯å¾„
- CPU ä½¿ç”¨ç‡è™½é«˜,ä½†å¤§éƒ¨åˆ†æ¶ˆè€—åœ¨**é”ç«äº‰å’Œä¸Šä¸‹æ–‡åˆ‡æ¢**

---

**é—®é¢˜æ ¹å› æ€»ç»“:**

é€šè¿‡å››å±‚æ·±åº¦è¯Šæ–­,å®Œæ•´çš„é—®é¢˜é“¾è·¯å¦‚ä¸‹:

```
OVS revalidator çº¿ç¨‹å®šæœŸæ¸…ç†è¿‡æœŸæµè¡¨
         â†“
éœ€è¦ fat_rwlock å†™é” (150-200ms æŒé”æ—¶é—´)
         â†“
æ‰€æœ‰ handler çº¿ç¨‹è¢«é˜»å¡ (ç­‰å¾…è¯»é”è®¿é—®æµè¡¨)
         â†“
handler çº¿ç¨‹è¿›å…¥ mutex æ…¢é€Ÿè·¯å¾„ (__mutex_lock_slowpath)
         â†“
è‡ªæ—‹é”å¿«é€Ÿè·¯å¾„å¤±æ•ˆ â†’ futex ç³»ç»Ÿè°ƒç”¨ â†’ ä¸Šä¸‹æ–‡åˆ‡æ¢
         â†“
å¤§é‡ off-CPU æ—¶é—´ (187-203ms per thread)
         â†“
CPU burst (185-190%, 2-4ç§’) - ä½†æ¶ˆè€—åœ¨é”ç«äº‰éè®¡ç®—
         â†“
Upcall å¤„ç†å»¶è¿Ÿæç«¯å¢åŠ  (200-280ms)
         â†“
æ•°æ®åŒ… OVS é˜¶æ®µå»¶è¿Ÿ >200ms
         â†“
ç›‘æ§ç³»ç»Ÿåˆ¤å®šä¸º"ä¸¢åŒ…" (å®é™…æ˜¯è¶…æ—¶)
```

**æ ¸å¿ƒé—®é¢˜:**
1. **æµè¡¨é”è®¾è®¡**: fat_rwlock å†™é”é˜»å¡æ‰€æœ‰è¯»æ“ä½œ
2. **revalidator æ¸…ç†ç­–ç•¥**: å®šæœŸæ¸…ç†è€—æ—¶é•¿ (150-200ms)
3. **ç›‘æ§ç²’åº¦ä¸è¶³**: 15s ç²’åº¦é—æ¼ 2-4s çš„ CPU burst
4. **ç›‘æ§é˜ˆå€¼è®¾ç½®**: 200ms é˜ˆå€¼å°†é«˜å»¶è¿Ÿè¯¯åˆ¤ä¸ºä¸¢åŒ…

---

### 1.8 è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: ä¼˜åŒ– OVS revalidator é…ç½®

```bash
# å‡å°‘ revalidator çº¿ç¨‹æ•°,é™ä½é”ç«äº‰
sudo ovs-vsctl set Open_vSwitch . other_config:n-revalidator-threads=1

# è°ƒæ•´ revalidator æ‰«æé—´éš”
sudo ovs-appctl revalidator/wait  # æŸ¥çœ‹å½“å‰é…ç½®
```

#### æ–¹æ¡ˆ 2: å‡çº§ OVS ç‰ˆæœ¬

```bash
# è¾ƒæ–°ç‰ˆæœ¬çš„ OVS æ”¹è¿›äº†æµè¡¨é”æœºåˆ¶
# ä» fat_rwlock æ”¹ä¸ºæ›´ç»†ç²’åº¦çš„ RCU é”
# å»ºè®®å‡çº§åˆ° OVS 2.15+ æˆ– 2.17+ (æ”¯æŒ RCU flow table)
```

#### æ–¹æ¡ˆ 3: è°ƒæ•´ç›‘æ§ç­–ç•¥

```bash
# 1. æé«˜ç›‘æ§ç²’åº¦ (15s â†’ 1s)
# 2. æé«˜è¶…æ—¶é˜ˆå€¼ (200ms â†’ 500ms æˆ–ä½¿ç”¨åŠ¨æ€é˜ˆå€¼)
# 3. åŒºåˆ†"ä¸¢åŒ…"å’Œ"è¶…æ—¶"æŒ‡æ ‡
```

#### æ–¹æ¡ˆ 4: ä¸´æ—¶ç¼“è§£ (ç”Ÿäº§ç¯å¢ƒ)

```bash
# å¢åŠ  handler çº¿ç¨‹æ•°,å‡å°‘å•ä¸ªçº¿ç¨‹é˜»å¡å½±å“
sudo ovs-vsctl set Open_vSwitch . other_config:n-handler-threads=8

# è°ƒæ•´æµè¡¨å¤§å°,å‡å°‘ revalidator æ‰«ææ—¶é—´
sudo ovs-vsctl set Open_vSwitch . other_config:max-flows=100000
```

---

### 1.9 ä¿®å¤éªŒè¯

#### éªŒè¯ 1: å†æ¬¡ç›‘æ§ç³»ç»Ÿç½‘ç»œå»¶è¿Ÿ

```bash
sudo python3 ebpf-tools/performance/system-network/system_network_latency_summary.py \
  --phy-interface ens11 \
  --src-ip 10.132.114.11 \
  --dst-ip 10.132.114.12 \
  --direction rx \
  --protocol icmp \
  --interval 60
```

**ä¿®å¤å (30 åˆ†é’Ÿç»Ÿè®¡):**
```
Stage: INTERNAL_RX â†’ FLOW_EXTRACT_END_RX
     latency (us)    : count    distribution
        0 -> 1       :   234   |********                            |
        2 -> 3       :   567   |*********************                |
        4 -> 7       :   891   |********************************    |
        8 -> 15      :   1024  |************************************|  â† æ¢å¤æ­£å¸¸!
       16 -> 31      :   156   |*****                                |
       32 -> 63      :   45    |*                                    |
       64 -> 127     :   12    |                                     |
      128 -> 255     :   3     |                                     |

Total packets: 2,932
Packets with latency > 200ms: 0  â† æ— è¶…æ—¶!
```

#### éªŒè¯ 2: OVS Upcall å»¶è¿Ÿ

**ä¿®å¤å:**
```
Total upcalls: 687
Average latency: 76.8 us (æ­£å¸¸)
P99 latency: 456 us (æ”¹å–„)
P99.9 latency: 2,345 us (ä» 134ms é™åˆ° 2.3ms!)  â† æ˜¾è‘—æ”¹å–„!
Max latency: 8,567 us (ä» 287ms é™åˆ° 8.5ms!)
```

#### éªŒè¯ 3: ç›‘æ§æ•°æ®å¯¹æ¯”

```
ä¿®å¤å‰ (30åˆ†é’Ÿ):
- ç›‘æ§"ä¸¢åŒ…": 234 packets (1.3%)
- çœŸå®ä¸¢åŒ…: 31 packets (0.17%)
- é«˜å»¶è¿Ÿè¶…æ—¶: 203 packets

ä¿®å¤å (30åˆ†é’Ÿ):
- ç›‘æ§"ä¸¢åŒ…": 38 packets (0.21%)
- çœŸå®ä¸¢åŒ…: 28 packets (0.16%)
- é«˜å»¶è¿Ÿè¶…æ—¶: 10 packets (æ”¹å–„ 95%!)
```

**âœ… ä¿®å¤éªŒè¯æˆåŠŸ:**
- é«˜å»¶è¿Ÿäº‹ä»¶å‡å°‘ 95% (203 â†’ 10)
- "è¯¯åˆ¤ä¸¢åŒ…"ä» 1.3% é™åˆ° 0.21%
- OVS upcall æç«¯å»¶è¿Ÿæ¶ˆé™¤ (287ms â†’ 8.5ms)
- ç›‘æ§å‘Šè­¦é¢‘ç‡æ˜¾è‘—ä¸‹é™

---

### 1.10 æ¡ˆä¾‹æ€»ç»“

**å·¥å…·ä½¿ç”¨é“¾è·¯ (5 å±‚è¯Šæ–­):**
```
kernel_drop_stack_stats_summary_all.py (éªŒè¯çœŸå®ä¸¢åŒ… vs è¶…æ—¶)
         â†“
system_network_latency_summary.py (å®šä½ OVS é˜¶æ®µå»¶è¿Ÿ)
         â†“
ovs_upcall_latency_summary.py (ç¡®è®¤ upcall é•¿å°¾å»¶è¿Ÿ)
         â†“
system_network_latency_details.py (ç²¾ç¡®æ•è·é«˜å»¶è¿Ÿäº‹ä»¶)
         â†“
offcputime-ts.py (å‘ç°é”ç­‰å¾…å’Œè°ƒåº¦å¼€é”€)
         â†“
pthread_rwlock_wrlock.bt (å®šä½æµè¡¨é”ç«äº‰)
         â†“
futex.bt (ç¡®è®¤è‡ªæ—‹é”æ…¢é€Ÿè·¯å¾„)
```

**å…³é”®ç»éªŒ:**

1. âœ… **åŒºåˆ†ä¸¢åŒ… vs å»¶è¿Ÿ**: ä½¿ç”¨ä¸¢åŒ…ç»Ÿè®¡å·¥å…·éªŒè¯çœŸå®ä¸¢åŒ…é‡
2. âœ… **Summary å·¥å…·å¿«é€Ÿå®šä½**: Histogram å±•ç¤ºé•¿å°¾å»¶è¿Ÿ
3. âœ… **Details å·¥å…·ç²¾ç¡®è¿½è¸ª**: æ•è·å…·ä½“é«˜å»¶è¿Ÿäº‹ä»¶å’Œæ—¶é—´æˆ³
4. âœ… **å¤šå±‚æ·±å…¥åˆ†æ**: ä»ç½‘ç»œå±‚ â†’ åº”ç”¨å±‚ â†’ CPU/é”å±‚
5. âœ… **ç›‘æ§ç²’åº¦å…³é”®**: 15s ç²’åº¦ä¼šé—æ¼ 2-4s çš„ burst
6. âœ… **äº¤å‰éªŒè¯æ—¶é—´æˆ³**: å·¥å…·æ•°æ®ä¸ç›‘æ§æ•°æ®æ—¶é—´å¯¹é½
7. âœ… **Off-CPU åˆ†æ**: CPU ä½¿ç”¨ç‡é«˜ä¸ç­‰äºè®¡ç®—å¯†é›†
8. âœ… **é”ç«äº‰å®šä½**: pthread_rwlock + futex å·¥å…·ç»„åˆä½¿ç”¨
9. âœ… **ä¿®å¤åæŒç»­éªŒè¯**: Summary å·¥å…·ç›‘æ§ä¿®å¤æ•ˆæœ

---

## é™„å½•: å¸¸è§é—®é¢˜è¯Šæ–­é€ŸæŸ¥è¡¨

| ç—‡çŠ¶ | ç¬¬ä¸€å±‚å·¥å…· (Summary) | ç¬¬äºŒå±‚å·¥å…· (Details) | å¯èƒ½æ ¹å›  |
|------|---------------------|---------------------|---------|
| VM å»¶è¿Ÿé«˜ | vm_network_latency_summary.py | vm_network_latency_details.py | OVS/vhost/virtio ç“¶é¢ˆ |
| ç³»ç»Ÿç½‘ç»œæ…¢ | system_network_latency_summary.py | system_network_latency_details.py | é˜Ÿåˆ—/CPU/conntrack |
| OVS æ…¢ | ovs_upcall_latency_summary.py | ovs_userspace_megaflow.py | Upcall å»¶è¿Ÿ/æµè¡¨æœªå‘½ä¸­ |
| ä¸¢åŒ… | kernel_drop_stack_stats_summary.py | eth_drop.py | ç¼“å†²åŒº/é˜Ÿåˆ—/CPU |
| TUN ä¸¢åŒ… | tun_ring_monitor.py | eth_drop.py (TUN filter) | ç¯å½¢ç¼“å†²åŒºæº¢å‡º |
| vhost æ…¢ | vhost_eventfd_count.py | vhost_queue_correlation_details.py | é˜Ÿåˆ—é¥±å’Œ/CPU ç»‘å®š |
| virtio æ…¢ | virtnet_poll_monitor.py | virtionet-rx-path-monitor.bt | NAPI æ•ˆç‡/ä¸­æ–­èšåˆ |
| KVM ä¸­æ–­æ…¢ | kvm_irqfd_stats_summary.py | - | ä¸­æ–­æ³¨å…¥å»¶è¿Ÿ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**æœ€åæ›´æ–°**: 2025-10-21
**é€‚ç”¨å·¥å…·ç‰ˆæœ¬**: troubleshooting-tools v1.0+

**ç»´æŠ¤è¯´æ˜:**
- æœ¬æ–‡æ¡£åŸºäº openEuler 4.19.90 å†…æ ¸éªŒè¯
- å·¥å…·è¾“å‡ºç¤ºä¾‹åŸºäºçœŸå®ç”Ÿäº§ç¯å¢ƒæ¡ˆä¾‹
- æ€§èƒ½å¼€é”€æ•°æ®åŸºäº 10Gbps ç½‘ç»œç¯å¢ƒæµ‹è¯•
- å¦‚éœ€è¡¥å……æ–°å·¥å…·æˆ–æ¡ˆä¾‹,è¯·å‚è€ƒç°æœ‰ç»“æ„æ·»åŠ 
