# KVM Virtual Network Test Specification Configuration
# File: test/workflow/spec/kvm-virt-network-test-spec.yaml
# Description: Parameter specification for KVM virtual network eBPF testing

metadata:
  name: "KVM Virtual Network Test Specification"
  description: "KVM virtual network eBPF testing parameter specification"
  version: "3.0"

# 环境变量定义
variables:
  kvm-virt-network:
    LOCAL_IP: "172.21.153.114"
    REMOTE_IP: "172.21.153.113"
    QEMU_PID: "688571"
    VNET_DEVICE: "vnet0"

# 测试矩阵定义
test_matrix:
  kvm-virt-network:
    duration: 10
    tools:
      # kvm_irqfd_stats_summary.py - 支持vhost-pid、category和条件subcategory
      - script: "kvm/kvm_irqfd_stats_summary.py"
        template: "sudo python3 {path} {QEMU_PID} --interval 5 --vhost-pid {vhost_pid} --category {category} --subcategory {subcategory}"
        parameters:
          vhost_pid: ["688598", "688599", "688600", "688601"]
          category:
            data:
              subcategory: ["rx", "tx"]
            control: {}

      # vhost_queue_correlation_details.py - 参数化队列和设备
      - script: "vhost-net/vhost_queue_correlation_details.py"
        template: "sudo python3 {path} --device {VNET_DEVICE} --queue {queue} --verbose"
        parameters:
          queue: [0, 1, 2, 3]

      - script: "vhost-net/vhost_queue_correlation_details.py"
        template: "sudo python3 {path} --device {VNET_DEVICE} --verbose"
        # 无队列过滤版本

      # vhost_queue_correlation_simple.py - 参数化队列
      - script: "vhost-net/vhost_queue_correlation_simple.py"
        template: "sudo python3 {path} --device {VNET_DEVICE} --queue {queue}"
        parameters:
          queue: [0, 1, 2, 3]

      - script: "vhost-net/vhost_queue_correlation_simple.py"
        template: "sudo python3 {path} --device {VNET_DEVICE}"
        # 无队列过滤版本

      # tun_ring_monitor.py - 参数化协议，支持方向，仅生成rx方向
      - script: "tun/tun_ring_monitor.py"
        template: "sudo python3 {path} --device {VNET_DEVICE} --src-ip {SRC_IP} --dst-ip {DST_IP} --protocol {protocol} --all"
        directions: ["tx"]
        parameters:
          protocol: ["tcp", "udp", "icmp"]

      # tun_to_vhost_queue_stats_details.py - 参数化协议和队列，支持方向，默认生成所有方向
      - script: "tun/tun_to_vhost_queue_stats_details.py"
        template: "sudo python3 {path} --device {VNET_DEVICE} --src-ip {SRC_IP} --dst-ip {DST_IP} --protocol {protocol} --queue {queue}"
        directions: ["tx"]
        parameters:
          protocol: ["tcp", "udp", "icmp"]
          queue: [0, 1, 2, 3]

      - script: "tun/tun_to_vhost_queue_stats_details.py"
        template: "sudo python3 {path} --device {VNET_DEVICE} --src-ip {SRC_IP} --dst-ip {DST_IP} --protocol {protocol}"
        directions: ["tx"]
        parameters:
          protocol: ["tcp", "udp", "icmp"]

      # tun_to_vhost_queue_status_simple.py - 参数化协议，支持方向，生成rx和tx两个方向
      - script: "tun/tun_to_vhost_queue_status_simple.py"
        template: "sudo python3 {path} --device {VNET_DEVICE} --src-ip {SRC_IP} --dst-ip {DST_IP} --protocol {protocol}"
        directions: ["tx"]
        parameters:
          protocol: ["tcp", "udp", "icmp"]

    directions:
      rx:
        SRC_IP: "{LOCAL_IP}"
        DST_IP: "{REMOTE_IP}"
      tx:
        SRC_IP: "{REMOTE_IP}"
        DST_IP: "{LOCAL_IP}"

defaults:
  duration: 10
  use_sudo: true