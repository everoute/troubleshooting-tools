# KVM Virtual Network Test Specification Configuration
# File: test/workflow/spec/kvm-virt-network-test-spec.yaml
# Description: Parameter specification for KVM virtual network eBPF testing

metadata:
  name: "KVM Virtual Network Test Specification"
  description: "KVM virtual network eBPF testing parameter specification"
  version: "3.0"

# 环境变量定义
variables:
  kvm-virt-network:
    LOCAL_IP: "192.168.77.253"
    REMOTE_IP: "192.168.77.83"
    QEMU_PID: "45194"
    VNET_DEVICE: "vnet246"

# 测试矩阵定义
test_matrix:
  kvm-virt-network:
    duration: 10
    tools:
      # kvm_irqfd_stats_summary.py - 支持vhost-pid、category和条件subcategory
      - dir: "kvm"
        script: "kvm_irqfd_stats_summary.py"
        template: "sudo python2 {path} {QEMU_PID} --interval 5 --vhost-pid {vhost_pid} --category {category} --subcategory {subcategory}"
        parameters:
          vhost_pid: ["45220", "45222", "45223", "45224", "45225", "45226", "45227", "45228"]
          category:
            data:
              subcategory: ["rx", "tx"]

      # kvm_irqfd_stats_summary.py - control category version without vhost-pid
      - dir: "kvm"
        script: "kvm_irqfd_stats_summary.py"
        template: "sudo python2 {path} {QEMU_PID} --interval 5 --category control"

      # vhost_queue_correlation_details.py - 参数化队列和设备
      - dir: "vhost-net"
        script: "vhost_queue_correlation_details.py"
        template: "sudo python2 {path} --device {VNET_DEVICE} --queue {queue} --verbose"
        parameters:
          queue: [0, 1, 2, 3, 4, 5, 6, 7]

      - dir: "vhost-net"
        script: "vhost_queue_correlation_details.py"
        template: "sudo python2 {path} --device {VNET_DEVICE} --verbose"
        # 无队列过滤版本

      # vhost_queue_correlation_simple.py - 参数化队列
      - dir: "vhost-net"
        script: "vhost_queue_correlation_simple.py"
        template: "sudo python2 {path} --device {VNET_DEVICE} --queue {queue}"
        parameters:
          queue: [0, 1, 2, 3, 4, 5, 6, 7]

      - dir: "vhost-net"
        script: "vhost_queue_correlation_simple.py"
        template: "sudo python2 {path} --device {VNET_DEVICE}"
        # 无队列过滤版本

      # tun_ring_monitor.py - 参数化协议，支持方向，仅生成tx方向
      - dir: "tun"
        script: "tun_ring_monitor.py"
        template: "sudo python2 {path} --device {VNET_DEVICE} --protocol {protocol} --all"
        directions: ["tx"]
        parameters:
          protocol: ["tcp", "udp", "icmp"]

      # tun_to_vhost_queue_stats_details.py - 参数化队列，支持方向，默认生成所有方向
      - dir: "tun"
        script: "tun_to_vhost_queue_stats_details.py"
        template: "sudo python2 {path} --device {VNET_DEVICE} --queue {queue}"
        directions: ["tx"]
        parameters:
          queue: [0, 1, 2, 3, 4, 5, 6, 7]

      - dir: "tun"
        script: "tun_to_vhost_queue_stats_details.py"
        template: "sudo python2 {path} --device {VNET_DEVICE}"
        directions: ["tx"]

      # tun_to_vhost_queue_status_simple.py - 参数化队列，支持方向
      - dir: "tun"
        script: "tun_to_vhost_queue_status_simple.py"
        template: "sudo python2 {path} --device {VNET_DEVICE} --queue {queue}"
        directions: ["tx"]
        parameters:
          queue: [0, 1, 2, 3, 4, 5, 6, 7]

      # tun_to_vhost_queue_status_simple.py - 无队列过滤版本
      - dir: "tun"
        script: "tun_to_vhost_queue_status_simple.py"
        template: "sudo python2 {path} --device {VNET_DEVICE}"
        directions: ["tx"]


defaults:
  duration: 10
  use_sudo: true