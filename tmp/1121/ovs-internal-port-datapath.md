# OVS Internal Port 跨节点单流通信数据路径

## 网络拓扑

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                           物理网络                                                       │
│                                                                                                         │
│    ┌─────────────────────────────────────┐              ┌─────────────────────────────────────┐         │
│    │           节点 A (发送端)            │              │           节点 B (接收端)            │         │
│    │                                     │              │                                     │         │
│    │  ┌─────────────────────────────┐   │              │   ┌─────────────────────────────┐  │         │
│    │  │        应用层 (iperf3)       │   │              │   │        应用层 (iperf3)       │  │         │
│    │  │       write()/send()        │   │              │   │       read()/recv()         │  │         │
│    │  └──────────────┬──────────────┘   │              │   └──────────────▲──────────────┘  │         │
│    │                 │                   │              │                  │                 │         │
│    │  ┌──────────────▼──────────────┐   │              │   ┌──────────────┴──────────────┐  │         │
│    │  │      TCP/IP 协议栈           │   │              │   │      TCP/IP 协议栈           │  │         │
│    │  │  - TCP 分段/拥塞控制         │   │              │   │  - TCP 重组/ACK             │  │         │
│    │  │  - IP 路由查找               │   │              │   │  - IP 校验                  │  │         │
│    │  └──────────────┬──────────────┘   │              │   └──────────────▲──────────────┘  │         │
│    │                 │                   │              │                  │                 │         │
│    │  ┌──────────────▼──────────────┐   │              │   ┌──────────────┴──────────────┐  │         │
│    │  │    OVS Internal Port        │   │              │   │    OVS Internal Port        │  │         │
│    │  │    (br-int / br0)           │   │              │   │    (br-int / br0)           │  │         │
│    │  │    IP: 1.1.1.3              │   │              │   │    IP: 1.1.1.2              │  │         │
│    │  │    noqueue (无队列规则)      │   │              │   │    noqueue (无队列规则)      │  │         │
│    │  └──────────────┬──────────────┘   │              │   └──────────────▲──────────────┘  │         │
│    │                 │                   │              │                  │                 │         │
│    │  ┌──────────────▼──────────────┐   │              │   ┌──────────────┴──────────────┐  │         │
│    │  │      OVS 内核模块            │   │              │   │      OVS 内核模块            │  │         │
│    │  │  - Megaflow 匹配            │   │              │   │  - Megaflow 匹配            │  │         │
│    │  │  - 流表转发                  │   │              │   │  - 流表转发                  │  │         │
│    │  └──────────────┬──────────────┘   │              │   └──────────────▲──────────────┘  │         │
│    │                 │                   │              │                  │                 │         │
│    │  ┌──────────────▼──────────────┐   │              │   ┌──────────────┴──────────────┐  │         │
│    │  │      物理网卡 (eth0)         │   │              │   │      物理网卡 (eth0)         │  │         │
│    │  │  - 单队列绑定单 CPU          │   │              │   │  - 单队列绑定单 CPU          │  │         │
│    │  │  - TSO/GSO 分段             │   │              │   │  - GRO 聚合                 │  │         │
│    │  │  - TX Ring Buffer           │   │              │   │  - RX Ring Buffer           │  │         │
│    │  └──────────────┬──────────────┘   │              │   └──────────────▲──────────────┘  │         │
│    │                 │                   │              │                  │                 │         │
│    └─────────────────┼───────────────────┘              └──────────────────┼─────────────────┘         │
│                      │                                                     │                           │
│                      └──────────────────► 物理链路 25G ◄───────────────────┘                           │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## 发送路径详细流程 (节点 A → 节点 B)

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              发送端 (节点 A) 数据路径                                     │
└─────────────────────────────────────────────────────────────────────────────────────────┘

  应用层
    │
    │ write()/send()
    ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ Socket Layer                                                                            │
│                                                                                         │
│   sk_wmem_queued (w)  ─────► 写队列总内存                                                │
│   notsent             ─────► 等待发送的数据 (write_seq - snd_nxt)                        │
│   in_flight           ─────► 已发送待确认 (snd_nxt - snd_una)                            │
│                                                                                         │
│   ★ 瓶颈点: notsent 堆积 (97% send_q)                                                   │
└───────────────────────────────────────┬─────────────────────────────────────────────────┘
                                        │
                                        │ tcp_write_xmit()
                                        │   - tcp_pacing_check()     ← Pacing 限速 (85%)
                                        │   - tcp_cwnd_test()        ← CWND 检查
                                        │   - tcp_small_queue_check() ← TSQ 限制
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ TCP/IP Stack                                                                            │
│                                                                                         │
│   packets_out (unacked) ─────► 已发送未确认的包数                                        │
│   sk_wmem_alloc (t)     ─────► 已交给协议栈的 skb 内存                                   │
│   pacing_rate           ─────► 发送速率限制                                              │
│                                                                                         │
└───────────────────────────────────────┬─────────────────────────────────────────────────┘
                                        │
                                        │ dev_queue_xmit()
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ OVS Internal Port (br-int)                                                              │
│                                                                                         │
│   qdisc: noqueue        ─────► 无队列规则，直接传递                                      │
│   无缓冲                 ─────► 不排队，立即处理                                          │
│                                                                                         │
└───────────────────────────────────────┬─────────────────────────────────────────────────┘
                                        │
                                        │ ovs_vport_send()
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ OVS Datapath (内核模块)                                                                  │
│                                                                                         │
│   1. Megaflow 查找      ─────► 快速路径匹配                                              │
│   2. 执行 actions       ─────► output:eth0                                              │
│   3. 无 upcall          ─────► 流表命中，不上送用户态                                    │
│                                                                                         │
└───────────────────────────────────────┬─────────────────────────────────────────────────┘
                                        │
                                        │ dev_queue_xmit() → eth0
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 物理网卡 (eth0) - TX                                                                    │
│                                                                                         │
│   qdisc: fq/pfifo_fast  ─────► 队列规则                                                 │
│   TSO/GSO               ─────► 大包分段卸载                                              │
│   TX Ring Buffer        ─────► 发送环形缓冲区                                            │
│   单队列                 ─────► 绑定到单个 CPU                                           │
│                                                                                         │
│   ★ 可能瓶颈: TX 队列/TSO 处理                                                          │
└───────────────────────────────────────┬─────────────────────────────────────────────────┘
                                        │
                                        │ 物理发送
                                        ▼
                              ═══════════════════════
                                   物理链路 25G
                              ═══════════════════════
```

## 接收路径详细流程 (节点 B)

```
                              ═══════════════════════
                                   物理链路 25G
                              ═══════════════════════
                                        │
                                        │ 物理接收
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 物理网卡 (eth0) - RX                                                                    │
│                                                                                         │
│   RX Ring Buffer        ─────► 接收环形缓冲区                                            │
│   RX Queue N            ─────► 特定接收队列                                              │
│   GRO                   ─────► 大包聚合                                                 │
│   硬中断                 ─────► IRQ → CPU X (队列绑定)                                   │
│                                                                                         │
│   ★ 特点: 无 RPS，同一流始终在同一 CPU 处理                                              │
└───────────────────────────────────────┬─────────────────────────────────────────────────┘
                                        │
                                        │ NAPI poll (softirq)
                                        │ CPU X 上执行
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ OVS Datapath (内核模块)                                                                  │
│                                                                                         │
│   1. ovs_vport_receive() ────► 从 eth0 收包                                             │
│   2. Megaflow 查找       ────► 快速路径匹配                                              │
│   3. 执行 actions        ────► output:br-int                                            │
│                                                                                         │
└───────────────────────────────────────┬─────────────────────────────────────────────────┘
                                        │
                                        │ ovs_vport_send() → internal port
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ OVS Internal Port (br-int)                                                              │
│                                                                                         │
│   接收到包              ─────► netif_rx() / netif_receive_skb()                         │
│   qdisc: noqueue        ─────► 无入队操作                                                │
│                                                                                         │
└───────────────────────────────────────┬─────────────────────────────────────────────────┘
                                        │
                                        │ ip_rcv() → tcp_v4_rcv()
                                        │ 仍在 CPU X 上执行 (无 RPS)
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ TCP/IP Stack                                                                            │
│                                                                                         │
│   tcp_v4_rcv()          ─────► TCP 接收处理                                              │
│   tcp_rcv_established() ─────► 已建立连接的包处理                                        │
│   sk_rmem_alloc (r)     ─────► 接收队列已分配内存                                        │
│   RWND 更新             ─────► 通告窗口调整                                              │
│                                                                                         │
└───────────────────────────────────────┬─────────────────────────────────────────────────┘
                                        │
                                        │ sk_data_ready() → 唤醒应用
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ Socket Layer                                                                            │
│                                                                                         │
│   sk_receive_queue      ─────► 接收队列                                                 │
│   sk_rmem_alloc         ─────► 接收队列内存                                              │
│   sk_rcvbuf             ─────► 接收缓冲区上限                                            │
│                                                                                         │
└───────────────────────────────────────┬─────────────────────────────────────────────────┘
                                        │
                                        │ read()/recv()
                                        ▼
                                     应用层
```

## 关键特点总结

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              OVS Internal Port 单流特点                                  │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  1. Internal Port 特性                                                                  │
│     ├─ IP 地址配置在 OVS bridge 的 internal port 上                                     │
│     ├─ qdisc 为 noqueue (无队列规则)                                                    │
│     └─ 数据直接在内核态 OVS datapath 转发                                               │
│                                                                                         │
│  2. 单队列/单 CPU 处理                                                                  │
│     ├─ 物理网卡每个 RX 队列绑定一个 CPU                                                 │
│     ├─ 无 RPS (Receive Packet Steering)                                                 │
│     ├─ 同一个流的所有包在同一 CPU 处理                                                  │
│     └─ 不进入中断慢速路径 (ksoftirqd 负载低)                                            │
│                                                                                         │
│  3. 数据路径                                                                            │
│     ├─ TX: Socket → TCP → Internal Port → OVS Datapath → eth0 → 物理链路               │
│     └─ RX: 物理链路 → eth0 → OVS Datapath → Internal Port → TCP → Socket               │
│                                                                                         │
│  4. 已排除的瓶颈                                                                        │
│     ├─ CPU softirq 不高                                                                │
│     ├─ 硬中断 CPU 不高                                                                 │
│     ├─ ksoftirqd 负载低                                                                │
│     └─ 单流多流表现一致                                                                │
│                                                                                         │
│  5. 观察到的现象                                                                        │
│     ├─ notsent 堆积严重 (97% send_q)                                                   │
│     ├─ Pacing Limited 85-90%                                                           │
│     ├─ delivery_rate ~15 Gbps (目标 25 Gbps)                                           │
│     └─ 直接配 IP 到物理网卡也打不上去                                                   │
│                                                                                         │
│  6. 待排查方向                                                                          │
│     ├─ TCP Pacing / BBR 带宽估计                                                       │
│     ├─ 物理网卡 TX 侧 (ring buffer, TSO)                                               │
│     └─ 物理链路 / 交换机配置                                                           │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## CPU 处理流程 (单流场景)

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              单流 CPU 处理示意                                           │
└─────────────────────────────────────────────────────────────────────────────────────────┘

  发送端 (节点 A):
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  CPU Y (应用进程)                                                                    │
  │    │                                                                                │
  │    │ write() 系统调用                                                               │
  │    ▼                                                                                │
  │  ┌─────────────────────────────────────────────────────────────────────────────┐   │
  │  │ tcp_sendmsg() → tcp_write_xmit() → OVS → eth0 TX                            │   │
  │  │ (全部在同一 CPU 上下文执行)                                                   │   │
  │  └─────────────────────────────────────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────────────────────────────────────┘

  接收端 (节点 B):
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  CPU X (RX 队列绑定)                                                                │
  │    │                                                                                │
  │    │ 硬中断 → NAPI poll                                                             │
  │    ▼                                                                                │
  │  ┌─────────────────────────────────────────────────────────────────────────────┐   │
  │  │ eth0 RX → OVS datapath → internal port → tcp_v4_rcv()                       │   │
  │  │ (全部在 CPU X 的 softirq 上下文执行，无 RPS 分散)                             │   │
  │  └─────────────────────────────────────────────────────────────────────────────┘   │
  │    │                                                                                │
  │    │ sk_data_ready() 唤醒                                                          │
  │    ▼                                                                                │
  │  CPU Z (应用进程)                                                                    │
  │  ┌─────────────────────────────────────────────────────────────────────────────┐   │
  │  │ read()/recv() 从 socket 读取数据                                             │   │
  │  └─────────────────────────────────────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```
