# 四连接TCP流量分析报告

## 概述

- **测试场景**: 客户端 100.100.103.205 到服务器 100.100.103.201:5001 的四个并发 TCP 连接
- **网卡配置**: 单网卡
- **抓包时间**: 约 1.8 秒（客户端视角）/ 2.9 秒（服务器视角）
- **连接端口**: 48266, 48264, 48270, 48268

## 客户端视角分析

### 连接性能对比

| 端口 | 吞吐量 | 总字节 | 重传次数 | 快速重传 | DupACK | 乱序包 |
|------|--------|--------|---------|---------|--------|--------|
| 48266 | 0.94 Gbps | 213 MB | 1,312 | 8 | 4,298 | 23 |
| 48264 | 0.86 Gbps | 195 MB | 1,074 | 9 | 4,067 | 0 |
| 48270 | **1.02 Gbps** | **232 MB** | **1,374** | 6 | 3,696 | 0 |
| 48268 | 0.94 Gbps | 214 MB | 1,141 | 2 | 3,785 | 32 |

**客户端关键发现**：
- ✅ **无零窗口**: 所有连接都没有出现零窗口，说明客户端接收能力正常
- ⚠️ **高重传率**: 所有连接都有大量重传（1,074 - 1,374 次）
- ⚠️ **大量 DupACK**: 每个连接有 3,696 - 4,298 个重复 ACK
- ⚠️ **乱序现象**: 48266 和 48268 出现乱序包（23 和 32 个）
- ✅ **无虚假重传**: 所有连接的虚假重传都为 0

## 服务器视角分析

### 连接性能对比

| 端口 | 吞吐量 | 总字节 | 重传次数 | 快速重传 | DupACK | 乱序包 | 零窗口 |
|------|--------|--------|---------|---------|--------|--------|--------|
| 48266 | 0.60 Gbps | 217 MB | **2,317** | 538 | 2,564 | 18 | **2** |
| 48264 | 0.59 Gbps | 214 MB | **3,580** | **1,220** | **4,102** | 32 | 0 |
| 48270 | 0.57 Gbps | 207 MB | 2,358 | 597 | 2,605 | 19 | 0 |
| 48268 | 0.59 Gbps | 214 MB | 2,816 | 865 | 3,218 | 40 | 0 |

**服务器关键发现**：
- 🔴 **重传次数远高于客户端**: 服务器端重传 2,317 - 3,580 次 vs 客户端 1,074 - 1,374 次
- 🔴 **大量快速重传**: 服务器端每个连接有 538 - 1,220 次快速重传（客户端仅 2-9 次）
- 🔴 **吞吐量更低**: 服务器端吞吐量 0.57-0.60 Gbps（客户端 0.86-1.02 Gbps）
- ⚠️ **48266 出现零窗口**: 2 次零窗口事件
- 🔴 **抓包时长差异**: 服务器端抓包时长 2.87 秒 vs 客户端 1.81 秒（多了 1 秒）

## 客户端 vs 服务器对比

### 重传对比（客户端 → 服务器）

| 端口 | 客户端重传 | 服务器端重传 | 差异倍数 |
|------|-----------|-------------|---------|
| 48266 | 1,312 | 2,317 | **1.8x** |
| 48264 | 1,074 | 3,580 | **3.3x** |
| 48270 | 1,374 | 2,358 | **1.7x** |
| 48268 | 1,141 | 2,816 | **2.5x** |

### 快速重传对比

| 端口 | 客户端快速重传 | 服务器端快速重传 | 差异 |
|------|---------------|----------------|------|
| 48266 | 8 | 538 | **67x** |
| 48264 | 9 | 1,220 | **135x** |
| 48270 | 6 | 597 | **99x** |
| 48268 | 2 | 865 | **432x** |

## 问题分析

### 1. 服务器端重传异常高

**现象**:
- 服务器端重传次数是客户端的 1.7 - 3.3 倍
- 服务器端快速重传次数是客户端的 67 - 432 倍

**可能原因**:
1. **网络路径不对称**: 服务器→客户端方向丢包率远高于反向
2. **接收端（客户端）处理能力不足**:
   - 大量 DupACK 表明客户端看到乱序/丢包后立即发送重复确认
   - 但客户端自身重传很少，说明发送方向正常
3. **中间网络设备问题**:
   - 可能存在单向丢包的交换机或路由器
   - Bond 或负载均衡导致的乱序

### 2. 快速重传机制频繁触发

**快速重传的触发条件**: 收到 3 个 DupACK

**服务器端分析**:
- 48264 连接最严重：1,220 次快速重传，4,102 个 DupACK
- 平均每 3-4 个 DupACK 触发一次快速重传
- 说明客户端持续检测到乱序/丢包

**建议检查**:
1. 客户端网卡 RX ring buffer 大小
2. 客户端 CPU 是否被其他进程占用
3. 网络路径上是否有流量整形/QoS 策略

### 3. 时间差异

**现象**: 服务器端抓包时长 2.87 秒 vs 客户端 1.81 秒

**可能原因**:
1. 连接关闭过程在服务器端更长（FIN/ACK 延迟）
2. 服务器端有额外的尾包处理
3. 时钟不同步（但差异达 1 秒有点大）

### 4. 零窗口事件

**48266 连接在服务器端出现 2 次零窗口**:
- 说明服务器端接收缓冲区短暂耗尽
- 可能与该连接的高重传（2,317 次）有关
- 重传导致接收队列堆积

## 单网卡性能分析

### 总吞吐量

**客户端视角**:
- 总吞吐量: 0.94 + 0.86 + 1.02 + 0.94 = **3.76 Gbps**
- 单连接平均: **0.94 Gbps**

**服务器视角**:
- 总吞吐量: 0.60 + 0.59 + 0.57 + 0.59 = **2.35 Gbps**
- 单连接平均: **0.59 Gbps**

### 性能瓶颈

1. **四连接无法充分利用带宽**: 即使是客户端视角的 3.76 Gbps，也远未达到 10G 网卡的能力
2. **重传严重影响吞吐**: 服务器端平均每个连接约 2,800 次重传
3. **单网卡可能不是瓶颈**: 问题更可能在网络路径或接收端处理

## 建议

### 立即检查项

1. ✅ **检查网络拓扑**:
   ```bash
   # 确认路径
   traceroute -n 100.100.103.201
   mtr -n -c 100 100.100.103.201
   ```

2. ✅ **检查客户端网卡状态**:
   ```bash
   # 查看丢包统计
   ip -s link show
   ethtool -S <interface>

   # 检查 RX ring buffer
   ethtool -g <interface>
   ```

3. ✅ **检查 CPU 和中断**:
   ```bash
   # CPU 使用率
   mpstat -P ALL 1

   # 网卡中断分布
   cat /proc/interrupts | grep <interface>
   ```

4. ✅ **检查内核参数**:
   ```bash
   # TCP 缓冲区大小
   sysctl net.ipv4.tcp_rmem
   sysctl net.ipv4.tcp_wmem

   # 接收队列大小
   sysctl net.core.netdev_max_backlog
   ```

### 优化建议

1. **增加接收缓冲区**:
   ```bash
   sysctl -w net.core.rmem_max=16777216
   sysctl -w net.ipv4.tcp_rmem="4096 87380 16777216"
   ```

2. **启用 TCP 时间戳和 SACK**（已启用，保持）:
   ```bash
   sysctl net.ipv4.tcp_timestamps
   sysctl net.ipv4.tcp_sack
   ```

3. **如果是 Bond 问题，考虑**:
   - 使用 layer3+4 或 layer2+3 哈希模式
   - 检查 Bond 成员链路是否都正常

### 进一步分析

1. **提取特定连接的详细 RTT 数据**:
   ```bash
   tshark -r client1112 -Y "tcp.stream eq 0" -T fields \
     -e frame.time_relative -e tcp.analysis.ack_rtt \
     > stream0_rtt.txt
   ```

2. **分析重传模式**:
   ```bash
   # 查看重传是集中爆发还是均匀分布
   tshark -r server1112 -Y "tcp.analysis.retransmission" \
     -T fields -e frame.time_relative -e tcp.srcport \
     > retrans_timeline.txt
   ```

3. **使用 TCP 流分析工具**:
   ```bash
   tcptrace -l server1112
   ```

## 结论

1. 🔴 **主要问题**: 服务器→客户端方向存在严重的丢包/乱序问题
2. 🔴 **重传率高**: 服务器端重传次数异常（2,300-3,600 次/连接）
3. ⚠️ **快速重传频繁**: 表明客户端持续检测到乱序
4. ⚠️ **单网卡性能未充分利用**: 总吞吐仅 2-4 Gbps（理论可达 10 Gbps）
5. ✅ **客户端发送正常**: 客户端→服务器方向重传很少

**下一步**: 重点检查客户端接收能力和网络路径质量。
